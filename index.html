<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0ea5e9">
    <title>KPIT ICEMAN</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 50%, #7dd3fc 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; color: #0c4a6e; margin-bottom: 30px; position: relative; padding-top: 40px; }
        .update-btn {
            position: absolute;
            top: 0;
            left: 0;
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }
        .update-btn:hover {
            background: #0284c7;
        }
        .page { display: none; }
        .page.active { display: block; }
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .menu-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            border: 2px solid rgba(186, 230, 253, 0.5);
            text-align: center;
            transition: all 0.2s;
        }
        .menu-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
        }
        .menu-card h3 { color: #0369a1; margin-bottom: 0; font-size: 16px; }
        .back-button {
            background: rgba(255, 255, 255, 0.7);
            color: #0369a1;
            border: 2px solid rgba(186, 230, 253, 0.5);
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        .back-button:hover {
            background: rgba(255, 255, 255, 0.9);
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 24px;
        }
        input, textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 16px;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #0ea5e9;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            background: #f0f9ff;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .result-value { font-weight: 700; color: #0369a1; }
        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th, td { padding: 6px; border: 1px solid #e5e7eb; text-align: left; }
        th { background: #0ea5e9; color: white; border-color: #7dd3fc; }
        .version-badge {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            color: #6b7280;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
        }
        .pdf-link {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            background: #f0f9ff;
            border-radius: 10px;
            margin-bottom: 10px;
            text-decoration: none;
            color: #0369a1;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .pdf-link:hover {
            background: #e0f2fe;
            border-color: #0ea5e9;
        }
        .pdf-icon {
            font-size: 24px;
            margin-right: 12px;
        }
        .pdf-info {
            flex: 1;
        }
        .pdf-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
        }
        .pdf-desc {
            font-size: 12px;
            color: #6b7280;
        }
        .pdf-missing {
            padding: 20px;
            text-align: center;
            color: #9ca3af;
            font-size: 14px;
        }
        .iframe-container {
            width: 100%;
            height: 80vh;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            overflow: auto;
            background: white;
        }
        .iframe-container iframe {
            width: 250%;
            height: 250%;
            border: none;
            transform: scale(0.4);
            transform-origin: top left;
        }
        .info-box {
            background: #f0f9ff;
            border-left: 4px solid #0ea5e9;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .info-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .info-value {
            font-size: 24px;
            font-weight: 700;
            color: #0369a1;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }
        .refresh-btn {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
        }
        .refresh-btn:hover {
            background: #0284c7;
        }
        .metar-box {
            background: white;
            padding: 16px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            margin-top: 16px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            word-wrap: break-word;
        }
        .external-link-btn {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.2s;
        }
        .external-link-btn:hover {
            background: #059669;
        }
    </style>
</head>
<body>
    <div class="version-badge">v1.3.0</div>
    <div class="container">
        <div class="header">
            <button class="update-btn" onclick="updateApp()" aria-label="Update application">üîÑ Update</button>
            <h1>KPIT ICEMAN</h1>
        </div>
        
        <div class="page active" id="menu">
            <div class="menu-grid">
                <div class="menu-card" onclick="showPage('increase')" role="button" tabindex="0" aria-label="Increase Mix Calculator"><h3>Increase Mix</h3></div>
                <div class="menu-card" onclick="showPage('decrease')" role="button" tabindex="0" aria-label="Decrease Mix Calculator"><h3>Decrease Mix</h3></div>
                <div class="menu-card" onclick="showPage('volume')" role="button" tabindex="0" aria-label="Increase Volume Calculator"><h3>Increase Volume</h3></div>
                <div class="menu-card" onclick="showPage('tote')" role="button" tabindex="0" aria-label="Tote to Truck Calculator"><h3>Tote to Truck</h3></div>
                <div class="menu-card" onclick="showPage('truckboard')" role="button" tabindex="0" aria-label="View Truck Board"><h3>üöõ Truck Board</h3></div>
                <div class="menu-card" onclick="showPage('truckboard-edit')" role="button" tabindex="0" aria-label="Edit Truck Board"><h3>‚úèÔ∏è Edit Truck Board</h3></div>
                <div class="menu-card" onclick="showPage('atis')" role="button" tabindex="0" aria-label="ATIS and Weather"><h3>üì° ATIS & Weather</h3></div>
                <div class="menu-card" onclick="showPage('history')" role="button" tabindex="0" aria-label="View calculation history"><h3>üìã History</h3></div>
                <div class="menu-card" onclick="showPage('dilution')" role="button" tabindex="0" aria-label="View dilution chart"><h3>üìä Dilution Chart</h3></div>
                <div class="menu-card" onclick="showPage('aircraft')" role="button" tabindex="0" aria-label="Aircraft reference guide"><h3>‚úàÔ∏è Aircraft Reference</h3></div>
                <div class="menu-card" onclick="showPage('airlines')" role="button" tabindex="0" aria-label="Airline codes reference"><h3>üõ´ Airline Codes</h3></div>
                <div class="menu-card" onclick="showPage('pdfs')" role="button" tabindex="0" aria-label="Documents and links"><h3>üìÑ Documents & Links</h3></div>
                <div class="menu-card" onclick="showPage('notes')" role="button" tabindex="0" aria-label="Field notes"><h3>üìù Notes</h3></div>
            </div>
        </div>

        <div class="page" id="increase">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <h2>Increase Mix</h2>
                <input type="number" inputmode="decimal" id="inc-cur" placeholder="Current Mix %" oninput="calcInc()" aria-label="Current mix percentage" min="0" max="100">
                <input type="number" inputmode="decimal" id="inc-des" placeholder="Desired Mix %" oninput="calcInc()" aria-label="Desired mix percentage" min="0" max="100">
                <input type="number" inputmode="decimal" id="inc-vol" placeholder="Current Volume" oninput="calcInc()" aria-label="Current volume in gallons" min="0">
                <div id="inc-result"></div>
            </div>
        </div>

        <div class="page" id="decrease">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <h2>Decrease Mix</h2>
                <input type="number" inputmode="decimal" id="dec-cur" placeholder="Current Mix %" oninput="calcDec()" aria-label="Current mix percentage" min="0" max="100">
                <input type="number" inputmode="decimal" id="dec-des" placeholder="Desired Mix %" oninput="calcDec()" aria-label="Desired mix percentage" min="0" max="100">
                <input type="number" inputmode="decimal" id="dec-vol" placeholder="Current Volume" oninput="calcDec()" aria-label="Current volume in gallons" min="0">
                <div id="dec-result"></div>
            </div>
        </div>

        <div class="page" id="volume">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <h2>Increase Volume</h2>
                
                <div style="background: #f0f9ff; border-left: 4px solid #0ea5e9; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 13px;">
                    <strong>Current Mix:</strong> Enter either percentage OR freeze point
                </div>
                
                <input type="number" inputmode="decimal" id="vol-cur" placeholder="Current Mix %" oninput="handleVolCurInput()" aria-label="Current mix percentage" min="0" max="100">
                <input type="number" id="vol-cur-freeze" placeholder="OR Current Freeze Point (¬∞C)" oninput="handleVolCurFreezeInput()" aria-label="Current freeze point in Celsius" max="0">
                
                <input type="number" inputmode="decimal" id="vol-curv" placeholder="Current Volume" oninput="calcVol()" aria-label="Current volume in gallons" min="0">
                
                <div style="background: #f0f9ff; border-left: 4px solid #0ea5e9; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 13px;">
                    <strong>Wanted Mix:</strong> Enter either percentage OR freeze point
                </div>
                
                <input type="number" inputmode="decimal" id="vol-want" placeholder="Wanted Mix %" oninput="handleVolWantInput()" aria-label="Wanted mix percentage" min="0" max="100">
                <input type="number" id="vol-want-freeze" placeholder="OR Wanted Freeze Point (¬∞C)" oninput="handleVolWantFreezeInput()" aria-label="Wanted freeze point in Celsius" max="0">
                
                <input type="number" inputmode="decimal" id="vol-wantv" placeholder="Wanted Volume" oninput="calcVol()" aria-label="Wanted volume in gallons" min="0">
                
                <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px;">
                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 14px;">
                        <input type="checkbox" id="vol-pumpout" onchange="handlePumpOutChange()" style="width: auto; margin-right: 8px;">
                        <span>Calculate pump-out (water or glycol only)</span>
                    </label>
                </div>
                
                <div id="vol-result"></div>
            </div>
        </div>

        <div class="page" id="tote">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <h2>Tote to Truck</h2>
                <input type="number" inputmode="decimal" id="tote-tm" placeholder="Truck Mix %" oninput="calcTote()" aria-label="Truck mix percentage" min="0" max="100">
                <input type="number" inputmode="decimal" id="tote-tv" placeholder="Truck Volume" oninput="calcTote()" aria-label="Truck volume in gallons" min="0">
                <input type="number" inputmode="decimal" id="tote-ttm" placeholder="Tote Mix %" oninput="calcTote()" aria-label="Tote mix percentage" min="0" max="100">
                <input type="number" inputmode="decimal" id="tote-ttv" placeholder="Tote Volume" oninput="calcTote()" aria-label="Tote volume in gallons" min="0">
                <div id="tote-result"></div>
            </div>
        </div>

        <div class="page" id="truckboard">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu" style="margin-bottom: 10px;">‚Üê Back</button>
            <div class="card" style="padding: 12px;">
                <h2 style="margin-bottom: 8px;">Truck Board</h2>
                <div class="iframe-container" style="height: 85vh;">
                    <iframe src="https://script.google.com/macros/s/AKfycbwLAeS6nUomVV8IwKqNZ76DwpRq1JFGHsG010-Z51blqkWmebGVAs8bm7B-MzlbPKkhbA/exec?page=display" title="Truck Board Display"></iframe>
                </div>
                <a href="https://script.google.com/macros/s/AKfycbwLAeS6nUomVV8IwKqNZ76DwpRq1JFGHsG010-Z51blqkWmebGVAs8bm7B-MzlbPKkhbA/exec?page=display" target="_blank" class="external-link-btn" style="margin-top: 8px;">Open in New Tab</a>
            </div>
        </div>

        <div class="page" id="truckboard-edit">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <h2>Edit Truck Board</h2>
                <div class="iframe-container">
                    <iframe src="https://tb.kpiticeman.com/" title="Truck Board Editor"></iframe>
                </div>
                <a href="https://tb.kpiticeman.com/" target="_blank" class="external-link-btn">Open in New Tab</a>
            </div>
        </div>

        <div class="page" id="atis">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <h2>ATIS & Weather</h2>
                <button class="refresh-btn" onclick="loadATIS()">üîÑ Refresh Data</button>
                
                    <div class="info-box">
                        <div class="info-label">Temperature (KPIT)</div>
                        <div class="info-value" id="temperature">Loading...</div>
                    </div>
                    
                    <div class="info-box">
                        <div class="info-label">Dew Point (KPIT)</div>
                        <div class="info-value" id="dewpoint">Loading...</div>
                    </div>
                    
                    <div class="info-box">
                        <div class="info-label">Wind</div>
                        <div class="info-value" id="wind">Loading...</div>
                    </div>
                    
                    <div class="info-box" id="precip-box" style="display: none;">
                        <div class="info-label">Precipitation</div>
                        <div class="info-value" id="precipitation">None</div>
                    </div>
                    
                    <h3 style="margin-top: 20px; margin-bottom: 10px; color: #0369a1;">Full METAR</h3>
                    <div class="metar-box" id="metar-full">Loading...</div>
                    
                    <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">
                        <div style="font-style: italic; margin-bottom: 4px;">
                            METAR observed: <span id="metar-observed">--</span>
                        </div>
                        <div style="font-style: italic;">
                            Last checked: <span id="metar-time">--</span>
                        </div>
                    </div>
                </div>
                
                <a href="https://ids6.pitairport.com/IDS5Status/?recover=dXNlcj1BT1VTRVImcHc9QU9QVw" target="_blank" class="external-link-btn">üì° View Full ATIS Display</a>
                
                <div style="margin-top: 12px;">
                    <p style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">Additional Weather Sources:</p>
                    <a href="https://forecast.weather.gov/MapClick.php?lat=40.49608000000006&lon=-80.25546999999995" target="_blank" class="external-link-btn" style="background: #0ea5e9; margin-bottom: 8px; display: block; text-align: center;">üå§Ô∏è National Weather Service - KPIT</a>
                    <a href="https://www.accuweather.com/en/us/pittsburgh-international-airport/15231/weather-forecast/2630488" target="_blank" class="external-link-btn" style="background: #0ea5e9; margin-bottom: 8px; display: block; text-align: center;">üå°Ô∏è AccuWeather - KPIT</a>      
                </div>
            </div>
        </div>

        <div class="page" id="history">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <h2>History</h2>
                <div id="history-list"></div>
                <button onclick="clearHistory()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; margin-top: 12px; cursor: pointer;" aria-label="Clear all history">Clear All</button>
            </div>
        </div>

        <div class="page" id="dilution">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <h2>Dilution Chart</h2>
                <div style="overflow-x: auto;"><table><thead><tr><th>Dilution</th><th>Refractive Index</th><th>Freeze Point</th><th>LOUT</th></tr></thead><tbody id="dilution-body"></tbody></table></div>
            </div>
        </div>

        <div class="page" id="aircraft">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <h2>Aircraft Reference</h2>
                <div style="overflow-x: auto;"><table><thead><tr><th>Carrier</th><th>Broom</th><th>Hoar</th><th>Type IV</th><th>Specifics</th></tr></thead><tbody id="aircraft-body"></tbody></table></div>
            </div>
        </div>

        <div class="page" id="airlines">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <h2>Airline Codes</h2>
                <div style="overflow-x: auto;"><table><thead><tr><th>Airline</th><th>Parent</th><th>Call Sign</th><th>Code</th></tr></thead><tbody id="airlines-body"></tbody></table></div>
            </div>
        </div>

        <div class="page" id="pdfs">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <h2>Documents & Links</h2>
                <h3 style="color: red;">Under Construction</h3>
               <!-- <div id="pdf-list"></div> -->
            </div>
        </div>

        <div class="page" id="notes">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <h2>Notes</h2>
                <textarea id="notes-area" rows="15" placeholder="Type notes..." oninput="saveNotes()" aria-label="Field notes text area"></textarea>
                <div id="notes-status" style="color: #9ca3af; font-size: 13px;">Auto-saved</div>
            </div>
        </div>
    </div>

    <script>
        function showPage(p) {
            document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
            document.getElementById(p).classList.add('active');
            if(p==='notes')loadNotes();if(p==='history')displayHistory();
            if(p==='dilution')loadDilution();if(p==='aircraft')loadAircraft();if(p==='airlines')loadAirlines();
            if(p==='pdfs')loadPdfs();if(p==='atis')loadATIS();
            
            // Restore saved inputs for this page
            restorePageInputs(p);
        }

        // Save input values to localStorage
        function saveInput(pageId, inputId, value) {
            const key = `input_${pageId}_${inputId}`;
            localStorage.setItem(key, value);
        }

        // Restore all inputs for a page
        function restorePageInputs(pageId) {
            const page = document.getElementById(pageId);
            if (!page) return;
            
            // Restore all text/number inputs
            page.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
                const key = `input_${pageId}_${input.id}`;
                const savedValue = localStorage.getItem(key);
                if (savedValue !== null) {
                    input.value = savedValue;
                }
            });
            
            // Restore checkboxes
            page.querySelectorAll('input[type="checkbox"]').forEach(input => {
                const key = `input_${pageId}_${input.id}`;
                const savedValue = localStorage.getItem(key);
                if (savedValue !== null) {
                    input.checked = savedValue === 'true';
                }
            });
            
            // Trigger calculations after restoring values
            if (pageId === 'increase' && document.getElementById('inc-cur').value) {
                calcInc();
            } else if (pageId === 'decrease' && document.getElementById('dec-cur').value) {
                calcDec();
            } else if (pageId === 'volume' && document.getElementById('vol-cur').value) {
                calcVol();
            } else if (pageId === 'tote' && document.getElementById('tote-tm').value) {
                calcTote();
            }
        }

        // Clear saved inputs for a page (optional - for future use)
        function clearPageInputs(pageId) {
            const page = document.getElementById(pageId);
            if (!page) return;
            
            page.querySelectorAll('input').forEach(input => {
                const key = `input_${pageId}_${input.id}`;
                localStorage.removeItem(key);
            });
        }

        function validateInput(value, name, min = 0, max = null) {
            if (isNaN(value) || value < min) {
                return { valid: false, message: `${name} must be at least ${min}` };
            }
            if (max !== null && value > max) {
                return { valid: false, message: `${name} cannot exceed ${max}` };
            }
            return { valid: true };
        }

        function calcInc() {
            const c=parseFloat(document.getElementById('inc-cur').value);
            const d=parseFloat(document.getElementById('inc-des').value);
            const v=parseFloat(document.getElementById('inc-vol').value);
            const resultDiv = document.getElementById('inc-result');
            
            // Auto-save inputs
            saveInput('increase', 'inc-cur', document.getElementById('inc-cur').value);
            saveInput('increase', 'inc-des', document.getElementById('inc-des').value);
            saveInput('increase', 'inc-vol', document.getElementById('inc-vol').value);
            
            if(!c||!d||!v){resultDiv.innerHTML='';return;}
            
            // Validation
            const validations = [
                validateInput(c, 'Current mix', 0, 100),
                validateInput(d, 'Desired mix', 0, 100),
                validateInput(v, 'Current volume', 0.1)
            ];
            
            for (let validation of validations) {
                if (!validation.valid) {
                    resultDiv.innerHTML = `<div class="error-message">${validation.message}</div>`;
                    return;
                }
            }
            
            if (d <= c) {
                resultDiv.innerHTML = '<div class="error-message">Desired mix must be greater than current mix</div>';
                return;
            }
            
            const g=v*((d-c)/(100-d)),t=v+g;
            resultDiv.innerHTML=
                `<div style="background:#f97316;color:white;padding:12px;border-radius:8px;margin-bottom:8px;font-weight:600;text-align:center;">
                    Type I to Add: ${g.toFixed(2)} gal
                </div>
                <div class="result-item"><span>New Total Volume</span><span class="result-value">${t.toFixed(2)} gal</span></div>`;
            saveToHistory('Inc',{c,d,v,g:g.toFixed(2)});
        }

        function calcDec() {
            const c=parseFloat(document.getElementById('dec-cur').value);
            const d=parseFloat(document.getElementById('dec-des').value);
            const v=parseFloat(document.getElementById('dec-vol').value);
            const resultDiv = document.getElementById('dec-result');
            
            // Auto-save inputs
            saveInput('decrease', 'dec-cur', document.getElementById('dec-cur').value);
            saveInput('decrease', 'dec-des', document.getElementById('dec-des').value);
            saveInput('decrease', 'dec-vol', document.getElementById('dec-vol').value);
            
            if(!c||!d||!v){resultDiv.innerHTML='';return;}
            
            // Validation
            const validations = [
                validateInput(c, 'Current mix', 0, 100),
                validateInput(d, 'Desired mix', 0, 100),
                validateInput(v, 'Current volume', 0.1)
            ];
            
            for (let validation of validations) {
                if (!validation.valid) {
                    resultDiv.innerHTML = `<div class="error-message">${validation.message}</div>`;
                    return;
                }
            }
            
            if (d >= c) {
                resultDiv.innerHTML = '<div class="error-message">Desired mix must be less than current mix</div>';
                return;
            }
            
            if (d === 0) {
                resultDiv.innerHTML = '<div class="error-message">Desired mix cannot be zero</div>';
                return;
            }
            
            const w=v*((c-d)/d),t=v+w;
            resultDiv.innerHTML=
                `<div style="background:#3b82f6;color:white;padding:12px;border-radius:8px;margin-bottom:8px;font-weight:600;text-align:center;">
                    Water to Add: ${w.toFixed(2)} gal
                </div>
                <div class="result-item"><span>New Total Volume</span><span class="result-value">${t.toFixed(2)} gal</span></div>`;
            saveToHistory('Dec',{c,d,v,w:w.toFixed(2)});
        }

        function calcVol() {
            const curMix=parseFloat(document.getElementById('vol-cur').value);
            const curVol=parseFloat(document.getElementById('vol-curv').value);
            const wantMix=parseFloat(document.getElementById('vol-want').value);
            const wantVol=parseFloat(document.getElementById('vol-wantv').value);
            const pumpOutChecked = document.getElementById('vol-pumpout').checked;
            const resultDiv = document.getElementById('vol-result');
            
            // Auto-save all volume inputs
            saveInput('volume', 'vol-curv', document.getElementById('vol-curv').value);
            saveInput('volume', 'vol-wantv', document.getElementById('vol-wantv').value);
            saveInput('volume', 'vol-pumpout', pumpOutChecked);
            
            if(!curMix||!curVol||!wantMix||!wantVol){resultDiv.innerHTML='';return;}
            
            // Validation
            const validations = [
                validateInput(curMix, 'Current mix', 0, 100),
                validateInput(wantMix, 'Wanted mix', 0, 100),
                validateInput(curVol, 'Current volume', 0.1),
                validateInput(wantVol, 'Wanted volume', 0.1)
            ];
            
            for (let validation of validations) {
                if (!validation.valid) {
                    resultDiv.innerHTML = `<div class="error-message">${validation.message}</div>`;
                    return;
                }
            }
            
            let pumpOutAmount = 0;
            let pumpOutMode = null;
            
            // Auto-determine mode based on concentration direction
            if (pumpOutChecked) {
                if (wantMix < curMix) {
                    // Decreasing concentration - use water only
                    pumpOutMode = 'water-only';
                } else if (wantMix > curMix) {
                    // Increasing concentration - use glycol only
                    pumpOutMode = 'glycol-only';
                } else {
                    // Same concentration - not applicable
                    resultDiv.innerHTML = '<div class="error-message">Pump-out not needed when current and wanted mix are the same</div>';
                    return;
                }
                
                pumpOutAmount = calculateAutoPumpOut(curMix, curVol, wantMix, wantVol, pumpOutMode);
                
                if (pumpOutAmount === null || pumpOutAmount <= 0) {
                    resultDiv.innerHTML = `<div class="error-message">Cannot achieve ${pumpOutMode === 'water-only' ? 'water-only' : 'glycol-only'} solution with these parameters. Try without pump-out option.</div>`;
                    return;
                }
            }
            
            // Calculate with pump out if checked
            let effectiveCurVol = curVol;
            let pumpOutHtml = '';
            
            if (pumpOutChecked && pumpOutAmount > 0) {
                if (pumpOutAmount >= curVol) {
                    resultDiv.innerHTML = '<div class="error-message">Calculated pump-out exceeds current volume. Try without pump-out option.</div>';
                    return;
                }
                
                effectiveCurVol = curVol - pumpOutAmount;
                const addType = pumpOutMode === 'water-only' ? 'water' : 'Type I glycol';
                pumpOutHtml = `
                    <div style="background:#ef4444;color:white;padding:12px;border-radius:8px;margin-bottom:8px;font-weight:600;text-align:center;">
                        Step 1: Pump Out ${pumpOutAmount.toFixed(2)} gal
                    </div>
                    <div class="result-item"><span>Volume After Pump Out</span><span class="result-value">${effectiveCurVol.toFixed(2)} gal</span></div>
                    <div style="background: #e0f2fe; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 13px; color: #0369a1; text-align: center;">
                        ‚ÑπÔ∏è Then add ${addType} only
                    </div>
                    <div style="height: 1px; background: #e5e7eb; margin: 16px 0;"></div>`;
            }
            
            if (wantVol <= effectiveCurVol) {
                resultDiv.innerHTML = '<div class="error-message">Wanted volume must be greater than current volume' + (pumpOutChecked ? ' after pump out' : '') + '</div>';
                return;
            }
            
            const cm=curMix/100;
            const wm=wantMix/100;
            
            const d4=cm*effectiveCurVol;
            const d5=wm*wantVol;
            const d6=d5-d4;
            
            const e4=effectiveCurVol-d4;
            const e5=wantVol-d5;
            const e6=e5-e4;
            
            const percentToAdd=(d6/(d6+e6))*100;
            const volumeToAdd=d6+e6;
            const typeIToAdd=d6;
            const waterToAdd=e6;
            
            const stepLabel = pumpOutChecked ? 'Step 2: Add Fluid' : '';
            
            // Verify water-only or glycol-only if pump out was used
            let verificationNote = '';
            if (pumpOutChecked) {
                if (pumpOutMode === 'water-only' && Math.round(typeIToAdd) === 0) {
                    verificationNote = '<div style="background: #d1fae5; color: #065f46; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; text-align: center;">‚úì Water only needed</div>';
                } else if (pumpOutMode === 'glycol-only' && Math.round(waterToAdd) === 0) {
                    verificationNote = '<div style="background: #fed7aa; color: #92400e; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; text-align: center;">‚úì Type I glycol only needed</div>';
                }
            }
            
            resultDiv.innerHTML=
                pumpOutHtml +
                `<div class="result-item"><span>% to Add</span><span class="result-value">${percentToAdd.toFixed(0)}%</span></div>
                <div class="result-item"><span>Volume to Add</span><span class="result-value">${Math.round(volumeToAdd)} gal</span></div>
                ${verificationNote}
                <div style="margin-top:16px;">
                    ${stepLabel ? `<div style="color: #0369a1; font-weight: 600; margin-bottom: 8px;">${stepLabel}</div>` : ''}
                    <div style="background:#3b82f6;color:white;padding:12px;border-radius:8px;margin-bottom:8px;font-weight:600;text-align:center;">
                        Water to Add: ${Math.round(waterToAdd)} gal
                    </div>
                    <div style="background:#f97316;color:white;padding:12px;border-radius:8px;font-weight:600;text-align:center;">
                        Type I to Add: ${Math.round(typeIToAdd)} gal
                    </div>
                </div>`;
            saveToHistory('Vol',{curMix,curVol,wantMix,wantVol,vol:Math.round(volumeToAdd),pct:percentToAdd.toFixed(0),water:Math.round(waterToAdd),typeI:Math.round(typeIToAdd),pumpOut:pumpOutChecked?pumpOutAmount:0});
        }

        // Calculate pump out amount for water-only or glycol-only addition
        function calculateAutoPumpOut(curMix, curVol, wantMix, wantVol, mode) {
            const cm = curMix / 100;
            const wm = wantMix / 100;
            
            if (mode === 'water-only') {
                // For water-only: we need wantMix * wantVol = curMix * (curVol - pumpOut)
                // Solving for pumpOut: pumpOut = curVol - (wantMix * wantVol / curMix)
                
                if (wantMix >= curMix) {
                    return null; // Can't add only water to increase concentration
                }
                
                const pumpOut = curVol - (wm * wantVol / cm);
                
                // Validate the solution
                if (pumpOut < 0 || pumpOut >= curVol) {
                    return null;
                }
                
                return pumpOut;
                
            } else if (mode === 'glycol-only') {
                // For glycol-only: we need wantVol - (curVol - pumpOut) = all glycol
                // And: curMix * (curVol - pumpOut) + 100 * glycolToAdd = wantMix * wantVol
                // Where: glycolToAdd = wantVol - (curVol - pumpOut)
                // Solving: curMix * (curVol - pumpOut) + 100 * (wantVol - curVol + pumpOut) = wantMix * wantVol
                // curMix * curVol - curMix * pumpOut + 100 * wantVol - 100 * curVol + 100 * pumpOut = wantMix * wantVol
                // pumpOut * (100 - curMix) = wantMix * wantVol - curMix * curVol - 100 * wantVol + 100 * curVol
                // pumpOut = (wantMix * wantVol - curMix * curVol - 100 * wantVol + 100 * curVol) / (100 - curMix)
                
                if (wantMix <= curMix) {
                    return null; // Can't add only glycol to decrease concentration
                }
                
                const numerator = (wm * wantVol - cm * curVol - wantVol + curVol) * 100;
                const denominator = 100 - curMix;
                
                if (denominator === 0) {
                    return null;
                }
                
                const pumpOut = numerator / denominator;
                
                // Validate the solution
                if (pumpOut < 0 || pumpOut >= curVol) {
                    return null;
                }
                
                return pumpOut;
            }
            
            return null;
        }

        // Handle pump out checkbox change
        function handlePumpOutChange() {
            calcVol();
        }

        // Freeze point to percentage conversion based on dilution table
        function freezePointToPercentage(freezeC) {
            // Dilution table mapping (freeze point in C to percentage)
            const freezeMap = [
                {freeze: -43, pct: 70},
                {freeze: -41.5, pct: 65},
                {freeze: -40, pct: 60},
                {freeze: -39, pct: 59},
                {freeze: -39, pct: 58},
                {freeze: -38, pct: 57},
                {freeze: -37, pct: 56},
                {freeze: -36, pct: 55},
                {freeze: -34, pct: 54},
                {freeze: -32, pct: 53},
                {freeze: -31, pct: 52},
                {freeze: -29, pct: 51},
                {freeze: -27, pct: 50},
                {freeze: -26, pct: 49},
                {freeze: -25, pct: 48},
                {freeze: -24, pct: 47},
                {freeze: -23, pct: 46},
                {freeze: -22, pct: 45},
                {freeze: -21, pct: 44},
                {freeze: -21, pct: 43},
                {freeze: -19, pct: 42},
                {freeze: -19, pct: 41},
                {freeze: -18, pct: 40},
                {freeze: -17, pct: 39},
                {freeze: -16, pct: 38},
                {freeze: -15, pct: 37},
                {freeze: -14, pct: 36},
                {freeze: -13, pct: 35},
                {freeze: -13, pct: 34},
                {freeze: -13, pct: 33},
                {freeze: -12, pct: 32},
                {freeze: -12, pct: 31},
                {freeze: -11, pct: 30},
                {freeze: -11, pct: 29},
                {freeze: -11, pct: 28},
                {freeze: -11, pct: 27},
                {freeze: -10, pct: 26},
                {freeze: -10, pct: 25},
                {freeze: -9, pct: 24},
                {freeze: -8, pct: 23},
                {freeze: -8, pct: 22},
                {freeze: -7, pct: 21},
                {freeze: -7, pct: 20}
            ];
            
            // Find closest match
            let closest = freezeMap[0];
            let minDiff = Math.abs(freezeC - closest.freeze);
            
            for (let entry of freezeMap) {
                const diff = Math.abs(freezeC - entry.freeze);
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = entry;
                }
            }
            
            return closest.pct;
        }

        // Handle input for current mix percentage
        function handleVolCurInput() {
            saveInput('volume', 'vol-cur', document.getElementById('vol-cur').value);
            calcVol();
        }

        // Handle input for current freeze point
        function handleVolCurFreezeInput() {
            const freezeInput = document.getElementById('vol-cur-freeze');
            saveInput('volume', 'vol-cur-freeze', freezeInput.value);
            
            if (freezeInput.value) {
                const freezeC = parseFloat(freezeInput.value);
                const percentage = freezePointToPercentage(freezeC);
                document.getElementById('vol-cur').value = percentage;
                saveInput('volume', 'vol-cur', percentage);
            }
            calcVol();
        }

        // Handle input for wanted mix percentage
        function handleVolWantInput() {
            saveInput('volume', 'vol-want', document.getElementById('vol-want').value);
            calcVol();
        }

        // Handle input for wanted freeze point
        function handleVolWantFreezeInput() {
            const freezeInput = document.getElementById('vol-want-freeze');
            saveInput('volume', 'vol-want-freeze', freezeInput.value);
            
            if (freezeInput.value) {
                const freezeC = parseFloat(freezeInput.value);
                const percentage = freezePointToPercentage(freezeC);
                document.getElementById('vol-want').value = percentage;
                saveInput('volume', 'vol-want', percentage);
            }
            calcVol();
        }

        function calcTote() {
            const tm=parseFloat(document.getElementById('tote-tm').value)/100;
            const tv=parseFloat(document.getElementById('tote-tv').value);
            const ttm=parseFloat(document.getElementById('tote-ttm').value)/100;
            const ttv=parseFloat(document.getElementById('tote-ttv').value);
            const resultDiv = document.getElementById('tote-result');
            
            // Auto-save inputs
            saveInput('tote', 'tote-tm', document.getElementById('tote-tm').value);
            saveInput('tote', 'tote-tv', document.getElementById('tote-tv').value);
            saveInput('tote', 'tote-ttm', document.getElementById('tote-ttm').value);
            saveInput('tote', 'tote-ttv', document.getElementById('tote-ttv').value);
            
            if(!tm||!tv||!ttm||!ttv){resultDiv.innerHTML='';return;}
            
            // Validation
            const validations = [
                validateInput(tm*100, 'Truck mix', 0, 100),
                validateInput(ttm*100, 'Tote mix', 0, 100),
                validateInput(tv, 'Truck volume', 0.1),
                validateInput(ttv, 'Tote volume', 0.1)
            ];
            
            for (let validation of validations) {
                if (!validation.valid) {
                    resultDiv.innerHTML = `<div class="error-message">${validation.message}</div>`;
                    return;
                }
            }
            
            const nm=((tv*tm)+(ttv*ttm))/(tv+ttv),t=tv+ttv;
            resultDiv.innerHTML=
                `<div class="result-item"><span>New Mix</span><span class="result-value">${(nm*100).toFixed(2)}%</span></div>
                <div class="result-item"><span>Total</span><span class="result-value">${t.toFixed(2)} gal</span></div>`;
            saveToHistory('Tote',{tm:(tm*100).toFixed(1),ttm:(ttm*100).toFixed(1),nm:(nm*100).toFixed(2)});
        }

        // ATIS and METAR Functions
        async function loadATIS() {
            try {
                // Reset display
                document.getElementById('temperature').textContent = 'Loading...';
                document.getElementById('dewpoint').textContent = 'Loading...';
                document.getElementById('wind').textContent = 'Loading...';
                document.getElementById('metar-full').textContent = 'Loading...';
                document.getElementById('metar-time').textContent = '--';
                document.getElementById('metar-observed').textContent = '--';
                document.getElementById('precip-box').style.display = 'none';
                
                // Fetch METAR using CORS proxy
                const station = 'KPIT';
                const metarURL = `https://aviationweather.gov/api/data/metar?ids=${station}&format=raw&taf=false&hours=0`;
                
                // Try direct fetch first
                try {
                    const metarResponse = await fetch(metarURL);
                    const metarText = await metarResponse.text();
                    
                    if (metarText && metarText.trim() && !metarText.includes('error')) {
                        displayMETARData(metarText);
                        return;
                    }
                } catch (directError) {
                    console.log('Direct fetch failed, trying CORS proxy...');
                }
                
                // If direct fetch fails, try with CORS proxy
                const proxyURL = `https://corsproxy.io/?${encodeURIComponent(metarURL)}`;
                const proxyResponse = await fetch(proxyURL);
                const metarText = await proxyResponse.text();
                
                if (metarText && metarText.trim()) {
                    displayMETARData(metarText);
                } else {
                    throw new Error('No METAR data received');
                }
                
            } catch (error) {
                console.error('Error loading METAR:', error);
                document.getElementById('temperature').textContent = 'Error';
                document.getElementById('dewpoint').textContent = 'Error';
                document.getElementById('wind').textContent = 'Error';
                document.getElementById('metar-full').innerHTML = `
                    <div style="color: #dc2626;">
                        Unable to load METAR data. This may be due to network restrictions.<br><br>
                        Please use the "View Detailed Weather" button below to access current weather information.
                    </div>
                `;
                document.getElementById('metar-time').textContent = 'Error';
                document.getElementById('metar-observed').textContent = 'Error';
            }
        }

        function displayMETARData(metarText) {
            // Display full METAR
            document.getElementById('metar-full').textContent = metarText;
            
            // Extract METAR observation time from the METAR text
            const observedTime = extractMETARTime(metarText);
            document.getElementById('metar-observed').textContent = observedTime;
            
            // Update "last checked" timestamp with current local time in 24-hour format
            const now = new Date();
            const options = {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            document.getElementById('metar-time').textContent = now.toLocaleTimeString('en-US', options);
            
            // Parse all weather data
            const weatherData = parseMETAR(metarText);
            
            // Temperature
            if (weatherData.temp) {
                document.getElementById('temperature').textContent = weatherData.temp;
            } else {
                document.getElementById('temperature').textContent = 'N/A';
            }
            
            // Dew Point
            if (weatherData.dewpoint) {
                document.getElementById('dewpoint').textContent = weatherData.dewpoint;
            } else {
                document.getElementById('dewpoint').textContent = 'N/A';
            }
            
            // Wind
            if (weatherData.wind) {
                document.getElementById('wind').textContent = weatherData.wind;
            } else {
                document.getElementById('wind').textContent = 'N/A';
            }
            
            // Precipitation
            const precipBox = document.getElementById('precip-box');
            if (weatherData.precipitation) {
                document.getElementById('precipitation').textContent = weatherData.precipitation;
                precipBox.style.display = 'block';
            } else {
                precipBox.style.display = 'none';
            }
        }

        function extractMETARTime(metar) {
            // METAR time format: KPIT 101851Z (day of month + time in UTC + Z)
            // Example: "KPIT 101851Z" means 10th day at 18:51 UTC
            const timeMatch = metar.match(/\s(\d{2})(\d{2})(\d{2})Z/);
            
            if (timeMatch) {
                const day = timeMatch[1];
                const hour = timeMatch[2];
                const minute = timeMatch[3];
                
                // Get current date to determine the month/year
                const now = new Date();
                const currentMonth = now.getUTCMonth();
                const currentYear = now.getUTCFullYear();
                
                // Create a UTC date for the METAR observation
                const metarDate = new Date(Date.UTC(currentYear, currentMonth, parseInt(day), parseInt(hour), parseInt(minute)));
                
                // Format the date/time in Eastern Time with 24-hour format
                const options = {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false,
                    timeZone: 'America/New_York',
                    timeZoneName: 'short'
                };
                
                return metarDate.toLocaleString('en-US', options);
            }
            
            return 'Unknown';
        }

        function parseMETAR(metar) {
            const result = { temp: null, dewpoint: null, wind: null, precipitation: null };
            
            // Parse temperature and dew point
            // METAR temperature format: M01/M03 or 15/08
            // M indicates minus (negative temperature)
            const tempMatch = metar.match(/\s(M?\d{2})\/(M?\d{2})\s/);
            
            if (tempMatch) {
                let temp = tempMatch[1];
                let dewpoint = tempMatch[2];
                
                // Convert to readable format
                if (temp.startsWith('M')) {
                    temp = '-' + temp.substring(1);
                }
                if (dewpoint.startsWith('M')) {
                    dewpoint = '-' + dewpoint.substring(1);
                }
                
                // Parse to integers and add unit
                const tempC = parseInt(temp);
                const dewC = parseInt(dewpoint);
                const tempF = Math.round((tempC * 9/5) + 32);
                const dewF = Math.round((dewC * 9/5) + 32);
                
                result.temp = `${tempC}¬∞C / ${tempF}¬∞F`;
                result.dewpoint = `${dewC}¬∞C / ${dewF}¬∞F`;
            }
            
            // Parse wind information
            // Format: 27008KT or 09012G22KT (with gusts) or 00000KT (calm) or VRB03KT (variable)
            const windMatch = metar.match(/\s(VRB|\d{3})(\d{2,3})(G(\d{2,3}))?KT/);
            
            if (windMatch) {
                const direction = windMatch[1];
                const speed = parseInt(windMatch[2]);
                const gust = windMatch[4] ? parseInt(windMatch[4]) : null;
                
                if (speed === 0) {
                    result.wind = 'Calm';
                } else {
                    let windText = '';
                    
                    if (direction === 'VRB') {
                        windText = `Variable at ${speed} kts`;
                    } else {
                        windText = `${direction}¬∞ at ${speed} kts`;
                    }
                    
                    if (gust) {
                        windText += ` gusting ${gust} kts`;
                    }
                    
                    result.wind = windText;
                }
            }
            
            // Parse precipitation/weather phenomena
            // Common codes: RA (rain), SN (snow), FG (fog), BR (mist), DZ (drizzle), 
            // TS (thunderstorm), SH (shower), FZ (freezing), + (heavy), - (light)
            const weatherCodes = {
                'RA': 'Rain',
                'SN': 'Snow',
                'DZ': 'Drizzle',
                'FG': 'Fog',
                'BR': 'Mist',
                'HZ': 'Haze',
                'FU': 'Smoke',
                'VA': 'Volcanic Ash',
                'DU': 'Dust',
                'SA': 'Sand',
                'TS': 'Thunderstorm',
                'SH': 'Shower',
                'FZ': 'Freezing',
                'GR': 'Hail',
                'GS': 'Small Hail',
                'PL': 'Ice Pellets',
                'SG': 'Snow Grains',
                'IC': 'Ice Crystals',
                'UP': 'Unknown Precipitation',
                'SQ': 'Squalls',
                'FC': 'Funnel Cloud',
                'SS': 'Sandstorm',
                'DS': 'Duststorm'
            };
            
            // Look for weather phenomena between the wind and temperature
            // Pattern: intensity (optional: - or +) + descriptor (optional) + precipitation type
            const weatherMatch = metar.match(/\s([-+])?(VC|MI|PR|BC|DR|BL|SH|TS|FZ)?(DZ|RA|SN|SG|IC|PL|GR|GS|UP|BR|FG|FU|VA|DU|SA|HZ|PY|PO|SQ|FC|SS|DS)/g);
            
            if (weatherMatch) {
                const weatherPhenomena = [];
                
                weatherMatch.forEach(wx => {
                    wx = wx.trim();
                    let description = '';
                    
                    // Check for intensity
                    if (wx.startsWith('-')) {
                        description = 'Light ';
                        wx = wx.substring(1);
                    } else if (wx.startsWith('+')) {
                        description = 'Heavy ';
                        wx = wx.substring(1);
                    }
                    
                    // Parse the weather codes
                    let matched = false;
                    for (let code in weatherCodes) {
                        if (wx.includes(code)) {
                            description += weatherCodes[code] + ' ';
                            matched = true;
                        }
                    }
                    
                    if (matched) {
                        weatherPhenomena.push(description.trim());
                    }
                });
                
                if (weatherPhenomena.length > 0) {
                    result.precipitation = weatherPhenomena.join(', ');
                }
            }
            
            return result;
        }

        function saveToHistory(t,d) {
            const h=JSON.parse(localStorage.getItem('mixHist')||'[]');
            h.unshift({type:t,data:d,time:new Date().toISOString()});
            if(h.length>50)h.pop();
            localStorage.setItem('mixHist',JSON.stringify(h));
        }

        function displayHistory() {
            const h=JSON.parse(localStorage.getItem('mixHist')||'[]');
            const l=document.getElementById('history-list');
            if(!h.length){l.innerHTML='<p style="color:#9ca3af;padding:40px 20px;text-align:center;">No calculations yet</p>';return;}
            l.innerHTML=h.map(x=>{
                const date=new Date(x.time).toLocaleString();
                let det='';
                if(x.type==='Inc')det=`${x.data.c}% ‚Üí ${x.data.d}% | Add ${x.data.g} gal glycol`;
                else if(x.type==='Dec')det=`${x.data.c}% ‚Üí ${x.data.d}% | Add ${x.data.w} gal water`;
                else if(x.type==='Vol')det=`${x.data.curVol} ‚Üí ${x.data.wantVol} gal | Add ${x.data.vol} gal at ${x.data.pct}% (${x.data.water} gal water + ${x.data.typeI} gal Type I)`;
                else if(x.type==='Tote')det=`${x.data.tm}% + ${x.data.ttm}% = ${x.data.nm}%`;
                return `<div style="padding:12px;background:#f0f9ff;border-radius:8px;margin-bottom:8px;">
                    <div style="font-weight:600;color:#0369a1;">${x.type}</div>
                    <div style="font-size:13px;color:#6b7280;">${det}</div>
                    <div style="font-size:11px;color:#9ca3af;">${date}</div></div>`;
            }).join('');
        }

        function clearHistory() {
            if(confirm('Clear all calculation history?')){localStorage.removeItem('mixHist');displayHistory();}
        }

        function loadNotes() {
            document.getElementById('notes-area').value=localStorage.getItem('fieldNotes')||'';
        }

        function saveNotes() {
            localStorage.setItem('fieldNotes',document.getElementById('notes-area').value);
            const s=document.getElementById('notes-status');
            s.textContent='Saving...';s.style.color='#0ea5e9';
            setTimeout(()=>{s.textContent='Saved ‚úì';s.style.color='#10b981';
                setTimeout(()=>s.style.color='#9ca3af',2000);},500);
        }

        // PDF Links - Edit this array to add/remove PDFs
        // IMPORTANT: Create a 'pdfs' folder in the same directory as this HTML file
        // and place your PDF files there with the exact filenames listed below
        const pdfLinks = [
            {
                title: 'Safety Manual',
                description: 'Winter operations safety procedures',
                filename: 'safety-manual.pdf'
            },
            {
                title: 'Deicing Procedures',
                description: 'Step-by-step deicing guidelines',
                filename: 'deicing-procedures.pdf'
            },
            {
                title: 'Equipment Guide',
                description: 'Equipment operation and maintenance',
                filename: 'equipment-guide.pdf'
            }
            // Add more PDFs here following the same format:
            // {
            //     title: 'Your PDF Title',
            //     description: 'Description of the PDF',
            //     filename: 'your-pdf-file.pdf'
            // }
        ];

        function loadPdfs() {
            const list = document.getElementById('pdf-list');
            
            if(!pdfLinks.length) {
                list.innerHTML = '<div class="pdf-missing">No PDF documents available.<br>Edit the pdfLinks array in the HTML to add documents.</div>';
                return;
            }
            
            list.innerHTML = pdfLinks.map(pdf => `
                <a href="./pdfs/${pdf.filename}" target="_blank" class="pdf-link" aria-label="Open ${pdf.title}">
                    <div class="pdf-icon">üìÑ</div>
                    <div class="pdf-info">
                        <div class="pdf-title">${pdf.title}</div>
                        ${pdf.description ? `<div class="pdf-desc">${pdf.description}</div>` : ''}
                    </div>
                </a>
            `).join('');
        }

        const dilutionData=[['100%','1.4230-1.4260','DO NOT USE','DO NOT USE'],['90%/10%','1.4156-1.4186','-39¬∞C/-38¬∞F','DO NOT USE'],['80%/20%','1.4079-1.4106','-39¬∞C/-38¬∞F','DO NOT USE'],['70%/30%','1.3996-1.4026','-43¬∞C/-45¬∞F','DO NOT USE'],['65%/35%','1.3953-1.3983','-41.5¬∞C/-43¬∞F','-31¬∞C/-24¬∞F'],['60%/40%','1.3911-1.3941','-40¬∞C/-40¬∞F','-30¬∞C/-22¬∞F'],['59%/41%','1.3905-1.3910','-39¬∞C/-39¬∞F','-29¬∞C/-21¬∞F'],['58%/42%','1.3899-1.3904','-39¬∞C/-38¬∞F','-29¬∞C/-20¬∞F'],['57%/43%','1.3893-1.3898','-38¬∞C/-36¬∞F','-28¬∞C/-18¬∞F'],['56%/44%','1.3886-1.3892','-37¬∞C/-34¬∞F','-27¬∞C/-16¬∞F'],['55%/45%','1.3879-1.3885','-36¬∞C/-32¬∞F','-26¬∞C/-14¬∞F'],['54%/46%','1.3872-1.3878','-34¬∞C/-29¬∞F','-24¬∞C/-11¬∞F'],['53%/47%','1.3865-1.3871','-32¬∞C/-26¬∞F','-22¬∞C/-8¬∞F'],['52%/48%','1.3858-1.3864','-31¬∞C/-23¬∞F','-21¬∞C/-5¬∞F'],['51%/49%','1.3851-1.3857','-29¬∞C/-20¬∞F','-19¬∞C/-2¬∞F'],['50%/50%','1.3820-1.3850','-27¬∞C/-17¬∞F','-17¬∞C/+1¬∞F'],['49%/51%','1.3811-1.3819','-26¬∞C/-15¬∞F','-16¬∞C/+3¬∞F'],['48%/52%','1.3803-1.3810','-25¬∞C/-13¬∞F','-15¬∞C/+5¬∞F'],['47%/53%','1.3795-1.3802','-24¬∞C/-11¬∞F','-14¬∞C/+7¬∞F'],['46%/54%','1.3787-1.3794','-23¬∞C/-9¬∞F','-13¬∞C/+9¬∞F'],['45%/55%','1.3779-1.3786','-22¬∞C/-8¬∞F','-12¬∞C/+10¬∞F'],['44%/56%','1.3771-1.3778','-21¬∞C/-6¬∞F','-11¬∞C/+12¬∞F'],['43%/57%','1.3763-1.3770','-21¬∞C/-5¬∞F','-11¬∞C/+13¬∞F'],['42%/58%','1.3755-1.3762','-19¬∞C/-3¬∞F','-9¬∞C/+15¬∞F'],['41%/59%','1.3747-1.3754','-19¬∞C/-2¬∞F','-9¬∞C/+16¬∞F'],['40%/60%','1.3716-1.3746','-18¬∞C/0¬∞F','-8¬∞C/+18¬∞F'],['39%/61%','1.3707-1.3715','-17¬∞C/+2¬∞F','-7¬∞C/+20¬∞F'],['38%/62%','1.3699-1.3706','-16¬∞C/+3¬∞F','-6¬∞C/+21¬∞F'],['37%/63%','1.3691-1.3698','-15¬∞C/+5¬∞F','-5¬∞C/+23¬∞F'],['36%/64%','1.3682-1.3690','-14¬∞C/+6¬∞F','-4¬∞C/+24¬∞F'],['35%/65%','1.3673-1.3681','-13¬∞C/+7¬∞F','-3¬∞C/+25¬∞F'],['34%/66%','1.3664-1.3672','-13¬∞C/+8¬∞F','-3¬∞C/+26¬∞F'],['33%/67%','1.3655-1.3663','-13¬∞C/+9¬∞F','-3¬∞C/+27¬∞F'],['32%/68%','1.3646-1.3654','-12¬∞C/+10¬∞F','-2¬∞C/+28¬∞F'],['31%/69%','1.3637-1.3645','-12¬∞C/+11¬∞F','-2¬∞C/+29¬∞F'],['30%/70%','1.3606-1.3636','-11¬∞C/+12¬∞F','-1¬∞C/+30¬∞F'],['29%/71%','1.3600-1.3605','-11¬∞C/+12¬∞F','-1¬∞C/+30¬∞F'],['28%/72%','1.3593-1.3599','-11¬∞C/+13¬∞F','-1¬∞C/+31¬∞F'],['27%/73%','1.3587-1.3592','-11¬∞C/+13¬∞F','-1¬∞C/+31¬∞F'],['26%/74%','1.3580-1.3586','-10¬∞C/+14¬∞F','0¬∞C/+32¬∞F'],['25%/75%','1.3573-1.3579','-10¬∞C/+14¬∞F','0¬∞C/+32¬∞F'],['24%/76%','1.3565-1.3573','-9¬∞C/+15¬∞F','+1¬∞C/+33¬∞F'],['23%/77%','1.3557-1.3565','-8¬∞C/+18¬∞F','+2¬∞C/+36¬∞F'],['22%/78%','1.3549-1.3557','-8¬∞C/+18¬∞F','+2¬∞C/+36¬∞F'],['21%/79%','1.3541-1.3549','-7¬∞C/+19¬∞F','+3¬∞C/+37¬∞F'],['20%/80%','1.3511-1.3541','-7¬∞C/+19¬∞F','+3¬∞C/+37¬∞F']];

        const aircraftData=[
            ['Alaska','OK','OK','(W&T) No Type IV on the Vertical Tail','N/A'],
            ['Allegiant','OK','OK','(W&T)','N/A'],
            ['American (AA) "Mainline"','OK','OK','(W&T) if (F) requested Mainline from the engines back','N/A'],
            ['American (AA) "Regionals"','OK','OK','(WTF) ERJ 140/145, E175 (F) if requested from the main cabin door, all others (W&T)','Hand Tactile E140/145 & CRJ200 - (No Forced Air on E140/E145)'],
            ['Air Canada (Jazz)','OK','OK','Advise Start Time of Final Application. No Type IV on the Fuselage','(No use of fluid/air mixture when defrosting or deicing)'],
            ['Delta (DL) "Mainline"','OK','OK','(W&T) only No Type IV on Vertical Tail - Ask Capt if WiFi Antenna is OFF or MUTED.','DL - Ladder Tactile (Plus 10\' Hand) on B717 if requested. Engine Inlets @ Gates on Rear Mounted Engines'],
            ['Delta (DL) Connex','OK','OK','E 145 (WTF), All others see DL/DC Reference Chart - Advise ALL to "Configure flaps prior to Type IV"','DC - Hand Tactile E140/145 & CRJ200 (No Forced Air on E140/145) - Engine Inlets @ Gates on Rear Mounted Engines'],
            ['Delta Endeavor Air (9E) CRJ 700/900','OK','OK','W&T','Forced Air and Fluid Injection Allowed'],
            ['SkyWest (OO) CRJ 200/700/900','OK','OK','ALL CRJ/ERJ = W&T (Overnight Type IV not allowed on any Skywest Aircraft)','Forced Air and Fluid Injection Allowed'],
            ['Republic (YX) ERJ 170/175','OK','OK','ERJ 170/175 = W&T','ERJ 170/175 No Forced Air or Fluid Injection during ERD'],
            ['FedEx (FX)','N/A','OK','(W&T) Unless MD11 (F) from trailing edge of Wings back','Engine Inlet Prep at Cargo Ramp'],
            ['JetBlue (B6)','NO','OK','(W&T) Only','8\' Nozzle Distance'],
            ['Southwest (WN)','NO','OK','(W&T) No Type IV on the winglets or Vertical, if (F) requsrted from behind the main cabin door','N/A'],
            ['Spirit (NK)','NO (MX Only)','OK','(W&T) if (F) requested from the main cabin door back - Ask crew if WiFi is OFF','N/A'],
            ['SunCountry','OK','OK','(W&T) No Type IV if not necessary on the Vertical Tail','Flight Crew can request Type IV on the Vertical Tail'],
            ['United (UAL)','OK','OK','(W&T) No Type IV on Winglets or Vertical','Crew can request Type IV on Fuselage'],
            ['United (UAL) Connex','OK','OK','(W&T) Type IV on Fuselage of E-145','Full Body Type I required on ALL Aircraft. Tactile check required on E-145'],
            ['UPS (5X)','N/A','OK','(W&T) if (F) requested form behind the main cabin door back. (Type IV is required on the fuselage of the MD-11) No Type IV on the Vertical Tail.','UPS Requires Brix and Dew Point (Farenheit) on Deice Logs. Engine Inlet Prep at Cargo Ramp. (No use of Fluid/Air Mixtures when Defrosting or Deicing)'],
            ['MAC','N/A','OK','(WTF)','Deice Engines Off - Gather Gallons Total for Post Readback']
        ];

        const airlinesData=[['Alaska','Alaska Airlines','Alaska','AS'],['Allegiant','Allegiant','Allegiant','G4'],['American','American','American','AA'],['Air Wisconsin','American','Wisconsin','ZW-AA'],['PSA Airlines','American','Blue Streak','OH-AA'],['Republic','American','Brickyard','YX-AA'],['Skywest','American','Skywest','OO-AA'],['Envoy','American','Envoy','MQ-AA'],['Piedmont','American','Piedmont','PT-AA'],['Delta','Delta','Delta','DL'],['Endeavor Air','Delta','Endeavor','9E-DL'],['Skywest','Delta','Skywest','OO-DL'],['Republic','Delta','Brickyard','YX-DL'],['United','United','United','UA'],['Republic','United','Brickyard','YX-UA'],['Mesa','United','Air Shuttle','YV-UA'],['Go-Jet','United','Lindbergh','G7-UA'],['Skywest','United','Skywest','OO-UA'],['CommuteAir','United','CommuteAir','C5-UA'],['Southern Airways','Southern Airways','Friendly','9X'],['JetBlue','JetBlue','JetBlue','B6'],['Southwest','Southwest','Southwest','WN'],['Spirit Airlines','Spirit Airlines','Spirit Wings','NK'],['Breeze Airways','Breeze Airways','Moxy','MX'],['British Airways','British Airways','Speedbird','BA'],['Air Canada','Air Canada','Air Canada','AC'],['Air Canada Express','Air Canada','Jazz','QK'],['Icelandair','Icelandair','Iceair','FI'],['FedEx','FedEx','FedEx','FX'],['Mountain Air Cargo','Mountain Air Cargo','Mountain','C2'],['UPS','UPS','UPS','5X'],['Atlas Air','Atlas Air','Giant','5Y'],['Kalitta Air','Kalitta Air','Connie','K4'],['ATI','ATI Transport Intl','Air Transport','8C'],['Amazon Air','Sun Country','Sun Country','SY'],['US Air Force','US Air Force','Various','USAF'],['PAN-G','PAN-G','Various','PaNG']];

        function loadDilution(){const t=document.getElementById('dilution-body');if(t.innerHTML)return;t.innerHTML=dilutionData.map(r=>`<tr>${r.map((c,i)=>`<td style="background:${i===0?'#f9fafb':'white'};${c.includes('DO NOT USE')?'color:#dc2626;font-weight:600;':''}">${c}</td>`).join('')}</tr>`).join('');}

        function loadAircraft(){const t=document.getElementById('aircraft-body');if(t.innerHTML)return;t.innerHTML=aircraftData.map(r=>`<tr>${r.map((c,i)=>`<td style="background:${i===0?'#f9fafb':'white'};font-size:10px;line-height:1.3;">${c}</td>`).join('')}</tr>`).join('');}

        function loadAirlines(){const t=document.getElementById('airlines-body');if(t.innerHTML)return;t.innerHTML=airlinesData.map(r=>`<tr>${r.map((c,i)=>`<td style="background:${i===0?'#f9fafb':'white'};">${c}</td>`).join('')}</tr>`).join('');}


        // Service Worker Registration
        if('serviceWorker' in navigator){
            window.addEventListener('load',()=>{
                navigator.serviceWorker.register('./service-worker.js')
                .then(reg=>{
                    console.log('Service Worker registered successfully');
                    reg.update();
                })
                .catch(e=>console.log('SW registration failed:',e));
            });
        }

        // Update App Function
        function updateApp(){
            if('serviceWorker' in navigator){
                navigator.serviceWorker.getRegistration().then(reg=>{
                    if(reg&&reg.waiting){
                        reg.waiting.postMessage({type:'SKIP_WAITING'});
                    }
                    caches.keys().then(names=>{
                        names.forEach(name=>caches.delete(name));
                    }).then(()=>window.location.reload(true));
                });
            }else{
                window.location.reload(true);
            }
        }

        // Add keyboard support for menu cards
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.menu-card').forEach(card => {
                card.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                });
            });
        });
    </script>
</body>
</html>
