<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0ea5e9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Mixing Fluid Calculator</title>
    <link rel="manifest" id="manifest-placeholder">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 50%, #7dd3fc 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; color: #0c4a6e; margin-bottom: 30px; }
        .page { display: none; }
        .page.active { display: block; }
        .menu-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            cursor: pointer;
            border: 2px solid rgba(186, 230, 253, 0.5);
        }
        .menu-card h3 { color: #0369a1; margin-bottom: 8px; }
        .back-button {
            background: rgba(255, 255, 255, 0.7);
            color: #0369a1;
            border: 2px solid rgba(186, 230, 253, 0.5);
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 24px;
        }
        input, textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 16px;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            background: #f0f9ff;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .result-value { font-weight: 700; color: #0369a1; }
    </style>
</head>
<body>
    <div id="update-banner" class="update-banner">
        <span>New version available</span>
        <button onclick="updateApp()">Update Now</button>
    </div>
    <div class="version-badge">v1.0.1</div>
    <div class="container">
        <div class="header"><h1>Mixing Fluid Calculator</h1></div>
        
        <div class="page active" id="menu">
            <div class="menu-card" onclick="showPage('increase')"><h3>Increase Mix</h3></div>
            <div class="menu-card" onclick="showPage('decrease')"><h3>Decrease Mix</h3></div>
            <div class="menu-card" onclick="showPage('volume')"><h3>Increase Volume</h3></div>
            <div class="menu-card" onclick="showPage('tote')"><h3>Adding Tote</h3></div>
            <div class="menu-card" onclick="showPage('history')"><h3>üìã History</h3></div>
            <div class="menu-card" onclick="showPage('chart')"><h3>üìä Dilution Chart</h3></div>
            <div class="menu-card" onclick="showPage('notes')"><h3>üìù Notes</h3></div>
        </div>

        <div class="page" id="increase">
            <button class="back-button" onclick="showPage('menu')">‚Üê Back</button>
            <div class="card">
                <h2>Increase Mix</h2>
                <input type="number" id="inc-cur" placeholder="Current Mix %" oninput="calcInc()">
                <input type="number" id="inc-des" placeholder="Desired Mix %" oninput="calcInc()">
                <input type="number" id="inc-vol" placeholder="Current Volume" oninput="calcInc()">
                <div id="inc-result"></div>
            </div>
        </div>

        <div class="page" id="decrease">
            <button class="back-button" onclick="showPage('menu')">‚Üê Back</button>
            <div class="card">
                <h2>Decrease Mix</h2>
                <input type="number" id="dec-cur" placeholder="Current Mix %" oninput="calcDec()">
                <input type="number" id="dec-des" placeholder="Desired Mix %" oninput="calcDec()">
                <input type="number" id="dec-vol" placeholder="Current Volume" oninput="calcDec()">
                <div id="dec-result"></div>
            </div>
        </div>

        <div class="page" id="volume">
            <button class="back-button" onclick="showPage('menu')">‚Üê Back</button>
            <div class="card">
                <h2>Increase Volume</h2>
                <input type="number" id="vol-cur" placeholder="Current Mix %" oninput="calcVol()">
                <input type="number" id="vol-want" placeholder="Wanted Mix %" oninput="calcVol()">
                <input type="number" id="vol-curv" placeholder="Current Volume" oninput="calcVol()">
                <input type="number" id="vol-wantv" placeholder="Wanted Volume" oninput="calcVol()">
                <div id="vol-result"></div>
            </div>
        </div>

        <div class="page" id="tote">
            <button class="back-button" onclick="showPage('menu')">‚Üê Back</button>
            <div class="card">
                <h2>Adding Tote</h2>
                <input type="number" id="tote-tm" placeholder="Truck Mix %" oninput="calcTote()">
                <input type="number" id="tote-tv" placeholder="Truck Volume" oninput="calcTote()">
                <input type="number" id="tote-ttm" placeholder="Tote Mix %" oninput="calcTote()">
                <input type="number" id="tote-ttv" placeholder="Tote Volume" oninput="calcTote()">
                <div id="tote-result"></div>
            </div>
        </div>

        <div class="page" id="notes">
            <button class="back-button" onclick="showPage('menu')">‚Üê Back</button>
            <div class="card">
                <h2>Field Notes</h2>
                <textarea id="notes-area" rows="15" placeholder="Type notes here..." oninput="saveNotes()"></textarea>
                <div id="notes-status" style="color: #9ca3af; font-size: 13px;">Auto-saved</div>
            </div>
        </div>

        <div class="page" id="history">
            <button class="back-button" onclick="showPage('menu')">‚Üê Back</button>
            <div class="card">
                <h2>Calculation History</h2>
                <div id="history-list"></div>
                <button onclick="clearHistory()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; margin-top: 12px; cursor: pointer;">Clear History</button>
            </div>
        </div>

        <div class="page" id="chart">
            <button class="back-button" onclick="showPage('menu')">‚Üê Back</button>
            <div class="card">
                <h2 style="margin-bottom: 12px;">Safetemp ES Plus</h2>
                <p style="margin-bottom: 16px; color: #6b7280; font-size: 14px;">Dilution and LOUT Chart</p>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background: #0ea5e9; color: white;">
                                <th style="padding: 8px; border: 1px solid #7dd3fc;">Dilution</th>
                                <th style="padding: 8px; border: 1px solid #7dd3fc;">Refractive Index</th>
                                <th style="padding: 8px; border: 1px solid #7dd3fc;">Freeze Point</th>
                                <th style="padding: 8px; border: 1px solid #7dd3fc;">LOUT</th>
                            </tr>
                        </thead>
                        <tbody id="chart-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const APP_VERSION = '1.0.1'; // Update this when you make changes
        
        // Service Worker Registration with Update Detection
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                registerServiceWorker();
            });
        }

        function registerServiceWorker() {
            navigator.serviceWorker.register('./service-worker.js')
                .then((registration) => {
                    console.log('Service Worker registered successfully');
                    
                    // Store current version to compare later
                    const storedVersion = localStorage.getItem('appVersion');
                    if (storedVersion !== APP_VERSION) {
                        // Version changed, update storage
                        localStorage.setItem('appVersion', APP_VERSION);
                        console.log('App updated to version:', APP_VERSION);
                    }
                    
                    // Check for updates every time page loads
                    registration.update();

                    // Listen for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New version available - only show if not just updated
                                const lastUpdate = localStorage.getItem('lastUpdateTime');
                                const now = Date.now();
                                // Don't show banner if updated in last 5 seconds
                                if (!lastUpdate || (now - parseInt(lastUpdate)) > 5000) {
                                    showUpdateBanner();
                                }
                            }
                        });
                    });
                })
                .catch((error) => {
                    console.log('Service Worker registration failed:', error);
                });
        }

        function showUpdateBanner() {
            // Only show if there's actually a controller (not first install)
            if (navigator.serviceWorker.controller) {
                document.getElementById('update-banner').style.display = 'block';
            }
        }

        function updateApp() {
            // Store update timestamp
            localStorage.setItem('lastUpdateTime', Date.now().toString());
            // Hide banner
            document.getElementById('update-banner').style.display = 'none';
            // Force reload from server
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(reg => {
                    if (reg && reg.waiting) {
                        reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                    }
                    // Clear all caches to force fresh load
                    caches.keys().then(names => {
                        names.forEach(name => caches.delete(name));
                    }).then(() => {
                        window.location.reload(true);
                    });
                });
            } else {
                window.location.reload(true);
            }
        }

        // Create and inject manifest
        const manifestData = {
            "name": "Mixing Fluid Calculator",
            "short_name": "MixCalc",
            "start_url": "./",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#0ea5e9",
            "icons": [
                {
                    "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%230ea5e9'/%3E%3Ctext x='50%25' y='60%25' font-size='50' text-anchor='middle' fill='white'%3EM%3C/text%3E%3C/svg%3E",
                    "sizes": "192x192",
                    "type": "image/svg+xml"
                }
            ]
        };
        const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);

        const chartData = [
            ['100%','1.4230-1.4260','DO NOT USE','DO NOT USE'],['90%/10%','1.4156-1.4186','-39¬∞C/-38¬∞F','DO NOT USE'],
            ['80%/20%','1.4079-1.4106','-39¬∞C/-38¬∞F','DO NOT USE'],['70%/30%','1.3996-1.4026','-43¬∞C/-45¬∞F','DO NOT USE'],
            ['65%/35%','1.3953-1.3983','-41.5¬∞C/-43¬∞F','-31¬∞C/-24¬∞F'],['60%/40%','1.3911-1.3941','-40¬∞C/-40¬∞F','-30¬∞C/-22¬∞F'],
            ['59%/41%','1.3905-1.3910','-39¬∞C/-39¬∞F','-29¬∞C/-21¬∞F'],['58%/42%','1.3899-1.3904','-39¬∞C/-38¬∞F','-29¬∞C/-20¬∞F'],
            ['57%/43%','1.3893-1.3898','-38¬∞C/-36¬∞F','-28¬∞C/-18¬∞F'],['56%/44%','1.3886-1.3892','-37¬∞C/-34¬∞F','-27¬∞C/-16¬∞F'],
            ['55%/45%','1.3879-1.3885','-36¬∞C/-32¬∞F','-26¬∞C/-14¬∞F'],['54%/46%','1.3872-1.3878','-34¬∞C/-29¬∞F','-24¬∞C/-11¬∞F'],
            ['53%/47%','1.3865-1.3871','-32¬∞C/-26¬∞F','-22¬∞C/-8¬∞F'],['52%/48%','1.3858-1.3864','-31¬∞C/-23¬∞F','-21¬∞C/-5¬∞F'],
            ['51%/49%','1.3851-1.3857','-29¬∞C/-20¬∞F','-19¬∞C/-2¬∞F'],['50%/50%','1.3820-1.3850','-27¬∞C/-17¬∞F','-17¬∞C/+1¬∞F'],
            ['49%/51%','1.3811-1.3819','-26¬∞C/-15¬∞F','-16¬∞C/+3¬∞F'],['48%/52%','1.3803-1.3810','-25¬∞C/-13¬∞F','-15¬∞C/+5¬∞F'],
            ['47%/53%','1.3795-1.3802','-24¬∞C/-11¬∞F','-14¬∞C/+7¬∞F'],['46%/54%','1.3787-1.3794','-23¬∞C/-9¬∞F','-13¬∞C/+9¬∞F'],
            ['45%/55%','1.3779-1.3786','-22¬∞C/-8¬∞F','-12¬∞C/+10¬∞F'],['44%/56%','1.3771-1.3778','-21¬∞C/-6¬∞F','-11¬∞C/+12¬∞F'],
            ['43%/57%','1.3763-1.3770','-21¬∞C/-5¬∞F','-11¬∞C/+13¬∞F'],['42%/58%','1.3755-1.3762','-19¬∞C/-3¬∞F','-9¬∞C/+15¬∞F'],
            ['41%/59%','1.3747-1.3754','-19¬∞C/-2¬∞F','-9¬∞C/+16¬∞F'],['40%/60%','1.3716-1.3746','-18¬∞C/0¬∞F','-8¬∞C/+18¬∞F'],
            ['39%/61%','1.3707-1.3715','-17¬∞C/+2¬∞F','-7¬∞C/+20¬∞F'],['38%/62%','1.3699-1.3706','-16¬∞C/+3¬∞F','-6¬∞C/+21¬∞F'],
            ['37%/63%','1.3691-1.3698','-15¬∞C/+5¬∞F','-5¬∞C/+23¬∞F'],['36%/64%','1.3682-1.3690','-14¬∞C/+6¬∞F','-4¬∞C/+24¬∞F'],
            ['35%/65%','1.3673-1.3681','-13¬∞C/+7¬∞F','-3¬∞C/+25¬∞F'],['34%/66%','1.3664-1.3672','-13¬∞C/+8¬∞F','-3¬∞C/+26¬∞F'],
            ['33%/67%','1.3655-1.3663','-13¬∞C/+9¬∞F','-3¬∞C/+27¬∞F'],['32%/68%','1.3646-1.3654','-12¬∞C/+10¬∞F','-2¬∞C/+28¬∞F'],
            ['31%/69%','1.3637-1.3645','-12¬∞C/+11¬∞F','-2¬∞C/+29¬∞F'],['30%/70%','1.3606-1.3636','-11¬∞C/+12¬∞F','-1¬∞C/+30¬∞F'],
            ['29%/71%','1.3600-1.3605','-11¬∞C/+12¬∞F','-1¬∞C/+30¬∞F'],['28%/72%','1.3593-1.3599','-11¬∞C/+13¬∞F','-1¬∞C/+31¬∞F'],
            ['27%/73%','1.3587-1.3592','-11¬∞C/+13¬∞F','-1¬∞C/+31¬∞F'],['26%/74%','1.3580-1.3586','-10¬∞C/+14¬∞F','0¬∞C/+32¬∞F'],
            ['25%/75%','1.3573-1.3579','-10¬∞C/+14¬∞F','0¬∞C/+32¬∞F'],['24%/76%','1.3565-1.3573','-9¬∞C/+15¬∞F','+1¬∞C/+33¬∞F'],
            ['23%/77%','1.3557-1.3565','-8¬∞C/+18¬∞F','+2¬∞C/+36¬∞F'],['22%/78%','1.3549-1.3557','-8¬∞C/+18¬∞F','+2¬∞C/+36¬∞F'],
            ['21%/79%','1.3541-1.3549','-7¬∞C/+19¬∞F','+3¬∞C/+37¬∞F'],['20%/80%','1.3511-1.3541','-7¬∞C/+19¬∞F','+3¬∞C/+37¬∞F']
        ];

        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            if (page === 'notes') loadNotes();
            if (page === 'history') displayHistory();
            if (page === 'chart') loadChart();
        }

        function loadChart() {
            const tbody = document.getElementById('chart-body');
            if (tbody.innerHTML) return;
            tbody.innerHTML = chartData.map(row => 
                `<tr>${row.map((cell, i) => 
                    `<td style="padding: 6px; border: 1px solid #e5e7eb; background: ${i === 0 ? '#f9fafb' : 'white'}; ${cell.includes('DO NOT USE') ? 'color: #dc2626; font-weight: 600;' : ''}">${cell}</td>`
                ).join('')}</tr>`
            ).join('');
        }

        function saveToHistory(type, data) {
            const hist = JSON.parse(localStorage.getItem('mixHist') || '[]');
            hist.unshift({type, data, time: new Date().toISOString()});
            if (hist.length > 50) hist.pop();
            localStorage.setItem('mixHist', JSON.stringify(hist));
        }

        function displayHistory() {
            const hist = JSON.parse(localStorage.getItem('mixHist') || '[]');
            const list = document.getElementById('history-list');
            if (!hist.length) { list.innerHTML = '<p style="color: #9ca3af; padding: 40px 20px; text-align: center;">No calculations yet</p>'; return; }
            list.innerHTML = hist.map(h => {
                const date = new Date(h.time).toLocaleString();
                let details = '';
                if (h.type === 'Inc') details = `${h.data.c}% ‚Üí ${h.data.d}% | Add ${h.data.g} gal glycol`;
                else if (h.type === 'Dec') details = `${h.data.c}% ‚Üí ${h.data.d}% | Add ${h.data.w} gal water`;
                else if (h.type === 'Vol') details = `${h.data.cv} ‚Üí ${h.data.wv} gal | Add ${h.data.t} gal`;
                else if (h.type === 'Tote') details = `${h.data.tm}% + ${h.data.ttm}% = ${h.data.nm}%`;
                return `<div style="padding: 12px; background: #f0f9ff; border-radius: 8px; margin-bottom: 8px;">
                    <div style="font-weight: 600; color: #0369a1;">${h.type}</div>
                    <div style="font-size: 13px; color: #6b7280;">${details}</div>
                    <div style="font-size: 11px; color: #9ca3af;">${date}</div>
                </div>`;
            }).join('');
        }

        function clearHistory() {
            if (confirm('Clear all history?')) { localStorage.removeItem('mixHist'); displayHistory(); }
        }

        function calcInc() {
            const cur = parseFloat(document.getElementById('inc-cur').value);
            const des = parseFloat(document.getElementById('inc-des').value);
            const vol = parseFloat(document.getElementById('inc-vol').value);
            if (!cur || !des || !vol) { document.getElementById('inc-result').innerHTML = ''; return; }
            const glycol = vol * ((des - cur) / (100 - des));
            const total = vol + glycol;
            document.getElementById('inc-result').innerHTML = 
                `<div class="result-item"><span>Glycol to Add</span><span class="result-value">${glycol.toFixed(2)} gal</span></div>
                <div class="result-item"><span>Total Volume</span><span class="result-value">${total.toFixed(2)} gal</span></div>`;
            saveToHistory('Inc', {c: cur, d: des, v: vol, g: glycol.toFixed(2)});
        }

        function calcDec() {
            const cur = parseFloat(document.getElementById('dec-cur').value);
            const des = parseFloat(document.getElementById('dec-des').value);
            const vol = parseFloat(document.getElementById('dec-vol').value);
            if (!cur || !des || !vol) { document.getElementById('dec-result').innerHTML = ''; return; }
            const water = vol * ((cur - des) / des);
            const total = vol + water;
            document.getElementById('dec-result').innerHTML = 
                `<div class="result-item"><span>Water to Add</span><span class="result-value">${water.toFixed(2)} gal</span></div>
                <div class="result-item"><span>Total Volume</span><span class="result-value">${total.toFixed(2)} gal</span></div>`;
            saveToHistory('Dec', {c: cur, d: des, v: vol, w: water.toFixed(2)});
        }

        function calcVol() {
            const cur = parseFloat(document.getElementById('vol-cur').value) / 100;
            const want = parseFloat(document.getElementById('vol-want').value) / 100;
            const curv = parseFloat(document.getElementById('vol-curv').value);
            const wantv = parseFloat(document.getElementById('vol-wantv').value);
            if (!cur || !want || !curv || !wantv) { document.getElementById('vol-result').innerHTML = ''; return; }
            const glycol = (wantv * want) - (curv * cur);
            const water = wantv - (curv * cur) - (wantv * want);
            const total = glycol + water;
            const percent = (glycol / total) * 100;
            document.getElementById('vol-result').innerHTML = 
                `<div class="result-item"><span>Glycol to Add</span><span class="result-value">${glycol.toFixed(2)} gal</span></div>
                <div class="result-item"><span>Water to Add</span><span class="result-value">${water.toFixed(2)} gal</span></div>
                <div class="result-item"><span>Total to Add</span><span class="result-value">${total.toFixed(2)} gal</span></div>
                <div class="result-item"><span>% Glycol</span><span class="result-value">${percent.toFixed(2)}%</span></div>`;
            saveToHistory('Vol', {cv: curv, wv: wantv, t: total.toFixed(2)});
        }

        function calcTote() {
            const tm = parseFloat(document.getElementById('tote-tm').value) / 100;
            const tv = parseFloat(document.getElementById('tote-tv').value);
            const ttm = parseFloat(document.getElementById('tote-ttm').value) / 100;
            const ttv = parseFloat(document.getElementById('tote-ttv').value);
            if (!tm || !tv || !ttm || !ttv) { document.getElementById('tote-result').innerHTML = ''; return; }
            const newMix = ((tv * tm) + (ttv * ttm)) / (tv + ttv);
            const total = tv + ttv;
            document.getElementById('tote-result').innerHTML = 
                `<div class="result-item"><span>New Mix</span><span class="result-value">${(newMix * 100).toFixed(2)}%</span></div>
                <div class="result-item"><span>Total Volume</span><span class="result-value">${total.toFixed(2)} gal</span></div>`;
            saveToHistory('Tote', {tm: (tm*100).toFixed(1), ttm: (ttm*100).toFixed(1), nm: (newMix*100).toFixed(2)});
        }

        function loadNotes() {
            document.getElementById('notes-area').value = localStorage.getItem('fieldNotes') || '';
        }

        function saveNotes() {
            localStorage.setItem('fieldNotes', document.getElementById('notes-area').value);
            const status = document.getElementById('notes-status');
            status.textContent = 'Saving...';
            status.style.color = '#0ea5e9';
            setTimeout(() => {
                status.textContent = 'Saved ‚úì';
                status.style.color = '#10b981';
                setTimeout(() => { status.style.color = '#9ca3af'; }, 2000);
            }, 500);
        }
    </script>
</body>
</html>

