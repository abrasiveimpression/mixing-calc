<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>KPIT ICEMAN</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: linear-gradient(135deg,#e0f2fe 0%,#bae6fd 50%,#7dd3fc 100%);
      min-height:100vh;
      padding:20px;
    }

    .container{ max-width:600px; margin:0 auto; }

    .header{
      text-align:center;
      color:#0c4a6e;
      margin-bottom:30px;
      position:relative;
      padding-top:40px;
    }

    .update-btn{
      position:absolute; top:0; left:0;
      background:#0ea5e9; color:#fff; border:none;
      padding:6px 12px; border-radius:6px;
      cursor:pointer; font-size:12px; font-weight:600;
    }
    .update-btn:hover{ background:#0284c7; }

    .lock-btn{
      position:absolute; top:0; right:0;
      background:#10b981; color:#fff; border:none;
      padding:6px 12px; border-radius:6px;
      cursor:pointer; font-size:12px; font-weight:600;
    }
    .lock-btn:hover{ background:#059669; }
    .lock-btn.locked{ background:#0ea5e9; }
    .lock-btn.locked:hover{ background:#0ea5e9; }

    .page{ display:none; }
    .page.active{ display:block; }

    .menu-grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
    }

    .menu-card{
      background:rgba(255,255,255,.95);
      border-radius:16px;
      padding:20px;
      cursor:pointer;
      border:2px solid rgba(186,230,253,.5);
      text-align:center;
      transition:all .2s;
      cursor: grab;
      user-select:none;
      -webkit-user-select:none;
      touch-action: manipulation;
    }
    .menu-card:active{ cursor: grabbing; }
    .menu-card:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(14,165,233,.2);
    }
    .menu-card.dragging{ opacity:.5; cursor:grabbing; }
    .menu-card.drag-over{ outline:3px dashed rgba(14,165,233,.7); outline-offset:2px; }
    .menu-card h3{ color:#0369a1; margin-bottom:0; font-size:16px; }

    .back-button{
      background:rgba(255,255,255,.7);
      color:#0369a1;
      border:2px solid rgba(186,230,253,.5);
      padding:10px 20px;
      border-radius:10px;
      cursor:pointer;
      margin-bottom:20px;
      font-size:14px;
      font-weight:600;
    }
    .back-button:hover{ background:rgba(255,255,255,.9); }

    .card{
      background:rgba(255,255,255,.95);
      border-radius:20px;
      padding:24px;
    }

    input, textarea, select{
      width:100%;
      padding:14px;
      border:2px solid #e5e7eb;
      border-radius:10px;
      font-size:16px;
      margin-bottom:16px;
    }
    input:focus, textarea:focus, select:focus{
      outline:none;
      border-color:#0ea5e9;
    }

    .result-item{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:12px 16px;
      background:#f0f9ff;
      border-radius:10px;
      margin-bottom:10px;
    }
    .result-value{ font-weight:700; color:#0369a1; }

    .error-message{
      background:#fef2f2;
      color:#dc2626;
      padding:12px 16px;
      border-radius:10px;
      margin-bottom:10px;
      font-size:14px;
    }

    table{ width:100%; border-collapse:collapse; font-size:11px; }
    th,td{ padding:6px; border:1px solid #e5e7eb; text-align:left; }
    th{ background:#0ea5e9; color:#fff; border-color:#7dd3fc; }

    .version-badge{
      position:fixed;
      bottom:10px; right:10px;
      background:rgba(255,255,255,.9);
      color:#6b7280;
      padding:4px 10px;
      border-radius:12px;
      font-size:11px;
      z-index:9999;
    }

    .pdf-link{
      display:flex;
      align-items:center;
      padding:14px 16px;
      background:#f0f9ff;
      border-radius:10px;
      margin-bottom:10px;
      text-decoration:none;
      color:#0369a1;
      border:2px solid transparent;
      transition:all .2s;
    }
    .pdf-link:hover{ background:#e0f2fe; border-color:#0ea5e9; }
    .pdf-icon{ font-size:24px; margin-right:12px; }
    .pdf-info{ flex:1; }
    .pdf-title{ font-weight:600; font-size:15px; margin-bottom:2px; }
    .pdf-desc{ font-size:12px; color:#6b7280; }
    .pdf-missing{ padding:20px; text-align:center; color:#9ca3af; font-size:14px; }

    .iframe-container{
      width:100%;
      height:80vh;
      border:2px solid #e5e7eb;
      border-radius:10px;
      overflow:hidden;
      background:#fff;
      position:relative;
    }
    .iframe-container iframe{
      position:absolute;
      top:0;
      left:50%;
      width:250%;
      height:250%;
      border:none;
      transform:scale(.4) translateX(-50%);
      transform-origin:top left;
    }

    .info-box{
      background:#f0f9ff;
      border-left:4px solid #0ea5e9;
      padding:16px;
      border-radius:8px;
      margin-bottom:16px;
    }
    .info-label{
      font-size:12px;
      color:#6b7280;
      text-transform:uppercase;
      letter-spacing:.5px;
      margin-bottom:4px;
    }
    .info-value{
      font-size:24px;
      font-weight:700;
      color:#0369a1;
    }

    .loading{ text-align:center; padding:20px; color:#6b7280; }

    .refresh-btn{
      background:#0ea5e9;
      color:#fff;
      border:none;
      padding:10px 20px;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
      font-weight:600;
      margin-top:10px;
    }
    .refresh-btn:hover{ background:#0284c7; }

    .btn-mode{
      background:#fff;
      color:#0369a1;
      border:2px solid #e5e7eb;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-size:12px;
      font-weight:600;
      width:100%;
      margin-bottom:12px;
      transition:all .2s;
    }
    .btn-mode:hover{ border-color:#0ea5e9; background:#f0f9ff; }
    .btn-mode.active{ background:#0ea5e9; color:#fff; border-color:#0ea5e9; }

    .metar-box{
      background:#fff;
      padding:16px;
      border-radius:10px;
      border:2px solid #e5e7eb;
      margin-top:16px;
      font-family:"Courier New",monospace;
      font-size:13px;
      line-height:1.6;
      word-wrap:break-word;
    }

    .external-link-btn{
      display:inline-block;
      background:#10b981;
      color:#fff;
      padding:8px 16px;
      border-radius:8px;
      text-decoration:none;
      font-size:13px;
      font-weight:600;
      margin-top:10px;
      transition:all .2s;
    }
    .external-link-btn:hover{ background:#059669; }

    .btn-primary{
      background:#0ea5e9;
      color:#fff;
      border:none;
      padding:12px 24px;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
      font-weight:600;
      width:100%;
      margin-bottom:12px;
    }
    .btn-primary:hover{ background:#0284c7; }

    .btn-secondary{
      background:#10b981;
      color:#fff;
      border:none;
      padding:12px 24px;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
      font-weight:600;
      width:100%;
      margin-bottom:12px;
    }
    .btn-secondary:hover{ background:#059669; }

    .truck-result{
      background:#fff;
      border:2px solid #e5e7eb;
      border-radius:12px;
      padding:16px;
      margin-bottom:12px;
    }
    .truck-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
      padding-bottom:8px;
      border-bottom:2px solid #e5e7eb;
    }
    .truck-id{
      font-size:18px;
      font-weight:700;
      color:#0369a1;
    }
    .truck-status{
      font-size:12px;
      padding:4px 8px;
      border-radius:6px;
      font-weight:600;
    }
    .status-success{ background:#d1fae5; color:#065f46; }
    .status-error{ background:#fee2e2; color:#991b1b; }

    .truck-ref-box{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:6px 10px;
      margin-top:8px;
      font-size:11.5px;
      line-height:1.25;
    }
    .truck-ref-item{
      display:flex;
      justify-content:space-between;
      gap:8px;
      padding:6px 8px;
      background:#f8fafc;
      border:1px solid #e5e7eb;
      border-radius:8px;
    }
    .truck-ref-label{
      color:#6b7280;
      font-weight:700;
      white-space:nowrap;
      font-size: 11px;
    }
    .truck-ref-value{
      color:#111827;
      font-weight:700;
      text-align:right;
      font-size: 11.5px;
      white-space:normal;
      word-break: break-word;
      min-width: 0;
    }
@media (max-width: 420px){
    .truck-ref-box{
        grid-template-columns: 1fr;
    }
}

    .fluid-add-box{
      background:#f0f9ff;
      padding:12px;
      border-radius:8px;
      margin-top:12px;
    }
    .fluid-add-title{
      font-size:12px;
      color:#6b7280;
      margin-bottom:8px;
      font-weight:700;
    }

    /* Gauge Match (Fill Station) */
    .gauge-match-box{
      background:#fff7ed;
      border:2px solid #fed7aa;
      border-radius:10px;
      padding:12px;
      margin-top:12px;
    }
    .gm-toggle-inline{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:13px;
      font-weight:800;
      color:#92400e;
      cursor:pointer;
      user-select:none;
      margin:0;
      padding:0;
    }
    .gm-toggle-inline input[type="checkbox"]{
      width:18px;
      height:18px;
      margin:0;
      cursor:pointer;
      flex-shrink:0;
    }
    .gm-body{ margin-top:10px; }
    .gm-input{
      width:100%;
      padding:10px 12px;
      border:2px solid #e5e7eb;
      border-radius:10px;
      font-size:14px;
      margin:0;
      text-align:right;
      background:#fff;
    }
    .gm-input:focus{ outline:none; border-color:#f97316; }
    .gm-hint{
      margin-top:8px;
      font-size:11px;
      color:#6b7280;
      line-height:1.4;
    }

    .summary-box{
      background: linear-gradient(135deg,#0ea5e9 0%,#0284c7 100%);
      color:#fff;
      padding:20px;
      border-radius:12px;
      margin-bottom:16px;
    }
    .summary-title{ font-size:16px; font-weight:800; margin-bottom:12px; }
    .summary-stat{
      display:flex;
      justify-content:space-between;
      padding:6px 0;
      font-size:14px;
    }
    .summary-stat-value{ font-weight:800; font-size:16px; }
  </style>
</head>

<body>
  <div class="version-badge">v1.5.1</div>

  <div class="container">
    <div class="header">
      <button class="update-btn" onclick="updateApp()" aria-label="Update application">üîÑ Update</button>
      <h1>KPIT ICEMAN</h1>
      <button class="lock-btn" id="lock-btn" onclick="toggleMenuLock()" aria-label="Toggle menu lock">üîí</button>
    </div>

    <!-- MENU -->
    <div class="page active" id="menu">
      <div class="menu-grid" id="menu-grid">
        <div class="menu-card" draggable="true" data-menu-id="increase" role="button" tabindex="0" aria-label="Increase Mix"><h3>Increase Mix</h3></div>
        <div class="menu-card" draggable="true" data-menu-id="decrease" role="button" tabindex="0" aria-label="Decrease Mix"><h3>Decrease Mix</h3></div>
        <div class="menu-card" draggable="true" data-menu-id="volume" role="button" tabindex="0" aria-label="Increase Volume"><h3>Increase Volume</h3></div>
        <div class="menu-card" draggable="true" data-menu-id="batch" role="button" tabindex="0" aria-label="Batch Trucks"><h3>üöö Batch Trucks</h3></div>
        <div class="menu-card" draggable="true" data-menu-id="tote" role="button" tabindex="0" aria-label="Tote to Truck"><h3>Tote to Truck</h3></div>
        <div class="menu-card" draggable="true" data-menu-id="truckboard" role="button" tabindex="0" aria-label="Truck Board"><h3>üöõ Truck Board</h3></div>
        <div class="menu-card" draggable="true" data-menu-id="truckboard-edit" role="button" tabindex="0" aria-label="Edit Truck Board"><h3>‚úèÔ∏è Edit Truck Board</h3></div>
        <div class="menu-card" draggable="true" data-menu-id="atis" role="button" tabindex="0" aria-label="ATIS & Weather"><h3>üì° ATIS & Weather</h3></div>
        <div class="menu-card" draggable="true" data-menu-id="history" role="button" tabindex="0" aria-label="History"><h3>üìã History</h3></div>
        <div class="menu-card" draggable="true" data-menu-id="dilution" role="button" tabindex="0" aria-label="Dilution Chart"><h3>üìä Dilution Chart</h3></div>
        <div class="menu-card" draggable="true" data-menu-id="aircraft" role="button" tabindex="0" aria-label="Aircraft Reference"><h3>‚úàÔ∏è Aircraft Reference</h3></div>
        <div class="menu-card" draggable="true" data-menu-id="airlines" role="button" tabindex="0" aria-label="Airline Codes"><h3>üõ´ Airline Codes</h3></div>
        <div class="menu-card" draggable="true" data-menu-id="pdfs" role="button" tabindex="0" aria-label="Documents & Links"><h3>üìÑ Documents & Links</h3></div>
        <div class="menu-card" draggable="true" data-menu-id="notes" role="button" tabindex="0" aria-label="Notes"><h3>üìù Notes</h3></div>
      </div>
    </div>

    <!-- INCREASE -->
    <div class="page" id="increase">
      <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h2 style="margin:0;">Increase Mix</h2>
          <button onclick="clearCalculator('increase')" style="background:#ef4444;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">Clear</button>
        </div>
        <input type="number" inputmode="decimal" id="inc-cur" placeholder="Current Mix %" oninput="calcInc()" aria-label="Current mix percentage" min="0" max="100">
        <input type="number" inputmode="decimal" id="inc-des" placeholder="Desired Mix %" oninput="calcInc()" aria-label="Desired mix percentage" min="0" max="100">
        <input type="number" inputmode="decimal" id="inc-vol" placeholder="Current Volume" oninput="calcInc()" aria-label="Current volume in gallons" min="0">
        <div id="inc-result"></div>
      </div>
    </div>

    <!-- DECREASE -->
    <div class="page" id="decrease">
      <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h2 style="margin:0;">Decrease Mix</h2>
          <button onclick="clearCalculator('decrease')" style="background:#ef4444;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">Clear</button>
        </div>
        <input type="number" inputmode="decimal" id="dec-cur" placeholder="Current Mix %" oninput="calcDec()" aria-label="Current mix percentage" min="0" max="100">
        <input type="number" inputmode="decimal" id="dec-des" placeholder="Desired Mix %" oninput="calcDec()" aria-label="Desired mix percentage" min="0" max="100">
        <input type="number" inputmode="decimal" id="dec-vol" placeholder="Current Volume" oninput="calcDec()" aria-label="Current volume in gallons" min="0">
        <div id="dec-result"></div>
      </div>
    </div>

    <!-- VOLUME -->
    <div class="page" id="volume">
      <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h2 style="margin:0;">Increase Volume</h2>
          <button onclick="clearCalculator('volume')" style="background:#ef4444;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">Clear</button>
        </div>

        <div style="background:#f0f9ff;border-left:4px solid #0ea5e9;padding:12px;border-radius:8px;margin-bottom:16px;font-size:13px;">
          <strong>Current Mix:</strong> Enter either percentage OR freeze point
        </div>

        <input type="number" inputmode="decimal" id="vol-cur" placeholder="Current Mix %" oninput="handleVolCurInput()" aria-label="Current mix percentage" min="0" max="100">
        <input type="number" id="vol-cur-freeze" placeholder="OR Current Freeze Point (¬∞C)" oninput="handleVolCurFreezeInput()" aria-label="Current freeze point in Celsius" max="0">

        <input type="number" inputmode="decimal" id="vol-curv" placeholder="Current Volume" oninput="calcVol()" aria-label="Current volume in gallons" min="0">

        <div style="background:#f0f9ff;border-left:4px solid #0ea5e9;padding:12px;border-radius:8px;margin-bottom:16px;font-size:13px;">
          <strong>Wanted Mix:</strong> Enter either percentage OR freeze point
        </div>

        <input type="number" inputmode="decimal" id="vol-want" placeholder="Wanted Mix %" oninput="handleVolWantInput()" aria-label="Wanted mix percentage" min="0" max="100">
        <input type="number" id="vol-want-freeze" placeholder="OR Wanted Freeze Point (¬∞C)" oninput="handleVolWantFreezeInput()" aria-label="Wanted freeze point in Celsius" max="0">

        <input type="number" inputmode="decimal" id="vol-wantv" placeholder="Wanted Volume" oninput="calcVol()" aria-label="Wanted volume in gallons" min="0">

        <div id="vol-result"></div>
      </div>
    </div>

    <!-- BATCH -->
    <div class="page" id="batch">
      <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h2 style="margin:0;">Batch Trucks</h2>
          <button onclick="clearBatchData()" style="background:#ef4444;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">Clear</button>
        </div>

        <div style="background:#f0f9ff;border-left:4px solid #0ea5e9;padding:12px;border-radius:8px;margin-bottom:16px;">
          <div style="font-weight:700;margin-bottom:8px;color:#0369a1;">Select Processing Mode:</div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
            <button class="btn-mode active" onclick="setBatchMode('increase-volume', this)">Increase Volume</button>
            <button class="btn-mode" onclick="setBatchMode('increase-mix', this)">Increase Mix</button>
            <button class="btn-mode" onclick="setBatchMode('decrease-mix', this)">Decrease Mix</button>
          </div>
        </div>

        <button class="btn-primary" onclick="importFromSheets()">üìä Import from Google Sheets</button>

        <div style="text-align:center;margin:16px 0;color:#9ca3af;font-size:14px;">OR</div>

        <textarea id="batch-input" rows="8" placeholder="Enter truck data (one per line):
Truck 1, 500, -30
Truck 2, 450, 45%
Truck 3, 600, -25

Format: Truck ID, Total Gallons, Freeze Point (¬∞C) OR Percentage"
          style="font-family:'Courier New', monospace;font-size:13px;"
          oninput="saveBatchInputs()"></textarea>

        <div style="background:#f0f9ff;border-left:4px solid #0ea5e9;padding:12px;border-radius:8px;margin-bottom:16px;font-size:13px;">
          <strong>Wanted Mix:</strong> Enter either percentage OR freeze point
        </div>

        <input type="number" inputmode="decimal" id="batch-want-pct" placeholder="Wanted Mix %" aria-label="Wanted mix percentage" min="0" max="100" oninput="saveBatchInputs()">
        <input type="number" id="batch-want-freeze" placeholder="OR Wanted Freeze Point (¬∞C)" aria-label="Wanted freeze point in Celsius" max="0" oninput="saveBatchInputs()">

        <div id="batch-volume-field">
          <input type="number" inputmode="decimal" id="batch-want-vol" placeholder="Wanted Volume (gallons)" aria-label="Wanted volume in gallons" min="0" oninput="saveBatchInputs()">

          <div style="margin-top:10px;background:rgba(14,165,233,0.08);border:2px solid rgba(186,230,253,0.8);padding:12px;border-radius:10px;">
            <label style="display:flex;gap:10px;align-items:flex-start;cursor:pointer;">
              <input type="checkbox" id="batch-use-topoff" style="width:auto;margin:2px 0 0 0;" onchange="handleBatchTopOffToggle()">
              <span style="font-size:13px;color:#0369a1;line-height:1.4;">
                <strong>Use gallons-from-top</strong> (auto target volume)<br>
                Uses max capacity by truck ID:
                <span style="color:#6b7280;">900‚Äì3026 = 1900 gal</span>,
                <span style="color:#6b7280;">7000‚Äì7017 = 1850 gal</span>
              </span>
            </label>

            <div id="batch-topoff-field" style="display:none;margin-top:10px;">
              <input type="number" inputmode="decimal" id="batch-gallons-from-top"
                     placeholder="Gallons from top (e.g., 200)"
                     aria-label="Gallons from top"
                     min="0" step="1"
                     oninput="saveBatchInputs()">
              <div style="font-size:12px;color:#6b7280;margin-top:6px;">
                Example: If gallons-from-top = 200, targets are 1700 (1900-cap) or 1650 (1850-cap)
              </div>
            </div>
          </div>
        </div>

        <button class="btn-secondary" onclick="processBatch()">üöÄ Process All Trucks</button>

        <div id="batch-sort-controls" style="display:none;margin-top:20px;background:rgba(255,255,255,0.9);border-radius:12px;padding:16px;border:2px solid #e5e7eb;">
          <div style="font-weight:700;color:#0369a1;margin-bottom:12px;font-size:14px;">üìä Sort & Filter Results:</div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
            <button class="sort-btn active" onclick="sortBatchResults('default', this)" style="padding:8px;border:2px solid #0ea5e9;background:#0ea5e9;color:white;border-radius:8px;cursor:pointer;font-size:13px;font-weight:700;">Default Order</button>
            <button class="sort-btn" onclick="sortBatchResults('pump-out', this)" style="padding:8px;border:2px solid #e5e7eb;background:white;color:#0369a1;border-radius:8px;cursor:pointer;font-size:13px;font-weight:700;">Pump-Out First</button>
            <button class="sort-btn" onclick="sortBatchResults('water-only', this)" style="padding:8px;border:2px solid #e5e7eb;background:white;color:#0369a1;border-radius:8px;cursor:pointer;font-size:13px;font-weight:700;">Water Only</button>
            <button class="sort-btn" onclick="sortBatchResults('glycol-only', this)" style="padding:8px;border:2px solid #e5e7eb;background:white;color:#0369a1;border-radius:8px;cursor:pointer;font-size:13px;font-weight:700;">Glycol Only</button>
            <button class="sort-btn" onclick="sortBatchResults('mixed', this)" style="padding:8px;border:2px solid #e5e7eb;background:white;color:#0369a1;border-radius:8px;cursor:pointer;font-size:13px;font-weight:700;">Mixed Fluid</button>
            <button class="sort-btn" onclick="sortBatchResults('largest-diff', this)" style="padding:8px;border:2px solid #e5e7eb;background:white;color:#0369a1;border-radius:8px;cursor:pointer;font-size:13px;font-weight:700;">Largest % Diff</button>
          </div>
        </div>

        <div id="batch-results" style="margin-top:20px;"></div>
      </div>
    </div>

    <!-- TOTE -->
    <div class="page" id="tote">
      <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h2 style="margin:0;">Tote to Truck</h2>
          <button onclick="clearCalculator('tote')" style="background:#ef4444;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">Clear</button>
        </div>
        <input type="number" inputmode="decimal" id="tote-tm" placeholder="Truck Mix %" oninput="calcTote()" aria-label="Truck mix percentage" min="0" max="100">
        <input type="number" inputmode="decimal" id="tote-tv" placeholder="Truck Volume" oninput="calcTote()" aria-label="Truck volume in gallons" min="0">
        <input type="number" inputmode="decimal" id="tote-ttm" placeholder="Tote Mix %" oninput="calcTote()" aria-label="Tote mix percentage" min="0" max="100">
        <input type="number" inputmode="decimal" id="tote-ttv" placeholder="Tote Volume" oninput="calcTote()" aria-label="Tote volume in gallons" min="0">
        <div id="tote-result"></div>
      </div>
    </div>

    <!-- TRUCKBOARD DISPLAY -->
    <div class="page" id="truckboard" style="position:fixed;top:0;left:0;right:0;bottom:0;padding:0;margin:0;background:white;z-index:1000;">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:linear-gradient(135deg,#e0f2fe 0%,#bae6fd 50%,#7dd3fc 100%);">
        <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu" style="margin:0;">‚Üê Back</button>
        <div style="font-size:11px;color:#6b7280;">Last refreshed: <span id="truckboard-time">--</span></div>
        <button class="refresh-btn" onclick="refreshTruckBoard()" style="margin:0;">üîÑ Refresh</button>
      </div>
      <div class="iframe-container" style="height:calc(100vh - 50px);border-radius:0;border:none;margin:0;">
        <iframe id="truckboard-iframe"
          src="https://script.google.com/macros/s/AKfycbwLAeS6nUomVV8IwKqNZ76DwpRq1JFGHsG010-Z51blqkWmebGVAs8bm7B-MzlbPKkhbA/exec?page=display"
          title="Truck Board Display" onload="updateTruckBoardTime()"></iframe>
      </div>
    </div>

    <!-- TRUCKBOARD EDIT -->
    <div class="page" id="truckboard-edit">
      <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
      <div class="card">
        <h2 style="margin-bottom:16px;">Edit Truck Board</h2>

        <div style="background:#f0f9ff;border-left:4px solid #0ea5e9;padding:12px;border-radius:8px;margin-bottom:16px;font-size:13px;">
          üí° <strong>Tip:</strong> Select a truck to view its current data before editing
        </div>

        <label style="display:block;font-weight:700;margin-bottom:8px;color:#0369a1;">Select Truck:</label>
        <select id="truck-select" onchange="loadTruckData()" style="cursor:pointer;">
          <option value="">-- Select a Truck --</option>
        </select>

        <div id="current-truck-data" style="display:none;background:linear-gradient(135deg,#0ea5e9 0%,#0284c7 100%);color:white;padding:16px;border-radius:12px;margin-bottom:16px;">
          <div style="font-weight:800;font-size:16px;margin-bottom:12px;border-bottom:2px solid rgba(255,255,255,0.3);padding-bottom:8px;">
            Current Data for <span id="current-truck-id"></span>
          </div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;font-size:14px;">
            <div><div style="opacity:.9;font-size:12px;margin-bottom:4px;">Percent:</div><div style="font-weight:800;font-size:18px;" id="current-percent">--</div></div>
            <div><div style="opacity:.9;font-size:12px;margin-bottom:4px;">Freeze Point:</div><div style="font-weight:800;font-size:18px;" id="current-freeze">--</div></div>
            <div><div style="opacity:.9;font-size:12px;margin-bottom:4px;">Type I (gal):</div><div style="font-weight:800;font-size:18px;" id="current-typei">--</div></div>
            <div><div style="opacity:.9;font-size:12px;margin-bottom:4px;">Type IV (gal):</div><div style="font-weight:800;font-size:18px;" id="current-typeiv">--</div></div>
          </div>
        </div>

        <div style="width:100%;height:75vh;border:2px solid #e5e7eb;border-radius:10px;overflow:hidden;background:white;">
          <iframe src="https://tb.kpiticeman.com/" title="Truck Board Editor" style="width:100%;height:100%;border:none;"></iframe>
        </div>
        <a href="https://tb.kpiticeman.com/" target="_blank" class="external-link-btn">Open Editor in New Tab</a>
      </div>
    </div>

    <!-- ATIS -->
    <div class="page" id="atis">
      <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
      <div class="card">
        <h2>ATIS & Weather</h2>
        <button class="refresh-btn" onclick="loadATIS()">üîÑ Refresh Data</button>

        <div class="info-box" id="atis-info-box" style="display:none;">
          <div class="info-label">ATIS Information</div>
          <div class="info-value" id="atis-letter" style="font-size:20px;">--</div>
        </div>

        <div class="info-box">
          <div class="info-label">Temperature (KPIT)</div>
          <div class="info-value" id="temperature">Loading...</div>
        </div>

        <div class="info-box">
          <div class="info-label">Dew Point (KPIT)</div>
          <div class="info-value" id="dewpoint">Loading...</div>
        </div>

        <div class="info-box">
          <div class="info-label">Wind</div>
          <div class="info-value" id="wind">Loading...</div>

          <div id="wind-compass" style="margin-top:16px;display:none;">
            <svg width="200" height="200" viewBox="0 0 200 200" style="margin:0 auto;display:block;">
              <circle cx="100" cy="100" r="90" fill="#f0f9ff" stroke="#0ea5e9" stroke-width="2"/>
              <text x="100" y="25" text-anchor="middle" font-size="20" font-weight="bold" fill="#0369a1">N</text>
              <text x="175" y="105" text-anchor="middle" font-size="20" font-weight="bold" fill="#0369a1">E</text>
              <text x="100" y="185" text-anchor="middle" font-size="20" font-weight="bold" fill="#0369a1">S</text>
              <text x="25" y="105" text-anchor="middle" font-size="20" font-weight="bold" fill="#0369a1">W</text>

              <line x1="100" y1="15" x2="100" y2="25" stroke="#6b7280" stroke-width="2"/>
              <line x1="190" y1="100" x2="180" y2="100" stroke="#6b7280" stroke-width="2"/>
              <line x1="100" y1="185" x2="100" y2="175" stroke="#6b7280" stroke-width="2"/>
              <line x1="10" y1="100" x2="20" y2="100" stroke="#6b7280" stroke-width="2"/>

              <g id="wind-arrow" transform="rotate(0 100 100)">
                <line x1="100" y1="100" x2="100" y2="20" stroke="#ef4444" stroke-width="6" stroke-linecap="round"/>
                <polygon points="100,10 88,38 100,30 112,38" fill="#ef4444"/>
                <circle cx="100" cy="100" r="10" fill="#ef4444"/>
              </g>
            </svg>

            <div style="text-align:center;margin-top:8px;font-size:14px;color:#0369a1;font-weight:700;">
              Wind from <span id="wind-direction-text">---</span>¬∞
            </div>
          </div>
        </div>

        <div class="info-box" id="precip-box" style="display:none;">
          <div class="info-label">Precipitation</div>
          <div class="info-value" id="precipitation">None</div>
        </div>

        <h3 style="margin-top:20px;margin-bottom:10px;color:#0369a1;">Full METAR</h3>
        <div class="metar-box" id="metar-full">Loading...</div>

        <div style="font-size:12px;color:#6b7280;margin-top:8px;">
          <div style="font-style:italic;margin-bottom:4px;">METAR observed: <span id="metar-observed">--</span></div>
          <div style="font-style:italic;">Last checked: <span id="metar-time">--</span></div>
        </div>
      </div>

      <a href="https://ids6.pitairport.com/IDS5Status/?recover=dXNlcj1BT1VTRVImcHc9QU9QVw" target="_blank" class="external-link-btn">üì° View Full ATIS Display</a>

      <div style="margin-top:12px;">
        <p style="color:#6b7280;font-size:13px;margin-bottom:8px;">Additional Weather Sources:</p>
        <a href="https://forecast.weather.gov/MapClick.php?lat=40.49608000000006&lon=-80.25546999999995" target="_blank" class="external-link-btn" style="background:#0ea5e9;margin-bottom:8px;display:block;text-align:center;">üå§Ô∏è National Weather Service - KPIT</a>
        <a href="https://www.accuweather.com/en/us/pittsburgh-international-airport/15231/weather-forecast/2630488" target="_blank" class="external-link-btn" style="background:#0ea5e9;margin-bottom:8px;display:block;text-align:center;">üå°Ô∏è AccuWeather - KPIT</a>
      </div>
    </div>

    <!-- HISTORY -->
    <div class="page" id="history">
      <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
      <div class="card">
        <h2>History</h2>
        <div id="history-list"></div>
        <button onclick="clearHistory()" style="background:#ef4444;color:white;border:none;padding:10px 20px;border-radius:8px;margin-top:12px;cursor:pointer;" aria-label="Clear all history">Clear All</button>
      </div>
    </div>

    <!-- DILUTION -->
    <div class="page" id="dilution">
      <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
      <div class="card">
        <h2>Dilution Chart</h2>
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr><th>Dilution</th><th>Refractive Index</th><th>Freeze Point</th><th>LOUT</th></tr>
            </thead>
            <tbody id="dilution-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- AIRCRAFT -->
    <div class="page" id="aircraft">
      <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
      <div class="card">
        <h2>Aircraft Reference</h2>
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr><th>Carrier</th><th>Broom</th><th>Hoar</th><th>Type IV</th><th>Specifics</th></tr>
            </thead>
            <tbody id="aircraft-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- AIRLINES -->
    <div class="page" id="airlines">
      <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
      <div class="card">
        <h2>Airline Codes</h2>
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr><th>Airline</th><th>Parent</th><th>Call Sign</th><th>Code</th></tr>
            </thead>
            <tbody id="airlines-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- PDFS -->
    <div class="page" id="pdfs">
      <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
      <div class="card">
        <h2>Documents & Links</h2>
        <div id="pdf-list"></div>
      </div>
    </div>

    <!-- NOTES -->
    <div class="page" id="notes">
      <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
      <div class="card">
        <h2>Notes</h2>
        <textarea id="notes-area" rows="15" placeholder="Type notes..." oninput="saveNotes()" aria-label="Field notes text area"></textarea>
        <div id="notes-status" style="color:#9ca3af;font-size:13px;">Auto-saved</div>
      </div>
    </div>

  </div>

  <script>
    // Google Sheets Configuration
    const SHEETS_ID = '141e9AEoD3aluTHDRsyoTrIJHekM9Q5JGGANWfoCr_pY';

    // ========== MENU LOCK ==========
    let menuLocked = false;

    function initMenuLock(){
      const saved = localStorage.getItem('menuLocked');
      menuLocked = saved === 'true';
      updateLockButton();
    }

    function toggleMenuLock(){
      menuLocked = !menuLocked;
      localStorage.setItem('menuLocked', String(menuLocked));
      updateLockButton();
    }

    function updateLockButton(){
      const btn = document.getElementById('lock-btn');
      if(!btn) return;
      if(menuLocked){
        btn.classList.add('locked');
        btn.textContent = 'üîí';
        btn.setAttribute('aria-label','Menu locked');
      }else{
        btn.classList.remove('locked');
        btn.textContent = 'üîì';
        btn.setAttribute('aria-label','Menu unlocked');
      }
    }

    // ========== NAV / PAGE STATE ==========
    function showPage(p) {
      document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
      const page = document.getElementById(p);
      if(page) page.classList.add('active');

      saveCurrentPage(p);

      if(p==='notes') loadNotes();
      if(p==='history') displayHistory();
      if(p==='dilution') loadDilution();
      if(p==='aircraft') loadAircraft();
      if(p==='airlines') loadAirlines();
      if(p==='pdfs') loadPdfs();
      if(p==='atis') loadATIS();
      if(p==='truckboard-edit') loadTruckList();
      if(p==='batch') restoreBatchPage();

      restorePageInputs(p);
    }

    function saveCurrentPage(pageId){ localStorage.setItem('currentPage', pageId); }

    function restoreLastPage(){
      const saved = localStorage.getItem('currentPage');
      if(saved && document.getElementById(saved)) showPage(saved);
    }

    function saveInput(pageId, inputId, value) {
      const key = `input_${pageId}_${inputId}`;
      localStorage.setItem(key, value);
    }

    function restorePageInputs(pageId) {
      const page = document.getElementById(pageId);
      if (!page) return;

      page.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
        const key = `input_${pageId}_${input.id}`;
        const savedValue = localStorage.getItem(key);
        if (savedValue !== null) input.value = savedValue;
      });

      page.querySelectorAll('input[type="checkbox"]').forEach(input => {
        const key = `input_${pageId}_${input.id}`;
        const savedValue = localStorage.getItem(key);
        if (savedValue !== null) input.checked = savedValue === 'true';
      });

      if (pageId === 'increase' && document.getElementById('inc-cur').value) calcInc();
      else if (pageId === 'decrease' && document.getElementById('dec-cur').value) calcDec();
      else if (pageId === 'volume' && document.getElementById('vol-cur').value) calcVol();
      else if (pageId === 'tote' && document.getElementById('tote-tm').value) calcTote();
    }

    function clearCalculator(pageId) {
      const page = document.getElementById(pageId);
      if (!page) return;

      page.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
        input.value = '';
        const key = `input_${pageId}_${input.id}`;
        localStorage.removeItem(key);
      });

      page.querySelectorAll('input[type="checkbox"]').forEach(input => {
        input.checked = false;
        const key = `input_${pageId}_${input.id}`;
        localStorage.removeItem(key);
      });

      if (pageId === 'increase') document.getElementById('inc-result').innerHTML = '';
      else if (pageId === 'decrease') document.getElementById('dec-result').innerHTML = '';
      else if (pageId === 'volume') document.getElementById('vol-result').innerHTML = '';
      else if (pageId === 'tote') document.getElementById('tote-result').innerHTML = '';
    }

    function validateInput(value, name, min = 0, max = null) {
      if (isNaN(value) || value < min) return { valid: false, message: `${name} must be at least ${min}` };
      if (max !== null && value > max) return { valid: false, message: `${name} cannot exceed ${max}` };
      return { valid: true };
    }

    // ========== SERVICE WORKER UPDATE ==========
    if('serviceWorker' in navigator){
      window.addEventListener('load',()=>{
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg=>{ console.log('Service Worker registered'); reg.update(); })
          .catch(e=>console.log('SW registration failed:',e));
      });
    }

    function updateApp(){
      if('serviceWorker' in navigator){
        navigator.serviceWorker.getRegistration().then(reg=>{
          if(reg && reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'});
          caches.keys().then(names => Promise.all(names.map(n => caches.delete(n))))
            .then(()=>window.location.reload(true));
        });
      }else{
        window.location.reload(true);
      }
    }

    // ========== BATCH MODE ==========
    let currentBatchMode = 'increase-volume';
    let batchResultsData = [];

    function setBatchMode(mode, btnEl) {
      currentBatchMode = mode;

      document.querySelectorAll('.btn-mode').forEach(btn => btn.classList.remove('active'));
      if(btnEl) btnEl.classList.add('active');

      const volumeField = document.getElementById('batch-volume-field');
      volumeField.style.display = (mode === 'increase-volume') ? 'block' : 'none';

      localStorage.setItem('batchMode', mode);

      document.getElementById('batch-results').innerHTML = '';
      document.getElementById('batch-sort-controls').style.display = 'none';

      saveBatchInputs();
    }

    function saveBatchInputs() {
      const batchData = {
        mode: currentBatchMode,
        input: document.getElementById('batch-input')?.value || '',
        wantPct: document.getElementById('batch-want-pct')?.value || '',
        wantFreeze: document.getElementById('batch-want-freeze')?.value || '',
        wantVol: document.getElementById('batch-want-vol')?.value || '',
        useTopOff: document.getElementById('batch-use-topoff')?.checked || false,
        gallonsFromTop: document.getElementById('batch-gallons-from-top')?.value || ''
      };
      localStorage.setItem('batchInputs', JSON.stringify(batchData));
    }

    function saveBatchResults() {
      if (batchResultsData && batchResultsData.length > 0) {
        localStorage.setItem('batchResults', JSON.stringify({
          results: batchResultsData,
          timestamp: new Date().toISOString()
        }));
      }
    }

    function restoreBatchPage() {
      const savedMode = localStorage.getItem('batchMode');
      if (savedMode) {
        currentBatchMode = savedMode;

        const volumeField = document.getElementById('batch-volume-field');
        volumeField.style.display = savedMode === 'increase-volume' ? 'block' : 'none';

        document.querySelectorAll('.btn-mode').forEach(btn => btn.classList.remove('active'));
        const map = {
          'increase-volume': 'Increase Volume',
          'increase-mix': 'Increase Mix',
          'decrease-mix': 'Decrease Mix'
        };
        document.querySelectorAll('.btn-mode').forEach(btn => {
          if (btn.textContent.trim() === map[savedMode]) btn.classList.add('active');
        });
      }

      const savedInputs = localStorage.getItem('batchInputs');
      if (savedInputs) {
        try {
          const batchData = JSON.parse(savedInputs);
          document.getElementById('batch-input').value = batchData.input || '';
          document.getElementById('batch-want-pct').value = batchData.wantPct || '';
          document.getElementById('batch-want-freeze').value = batchData.wantFreeze || '';
          document.getElementById('batch-want-vol').value = batchData.wantVol || '';

          const cb = document.getElementById('batch-use-topoff');
          const gft = document.getElementById('batch-gallons-from-top');
          if (cb) cb.checked = !!batchData.useTopOff;
          if (gft) gft.value = batchData.gallonsFromTop || '';

          handleBatchTopOffToggle();
        } catch (e) {
          console.error('Error restoring batch inputs:', e);
        }
      }

      const savedResults = localStorage.getItem('batchResults');
      if (savedResults) {
        try {
          const resultsData = JSON.parse(savedResults);
          batchResultsData = resultsData.results || [];

          if (batchResultsData.length) {
            const wantedMix = batchResultsData[0]?.wantedMix || 0;
            const wantedVol = batchResultsData[0]?.wantedVolume || null;

            displayBatchResults(batchResultsData, wantedMix, wantedVol);

            const timestamp = new Date(resultsData.timestamp);
            const resultsDiv = document.getElementById('batch-results');
            const t = document.createElement('div');
            t.style.cssText = 'text-align:center;color:#6b7280;font-size:12px;margin-top:16px;padding:12px;background:rgba(156,163,175,0.1);border-radius:8px;font-style:italic;';
            t.innerHTML = `üìÖ Previous results from: ${timestamp.toLocaleString()}<br><span style="font-size:11px;color:#9ca3af;">Process trucks again to update</span>`;
            resultsDiv.appendChild(t);
          }
        } catch (e) {
          console.error('Error restoring batch results:', e);
        }
      }
    }

    function clearBatchData() {
      if (!confirm('Clear all batch truck data and results?\n\nThis will erase:\n‚Ä¢ Input data\n‚Ä¢ Mode selection\n‚Ä¢ Calculated results')) return;

      localStorage.removeItem('batchMode');
      localStorage.removeItem('batchInputs');
      localStorage.removeItem('batchResults');

      currentBatchMode = 'increase-volume';
      document.getElementById('batch-input').value = '';
      document.getElementById('batch-want-pct').value = '';
      document.getElementById('batch-want-freeze').value = '';
      document.getElementById('batch-want-vol').value = '';

      const cb = document.getElementById('batch-use-topoff');
      const gft = document.getElementById('batch-gallons-from-top');
      if (cb) cb.checked = false;
      if (gft) gft.value = '';
      handleBatchTopOffToggle();

      document.getElementById('batch-results').innerHTML = '<div style="background:#d1fae5;color:#065f46;padding:16px;border-radius:8px;text-align:center;font-weight:800;">‚úì All batch data cleared</div>';
      document.getElementById('batch-sort-controls').style.display = 'none';
      batchResultsData = [];

      document.querySelectorAll('.btn-mode').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.btn-mode')[0]?.classList.add('active');
      document.getElementById('batch-volume-field').style.display = 'block';
    }

    // ========== TOP-OFF / MAX-CAPACITY ==========
    function getTruckMaxCapacity(truckId) {
      const match = String(truckId).match(/\d+/);
      const n = match ? parseInt(match[0], 10) : NaN;
      if (!isNaN(n)) {
        if (n >= 900 && n <= 3026) return 1900;
        if (n >= 7000 && n <= 7017) return 1850;
      }
      return 1900;
    }

    function handleBatchTopOffToggle() {
      const cb = document.getElementById('batch-use-topoff');
      const field = document.getElementById('batch-topoff-field');
      const wantVolInput = document.getElementById('batch-want-vol');
      if (!cb || !field) return;

      const enabled = cb.checked;
      field.style.display = enabled ? 'block' : 'none';

      if (wantVolInput) {
        wantVolInput.disabled = enabled;
        wantVolInput.style.opacity = enabled ? '0.6' : '1';
      }

      saveBatchInputs();
    }

    // ========== IMPORT ==========
    async function importFromSheets() {
      const resultsDiv = document.getElementById('batch-results');
      resultsDiv.innerHTML = '<div class="loading">üì• Loading data from Google Sheets...</div>';

      try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEETS_ID}/gviz/tq?tqx=out:csv`;
        const response = await fetch(url);
        const csvText = await response.text();

        const lines = csvText.trim().split('\n');
        const dataLines = lines.slice(1);

        let importedData = '';
        dataLines.forEach(line => {
          const values = line.replace(/"/g, '').split(',');
          if (values.length >= 7 && values[0].trim()) {
            const truckId = values[0].trim();
            let totalVolume = values[5].trim();

            if (totalVolume.length <= 2 && values[6] && values[6].match(/^\d{3}/)) {
              totalVolume = totalVolume + values[6].substring(0, 3);
            }

            const currentPercent = values[1].trim();
            importedData += `${truckId}, ${totalVolume}, ${currentPercent}%\n`;
          }
        });

        document.getElementById('batch-input').value = importedData.trim();
        saveBatchInputs();

        resultsDiv.innerHTML = '<div style="background:#d1fae5;color:#065f46;padding:12px;border-radius:8px;text-align:center;font-weight:800;">‚úì Data imported successfully! Now enter wanted mix and volume, then click "Process All Trucks"</div>';
      } catch (error) {
        console.error('Import error:', error);
        resultsDiv.innerHTML = `<div class="error-message">
          <strong>Import Failed</strong><br>
          Unable to import from Google Sheets. Please make sure the spreadsheet is publicly accessible or enter data manually.<br><br>
          <small>Error: ${error.message}</small>
        </div>`;
      }
    }

    // ========== MIX CALCS (Increase/Decrease Mix modes) ==========
    function calculateIncreaseMix(truckId, curMix, curVol, wantMix) {
      try {
        const validations = [
          validateInput(curMix, 'Current mix', 0, 100),
          validateInput(wantMix, 'Wanted mix', 0, 100),
          validateInput(curVol, 'Current volume', 0.1)
        ];
        for (let v of validations) if (!v.valid) return { truckId, success:false, error:v.message };
        if (wantMix <= curMix) return { truckId, success:false, error:'Wanted mix must be greater than current mix for Increase Mix mode' };

        const glycolToAdd = curVol * ((wantMix - curMix) / (100 - wantMix));
        const newTotalVolume = curVol + glycolToAdd;

        return {
          truckId, success:true,
          currentMix:curMix, currentVolume:curVol,
          wantedMix:wantMix, wantedVolume:newTotalVolume,
          percentToAdd:100,
          volumeToAdd:glycolToAdd,
          typeIToAdd:glycolToAdd,
          waterToAdd:0,
          pumpOutAmount:0,
          pumpOutMode:null
        };
      } catch (e) {
        return { truckId, success:false, error:e.message };
      }
    }

    function calculateDecreaseMix(truckId, curMix, curVol, wantMix) {
      try {
        const validations = [
          validateInput(curMix, 'Current mix', 0, 100),
          validateInput(wantMix, 'Wanted mix', 0, 100),
          validateInput(curVol, 'Current volume', 0.1)
        ];
        for (let v of validations) if (!v.valid) return { truckId, success:false, error:v.message };
        if (wantMix >= curMix) return { truckId, success:false, error:'Wanted mix must be less than current mix for Decrease Mix mode' };
        if (wantMix === 0) return { truckId, success:false, error:'Wanted mix cannot be zero' };

        const waterToAdd = curVol * ((curMix - wantMix) / wantMix);
        const newTotalVolume = curVol + waterToAdd;

        return {
          truckId, success:true,
          currentMix:curMix, currentVolume:curVol,
          wantedMix:wantMix, wantedVolume:newTotalVolume,
          percentToAdd:0,
          volumeToAdd:waterToAdd,
          typeIToAdd:0,
          waterToAdd:waterToAdd,
          pumpOutAmount:0,
          pumpOutMode:null
        };
      } catch (e) {
        return { truckId, success:false, error:e.message };
      }
    }

    // ========== PROCESS BATCH ==========
    function processBatch() {
      const input = document.getElementById('batch-input').value.trim();
      const wantPct = document.getElementById('batch-want-pct').value;
      const wantFreeze = document.getElementById('batch-want-freeze').value;
      const resultsDiv = document.getElementById('batch-results');

      if (!input) {
        resultsDiv.innerHTML = '<div class="error-message">Please enter truck data or import from Google Sheets</div>';
        return;
      }

      if (!wantPct && !wantFreeze) {
        resultsDiv.innerHTML = '<div class="error-message">Please enter wanted mix (percentage or freeze point)</div>';
        return;
      }

      if (currentBatchMode === 'increase-volume') {
        const useTopOff = document.getElementById('batch-use-topoff')?.checked || false;
        if (useTopOff) {
          const gftRaw = document.getElementById('batch-gallons-from-top')?.value;
          const gallonsFromTop = parseFloat(gftRaw);
          if (gftRaw === '' || isNaN(gallonsFromTop) || gallonsFromTop < 0) {
            resultsDiv.innerHTML = '<div class="error-message">Please enter a valid "Gallons from top" (0 or greater)</div>';
            return;
          }
        } else {
          const manualWantVol = parseFloat(document.getElementById('batch-want-vol').value);
          if (!manualWantVol) {
            resultsDiv.innerHTML = '<div class="error-message">Please enter wanted volume for Increase Volume mode (or enable gallons-from-top)</div>';
            return;
          }
        }
      }

      let wantedMixPct = wantPct ? parseFloat(wantPct) : freezePointToPercentage(parseFloat(wantFreeze));

      const lines = input.split('\n');
      const trucks = [];

      lines.forEach(line => {
        const parts = line.split(',').map(s => s.trim());
        if (parts.length >= 3) {
          const truckId = parts[0];
          const currentVolume = parseFloat(parts[1]);
          const freezeOrPct = parts[2];

          let currentMixPct;
          if (freezeOrPct.includes('%')) currentMixPct = parseFloat(freezeOrPct.replace('%', ''));
          else if (freezeOrPct.includes('-')) currentMixPct = freezePointToPercentage(parseFloat(freezeOrPct));
          else currentMixPct = parseFloat(freezeOrPct);

          if (!isNaN(currentVolume) && !isNaN(currentMixPct)) {
            trucks.push({
              id: truckId,
              currentMixPct,
              currentVolume,
              typeIGallons: currentVolume * (currentMixPct / 100)
            });
          }
        }
      });

      if (!trucks.length) {
        resultsDiv.innerHTML = '<div class="error-message">No valid truck data found. Please check your input format.</div>';
        return;
      }

      let results;

      if (currentBatchMode === 'increase-mix') {
        results = trucks.map(t => calculateIncreaseMix(t.id, t.currentMixPct, t.currentVolume, wantedMixPct));
      } else if (currentBatchMode === 'decrease-mix') {
        results = trucks.map(t => calculateDecreaseMix(t.id, t.currentMixPct, t.currentVolume, wantedMixPct));
      } else {
        const useTopOff = document.getElementById('batch-use-topoff')?.checked || false;
        const gallonsFromTop = useTopOff ? parseFloat(document.getElementById('batch-gallons-from-top')?.value) : null;
        const manualWantVol = parseFloat(document.getElementById('batch-want-vol').value);

        results = trucks.map(truck => {
          let targetVol = manualWantVol;

          if (useTopOff) {
            const maxCap = getTruckMaxCapacity(truck.id);
            targetVol = maxCap - gallonsFromTop;
          }

          if (!targetVol || isNaN(targetVol) || targetVol <= 0) {
            return { truckId: truck.id, success:false, error:`Invalid target volume calculated for ${truck.id}. Check gallons-from-top value.` };
          }

          return calculateTruckMix(truck.id, truck.currentMixPct, truck.currentVolume, wantedMixPct, targetVol, true);
        });
      }

      const useTopOff = document.getElementById('batch-use-topoff')?.checked || false;
      displayBatchResults(
        results,
        wantedMixPct,
        (currentBatchMode === 'increase-volume' && !useTopOff) ? parseFloat(document.getElementById('batch-want-vol').value) : null
      );

      saveBatchInputs();
      saveBatchResults();

      results.forEach(r => {
        if (r.success) {
          saveToHistory('Batch', {
            truckId: r.truckId,
            mode: currentBatchMode,
            curMix: r.currentMix.toFixed(1),
            curVol: r.currentVolume.toFixed(0),
            wantMix: r.wantedMix.toFixed(1),
            wantVol: r.wantedVolume || r.currentVolume,
            vol: Math.round(r.volumeToAdd),
            pct: r.percentToAdd ? r.percentToAdd.toFixed(0) : 'N/A',
            water: Math.round(r.waterToAdd || 0),
            typeI: Math.round(r.typeIToAdd || 0),
            pumpOut: r.pumpOutAmount ? r.pumpOutAmount.toFixed(0) : 0
          });
        }
      });
    }

    // ========== CORE TRUCK MIX CALC ==========
    function calculateTruckMix(truckId, curMix, curVol, wantMix, wantVol, pumpOutChecked = false) {
      try {
        const validations = [
          validateInput(curMix, 'Current mix', 0, 100),
          validateInput(wantMix, 'Wanted mix', 0, 100),
          validateInput(curVol, 'Current volume', 0.1),
          validateInput(wantVol, 'Wanted volume', 0.1)
        ];
        for (let v of validations) if (!v.valid) return { truckId, success:false, error:v.message };

        // pump-out
        let pumpOutAmount = 0;
        let pumpOutMode = null;
        let effectiveCurVol = curVol;

        if (pumpOutChecked) {
          if (wantMix < curMix) pumpOutMode = 'water-only';
          else if (wantMix > curMix) pumpOutMode = 'glycol-only';

          if (pumpOutMode) {
            pumpOutAmount = calculateAutoPumpOut(curMix, curVol, wantMix, wantVol, pumpOutMode);
            if (pumpOutAmount === null || pumpOutAmount <= 0 || pumpOutAmount >= curVol) {
              pumpOutAmount = 0;
              pumpOutMode = null;
            } else {
              effectiveCurVol = curVol - pumpOutAmount;
            }
          }
        }

        // same percent (volume add only)
        if (curMix === wantMix) {
          if (wantVol <= curVol) return { truckId, success:false, error:'Wanted volume must be greater than current volume' };

          const volumeToAdd = wantVol - curVol;
          const typeIToAdd = volumeToAdd * (curMix / 100);
          const waterToAdd = volumeToAdd * ((100 - curMix) / 100);

          return {
            truckId, success:true,
            currentMix:curMix, currentVolume:curVol,
            wantedMix:wantMix, wantedVolume:wantVol,
            percentToAdd:curMix,
            volumeToAdd,
            typeIToAdd,
            waterToAdd,
            pumpOutAmount:0,
            pumpOutMode:null
          };
        }

        const cm = curMix / 100;
        const wm = wantMix / 100;

        const d4 = cm * effectiveCurVol;
        const d5 = wm * wantVol;
        const d6 = d5 - d4;

        const e4 = effectiveCurVol - d4;
        const e5 = wantVol - d5;
        const e6 = e5 - e4;

        const percentToAdd = (d6 / (d6 + e6)) * 100;
        const volumeToAdd = d6 + e6;
        const typeIToAdd = d6;
        const waterToAdd = e6;

        return {
          truckId, success:true,
          currentMix:curMix, currentVolume:curVol,
          wantedMix:wantMix, wantedVolume:wantVol,
          percentToAdd,
          volumeToAdd,
          typeIToAdd,
          waterToAdd,
          pumpOutAmount,
          pumpOutMode
        };
      } catch (e) {
        return { truckId, success:false, error:e.message };
      }
    }

    function calculateAutoPumpOut(curMix, curVol, wantMix, wantVol, mode) {
      const cm = curMix / 100;
      const wm = wantMix / 100;

      if (mode === 'water-only') {
        if (wantMix >= curMix) return null;
        const pumpOut = curVol - (wm * wantVol / cm);
        if (pumpOut < 0 || pumpOut >= curVol) return null;
        return pumpOut;
      }

      if (mode === 'glycol-only') {
        if (wantMix <= curMix) return null;
        const numerator = (wm * wantVol - cm * curVol - wantVol + curVol) * 100;
        const denominator = 100 - curMix;
        if (denominator === 0) return null;
        const pumpOut = numerator / denominator;
        if (pumpOut < 0 || pumpOut >= curVol) return null;
        return pumpOut;
      }

      return null;
    }

    // ========== GAUGE MATCH (delegated listeners) ==========
    const GM_STORAGE_PREFIX = 'kpit_gaugeMatch_v1';
    function gmKey(truckId){ return `${GM_STORAGE_PREFIX}:${truckId}:default`; }

    function loadGaugeMatch(truckId){
      try{
        const raw = localStorage.getItem(gmKey(truckId));
        if(!raw) return { enabled:false, offset:0 };
        const p = JSON.parse(raw);
        return { enabled:!!p.enabled, offset:Number(p.offset)||0 };
      }catch(e){ return { enabled:false, offset:0 }; }
    }

    function saveGaugeMatch(truckId, state){
      try{
        localStorage.setItem(gmKey(truckId), JSON.stringify({
          enabled:!!state.enabled,
          offset:Number(state.offset)||0
        }));
      }catch(e){}
    }

    function roundGallons(x){
      const n = Number(x);
      return Number.isFinite(n) ? Math.round(n) : NaN;
    }

    function setupGaugeMatchDelegation(){
      const resultsDiv = document.getElementById('batch-results');
      if(!resultsDiv) return;
      if(setupGaugeMatchDelegation._wired) return;
      setupGaugeMatchDelegation._wired = true;

      resultsDiv.addEventListener('change', (e) => {
        const el = e.target;
        if(!el?.classList?.contains('gm-enable')) return;

        const card = el.closest('.truck-result');
        if(!card) return;

        const truckId = card.dataset.truckid;
        const body = card.querySelector('.gm-body');

        const state = loadGaugeMatch(truckId);
        state.enabled = !!el.checked;
        saveGaugeMatch(truckId, state);

        if(body) body.style.display = state.enabled ? 'block' : 'none';

        if(!state.enabled){
          const aw = card.querySelector('.gm-after-water');
          const at = card.querySelector('.gm-after-type');
          const awTrue = roundGallons(card.dataset.afterwatertrue);
          const atTrue = roundGallons(card.dataset.aftertypetrue);
          if(aw && Number.isFinite(awTrue)) aw.textContent = `Gallons after step: ${awTrue}`;
          if(at && Number.isFinite(atTrue)) at.textContent = `Gallons after step: ${atTrue}`;
        }
      });

      resultsDiv.addEventListener('input', (e) => {
        const el = e.target;
        if(!el?.classList?.contains('gm-now')) return;

        const card = el.closest('.truck-result');
        if(!card) return;

        const enabled = !!card.querySelector('.gm-enable')?.checked;
        if(!enabled) return;

        const truckId = card.dataset.truckid;

        const trueCurrent = roundGallons(card.dataset.truecurrent);
        const gaugeNow = roundGallons(el.value);

        const aw = card.querySelector('.gm-after-water');
        const at = card.querySelector('.gm-after-type');
        const awTrue = roundGallons(card.dataset.afterwatertrue);
        const atTrue = roundGallons(card.dataset.aftertypetrue);

        if(!Number.isFinite(trueCurrent) || !Number.isFinite(gaugeNow) || !Number.isFinite(awTrue) || !Number.isFinite(atTrue)){
          if(aw) aw.textContent = Number.isFinite(awTrue) ? `Gallons after step: ${awTrue}` : 'Gallons after step: --';
          if(at) at.textContent = Number.isFinite(atTrue) ? `Gallons after step: ${atTrue}` : 'Gallons after step: --';
          return;
        }

        const offset = gaugeNow - trueCurrent;
        saveGaugeMatch(truckId, { enabled:true, offset });

        if(aw) aw.textContent = `Gallons after step: ${roundGallons(awTrue + offset)}`;
        if(at) at.textContent = `Gallons after step: ${roundGallons(atTrue + offset)}`;
      });
    }

    // ========== RESULTS RENDER / SORT ==========
    function displayBatchResults(results, wantedMix, wantedVol){
      batchResultsData = results;
      document.getElementById('batch-sort-controls').style.display = 'block';
      renderBatchResults(results, wantedMix, wantedVol);
    }

    function sortBatchResults(sortType, btnEl){
      document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.style.background = 'white';
        btn.style.color = '#0369a1';
        btn.style.borderColor = '#e5e7eb';
        btn.classList.remove('active');
      });
      if(btnEl){
        btnEl.style.background = '#0ea5e9';
        btnEl.style.color = 'white';
        btnEl.style.borderColor = '#0ea5e9';
        btnEl.classList.add('active');
      }

      let sorted = [...batchResultsData];

      switch(sortType){
        case 'pump-out':
          sorted.sort((a,b)=>((b.pumpOutAmount>0)?1:0)-((a.pumpOutAmount>0)?1:0));
          break;
        case 'water-only':
          sorted.sort((a,b)=>(((b.pumpOutMode==='water-only' && Math.round(b.typeIToAdd)===0)?1:0)-((a.pumpOutMode==='water-only' && Math.round(a.typeIToAdd)===0)?1:0)));
          break;
        case 'glycol-only':
          sorted.sort((a,b)=>(((b.pumpOutMode==='glycol-only' && Math.round(b.waterToAdd)===0)?1:0)-((a.pumpOutMode==='glycol-only' && Math.round(a.waterToAdd)===0)?1:0)));
          break;
        case 'mixed':
          sorted.sort((a,b)=>(((!b.pumpOutMode || b.pumpOutAmount===0)?1:0)-((!a.pumpOutMode || a.pumpOutAmount===0)?1:0)));
          break;
        case 'largest-diff':
          sorted.sort((a,b)=>Math.abs(b.wantedMix-b.currentMix)-Math.abs(a.wantedMix-a.currentMix));
          break;
        default:
          // keep
          break;
      }

      const wantedMix = sorted[0]?.wantedMix || 0;
      const wantedVol = sorted[0]?.wantedVolume || 0;
      renderBatchResults(sorted, wantedMix, wantedVol);
    }

    function renderBatchResults(results, wantedMix, wantedVol){
      const resultsDiv = document.getElementById('batch-results');

      const successCount = results.filter(r=>r.success).length;
      const totalTypeI = results.filter(r=>r.success).reduce((s,r)=>s + (r.typeIToAdd||0), 0);
      const totalWater = results.filter(r=>r.success).reduce((s,r)=>s + (r.waterToAdd||0), 0);
      const totalFluid = totalTypeI + totalWater;

      let html = `
        <div class="summary-box">
          <div class="summary-title">üìä Batch Summary</div>
          <div class="summary-stat"><span>Trucks Processed:</span><span class="summary-stat-value">${successCount} / ${results.length}</span></div>
          <div class="summary-stat"><span>Total Type I Needed:</span><span class="summary-stat-value">${Math.round(totalTypeI)} gal</span></div>
          <div class="summary-stat"><span>Total Water Needed:</span><span class="summary-stat-value">${Math.round(totalWater)} gal</span></div>
          <div class="summary-stat"><span>Total Fluid:</span><span class="summary-stat-value">${Math.round(totalFluid)} gal</span></div>
        </div>
      `;

      results.forEach(result => {
        if(!result.success){
          html += `
            <div class="truck-result">
              <div class="truck-header">
                <div class="truck-id">${result.truckId}</div>
                <div class="truck-status status-error">‚úó Error</div>
              </div>
              <div class="error-message" style="margin:0;">${result.error}</div>
            </div>
          `;
          return;
        }

        // Pump-out block
        let pumpOutSection = '';
        if(result.pumpOutAmount && result.pumpOutAmount > 0){
          const addType = result.pumpOutMode === 'water-only' ? 'water' : 'Type I glycol';
          const afterPumpOutVol = result.currentVolume - result.pumpOutAmount;
          pumpOutSection = `
            <div style="background:#fef2f2;border-left:4px solid #ef4444;padding:10px;border-radius:8px;margin-bottom:12px;">
              <div style="font-weight:800;color:#dc2626;margin-bottom:6px;">‚ö†Ô∏è Pump Out Required</div>
              <div class="result-item" style="margin-bottom:8px;">
                <span>Pump Out</span><span class="result-value" style="color:#dc2626;">${result.pumpOutAmount.toFixed(0)} gal</span>
              </div>
              <div class="result-item" style="margin-bottom:0;">
                <span>After Pump Out</span><span class="result-value">${afterPumpOutVol.toFixed(0)} gal</span>
              </div>
              <div style="font-size:12px;color:#6b7280;margin-top:6px;">Then add ${addType} only</div>
            </div>
          `;
        }

        // Gauge match state
        const gmState = loadGaugeMatch(result.truckId);
        const gmEnabled = !!gmState.enabled;
        const gmOffset = Number(gmState.offset) || 0;

        const pumpOutAmt = (result.pumpOutAmount && Number(result.pumpOutAmount) > 0) ? Number(result.pumpOutAmount) : 0;

        const trueCurrentVol = Math.round(result.currentVolume);
        const trueBaseVol = Math.round(result.currentVolume - pumpOutAmt);
        const trueTargetVol = Math.round(result.wantedVolume);

        const waterAddRnd = Math.round(result.waterToAdd || 0);
        const typeIAddRnd = Math.round(result.typeIToAdd || 0);

        const afterWaterTrue = Math.round(trueBaseVol + (result.waterToAdd || 0));
        const afterTypeTrue = trueTargetVol;

        const afterWaterDisplay = gmEnabled ? roundGallons(afterWaterTrue + gmOffset) : afterWaterTrue;
        const afterTypeDisplay  = gmEnabled ? roundGallons(afterTypeTrue + gmOffset) : afterTypeTrue;

        let fluidRows = '';
        if(waterAddRnd > 0){
          fluidRows += `
            <div class="truck-ref-item" style="grid-column: 1 / -1;">
              <span style="color:#3b82f6;font-weight:800;">üíß Water: Add ${waterAddRnd} gal</span>
              <span class="gm-after-water" style="font-weight:800;color:#111827;">Gallons after step: ${afterWaterDisplay}</span>
            </div>`;
        }
        if(typeIAddRnd > 0){
          fluidRows += `
            <div class="truck-ref-item" style="grid-column: 1 / -1;">
              <span style="color:#f97316;font-weight:800;">üß™ Type I: Add ${typeIAddRnd} gal</span>
              <span class="gm-after-type" style="font-weight:800;color:#111827;">Gallons after step: ${afterTypeDisplay}</span>
            </div>`;
        }
        if(!fluidRows){
          fluidRows = `<div style="font-size:13px;color:#6b7280;">No fluid to add.</div>`;
        }

html += `
  <div class="truck-result"
       data-truckid="${result.truckId}"
       data-truecurrent="${trueCurrentVol}"
       data-truetarget="${trueTargetVol}"
       data-afterwatertrue="${afterWaterTrue}"
       data-aftertypetrue="${afterTypeTrue}">
    <div class="truck-header">
      <div class="truck-id">${result.truckId}</div>
      <div class="truck-status status-success">‚úì Success</div>
    </div>

    <!-- üîº MOVED UP: Reference summary -->
    <div class="truck-ref-box">
      <div class="truck-ref-item">
        <span class="truck-ref-label">Current</span>
        <span class="truck-ref-value">${result.currentMix.toFixed(1)}% @ ${result.currentVolume.toFixed(0)} gal</span>
      </div>
      <div class="truck-ref-item">
        <span class="truck-ref-label">Target</span>
        <span class="truck-ref-value">${result.wantedMix.toFixed(1)}% @ ${Math.round(result.wantedVolume)} gal</span>
      </div>
      <div class="truck-ref-item">
        <span class="truck-ref-label">Mix Add</span>
        <span class="truck-ref-value">${Number(result.percentToAdd).toFixed(0)}%</span>
      </div>
      <div class="truck-ref-item">
        <span class="truck-ref-label">Total Add</span>
        <span class="truck-ref-value">${Math.round(result.volumeToAdd)} gal</span>
      </div>
    </div>

    <!-- üîΩ Pump out now appears AFTER summary -->
    ${pumpOutSection}

            <div class="gauge-match-box">
              <label class="gm-toggle-inline">
                <input type="checkbox" class="gm-enable" ${gmEnabled ? 'checked' : ''}>
                <span>Gauge Gallons Offset</span>
              </label>
              <div class="gm-body" style="${gmEnabled ? '' : 'display:none;'}">
                <input class="gm-input gm-now" inputmode="numeric" placeholder="Enter the gallons displayed on the gauge" value="">
                <div class="gm-hint">Tip: Enter what the sight gauge shows right now. We‚Äôll offset the ‚Äúgallons after step‚Äù numbers to match.</div>
              </div>
            </div>

            <div class="fluid-add-box">
              <div class="fluid-add-title">Fluid Breakdown:</div>
              <div class="truck-ref-box" style="margin-top:0;">
                ${fluidRows}
              </div>
            </div>
          </div>
        `;
      });

      resultsDiv.innerHTML = html;
      setupGaugeMatchDelegation();
    }

    // ========== SINGLE CALCULATORS ==========
    function calcInc(){
      const c=parseFloat(document.getElementById('inc-cur').value);
      const d=parseFloat(document.getElementById('inc-des').value);
      const v=parseFloat(document.getElementById('inc-vol').value);
      const resultDiv=document.getElementById('inc-result');

      saveInput('increase','inc-cur',document.getElementById('inc-cur').value);
      saveInput('increase','inc-des',document.getElementById('inc-des').value);
      saveInput('increase','inc-vol',document.getElementById('inc-vol').value);

      if(!c||!d||!v){ resultDiv.innerHTML=''; return; }

      const validations=[
        validateInput(c,'Current mix',0,100),
        validateInput(d,'Desired mix',0,100),
        validateInput(v,'Current volume',0.1)
      ];
      for(let x of validations){
        if(!x.valid){ resultDiv.innerHTML=`<div class="error-message">${x.message}</div>`; return; }
      }
      if(d<=c){ resultDiv.innerHTML='<div class="error-message">Desired mix must be greater than current mix</div>'; return; }

      const g=v*((d-c)/(100-d)), t=v+g;
      resultDiv.innerHTML=`
        <div style="background:#f97316;color:white;padding:12px;border-radius:8px;margin-bottom:8px;font-weight:800;text-align:center;">
          Type I to Add: ${g.toFixed(2)} gal
        </div>
        <div class="result-item"><span>New Total Volume</span><span class="result-value">${t.toFixed(2)} gal</span></div>
      `;
      saveToHistory('Inc',{c,d,v,g:g.toFixed(2)});
    }

    function calcDec(){
      const c=parseFloat(document.getElementById('dec-cur').value);
      const d=parseFloat(document.getElementById('dec-des').value);
      const v=parseFloat(document.getElementById('dec-vol').value);
      const resultDiv=document.getElementById('dec-result');

      saveInput('decrease','dec-cur',document.getElementById('dec-cur').value);
      saveInput('decrease','dec-des',document.getElementById('dec-des').value);
      saveInput('decrease','dec-vol',document.getElementById('dec-vol').value);

      if(!c||!d||!v){ resultDiv.innerHTML=''; return; }

      const validations=[
        validateInput(c,'Current mix',0,100),
        validateInput(d,'Desired mix',0,100),
        validateInput(v,'Current volume',0.1)
      ];
      for(let x of validations){
        if(!x.valid){ resultDiv.innerHTML=`<div class="error-message">${x.message}</div>`; return; }
      }
      if(d>=c){ resultDiv.innerHTML='<div class="error-message">Desired mix must be less than current mix</div>'; return; }
      if(d===0){ resultDiv.innerHTML='<div class="error-message">Desired mix cannot be zero</div>'; return; }

      const w=v*((c-d)/d), t=v+w;
      resultDiv.innerHTML=`
        <div style="background:#3b82f6;color:white;padding:12px;border-radius:8px;margin-bottom:8px;font-weight:800;text-align:center;">
          Water to Add: ${w.toFixed(2)} gal
        </div>
        <div class="result-item"><span>New Total Volume</span><span class="result-value">${t.toFixed(2)} gal</span></div>
      `;
      saveToHistory('Dec',{c,d,v,w:w.toFixed(2)});
    }

    function handleVolCurInput(){
      saveInput('volume','vol-cur',document.getElementById('vol-cur').value);
      calcVol();
    }
    function handleVolCurFreezeInput(){
      const freezeInput=document.getElementById('vol-cur-freeze');
      saveInput('volume','vol-cur-freeze',freezeInput.value);
      if(freezeInput.value){
        const freezeC=parseFloat(freezeInput.value);
        const percentage=freezePointToPercentage(freezeC);
        document.getElementById('vol-cur').value=percentage;
        saveInput('volume','vol-cur',percentage);
      }
      calcVol();
    }
    function handleVolWantInput(){
      saveInput('volume','vol-want',document.getElementById('vol-want').value);
      calcVol();
    }
    function handleVolWantFreezeInput(){
      const freezeInput=document.getElementById('vol-want-freeze');
      saveInput('volume','vol-want-freeze',freezeInput.value);
      if(freezeInput.value){
        const freezeC=parseFloat(freezeInput.value);
        const percentage=freezePointToPercentage(freezeC);
        document.getElementById('vol-want').value=percentage;
        saveInput('volume','vol-want',percentage);
      }
      calcVol();
    }

    function calcVol(){
      const curMix=parseFloat(document.getElementById('vol-cur').value);
      const curVol=parseFloat(document.getElementById('vol-curv').value);
      const wantMix=parseFloat(document.getElementById('vol-want').value);
      const wantVol=parseFloat(document.getElementById('vol-wantv').value);
      const pumpOutChecked=true;
      const resultDiv=document.getElementById('vol-result');

      saveInput('volume','vol-curv',document.getElementById('vol-curv').value);
      saveInput('volume','vol-wantv',document.getElementById('vol-wantv').value);
      saveInput('volume','vol-pumpout',pumpOutChecked);

      if(!curMix||!curVol||!wantMix||!wantVol){ resultDiv.innerHTML=''; return; }

      const validations=[
        validateInput(curMix,'Current mix',0,100),
        validateInput(wantMix,'Wanted mix',0,100),
        validateInput(curVol,'Current volume',0.1),
        validateInput(wantVol,'Wanted volume',0.1)
      ];
      for(let v of validations){
        if(!v.valid){ resultDiv.innerHTML=`<div class="error-message">${v.message}</div>`; return; }
      }

      // same %
      if(curMix===wantMix){
        if(wantVol<=curVol){ resultDiv.innerHTML='<div class="error-message">Wanted volume must be greater than current volume</div>'; return; }
        const volumeToAdd=wantVol-curVol;
        const typeIToAdd=volumeToAdd*(curMix/100);
        const waterToAdd=volumeToAdd*((100-curMix)/100);
        resultDiv.innerHTML=`
          <div style="background:#10b981;color:white;padding:12px;border-radius:8px;margin-bottom:12px;font-weight:800;text-align:center;">
            Maintaining ${curMix.toFixed(1)}% Mix
          </div>
          <div class="result-item"><span>% to Add</span><span class="result-value">${curMix.toFixed(0)}%</span></div>
          <div class="result-item"><span>Volume to Add</span><span class="result-value">${Math.round(volumeToAdd)} gal</span></div>
          <div style="margin-top:16px;">
            <div style="background:#3b82f6;color:white;padding:12px;border-radius:8px;margin-bottom:8px;font-weight:800;text-align:center;">
              Water to Add: ${Math.round(waterToAdd)} gal
            </div>
            <div style="background:#f97316;color:white;padding:12px;border-radius:8px;font-weight:800;text-align:center;">
              Type I to Add: ${Math.round(typeIToAdd)} gal
            </div>
          </div>`;
        saveToHistory('Vol',{curMix,curVol,wantMix,wantVol,vol:Math.round(volumeToAdd),pct:curMix.toFixed(0),water:Math.round(waterToAdd),typeI:Math.round(typeIToAdd),pumpOut:0});
        return;
      }

      // pump-out
      let pumpOutAmount=0;
      let pumpOutMode=null;

      if(pumpOutChecked){
        if(wantMix<curMix) pumpOutMode='water-only';
        else if(wantMix>curMix) pumpOutMode='glycol-only';

        if(pumpOutMode){
          pumpOutAmount=calculateAutoPumpOut(curMix,curVol,wantMix,wantVol,pumpOutMode);
          if(pumpOutAmount===null || pumpOutAmount<=0 || pumpOutAmount>=curVol){
            pumpOutAmount=0;
            pumpOutMode=null;
          }
        }
      }

      let effectiveCurVol=curVol;
      let pumpOutHtml='';

      if(pumpOutChecked && pumpOutAmount>0){
        effectiveCurVol=curVol-pumpOutAmount;
        const addType=pumpOutMode==='water-only'?'water':'Type I glycol';
        pumpOutHtml=`
          <div style="background:#ef4444;color:white;padding:12px;border-radius:8px;margin-bottom:8px;font-weight:800;text-align:center;">
            Step 1: Pump Out ${pumpOutAmount.toFixed(2)} gal
          </div>
          <div class="result-item"><span>Volume After Pump Out</span><span class="result-value">${effectiveCurVol.toFixed(2)} gal</span></div>
          <div style="background:#e0f2fe;padding:10px;border-radius:8px;margin:10px 0;font-size:13px;color:#0369a1;text-align:center;">
            ‚ÑπÔ∏è Then add ${addType} only
          </div>
          <div style="height:1px;background:#e5e7eb;margin:16px 0;"></div>`;
      }

      if(wantVol<=effectiveCurVol){
        resultDiv.innerHTML='<div class="error-message">Wanted volume must be greater than current volume'+(pumpOutChecked?' after pump out':'')+'</div>';
        return;
      }

      const cm=curMix/100;
      const wm=wantMix/100;

      const d4=cm*effectiveCurVol;
      const d5=wm*wantVol;
      const d6=d5-d4;

      const e4=effectiveCurVol-d4;
      const e5=wantVol-d5;
      const e6=e5-e4;

      const percentToAdd=(d6/(d6+e6))*100;
      const volumeToAdd=d6+e6;
      const typeIToAdd=d6;
      const waterToAdd=e6;

      resultDiv.innerHTML=
        pumpOutHtml +
        `<div class="result-item"><span>% to Add</span><span class="result-value">${percentToAdd.toFixed(0)}%</span></div>
         <div class="result-item"><span>Volume to Add</span><span class="result-value">${Math.round(volumeToAdd)} gal</span></div>
         <div style="margin-top:16px;">
           <div style="background:#3b82f6;color:white;padding:12px;border-radius:8px;margin-bottom:8px;font-weight:800;text-align:center;">
             Water to Add: ${Math.round(waterToAdd)} gal
           </div>
           <div style="background:#f97316;color:white;padding:12px;border-radius:8px;font-weight:800;text-align:center;">
             Type I to Add: ${Math.round(typeIToAdd)} gal
           </div>
         </div>`;
      saveToHistory('Vol',{curMix,curVol,wantMix,wantVol,vol:Math.round(volumeToAdd),pct:percentToAdd.toFixed(0),water:Math.round(waterToAdd),typeI:Math.round(typeIToAdd),pumpOut:pumpOutChecked?pumpOutAmount:0});
    }

    function calcTote(){
      const tm=parseFloat(document.getElementById('tote-tm').value)/100;
      const tv=parseFloat(document.getElementById('tote-tv').value);
      const ttm=parseFloat(document.getElementById('tote-ttm').value)/100;
      const ttv=parseFloat(document.getElementById('tote-ttv').value);
      const resultDiv=document.getElementById('tote-result');

      saveInput('tote','tote-tm',document.getElementById('tote-tm').value);
      saveInput('tote','tote-tv',document.getElementById('tote-tv').value);
      saveInput('tote','tote-ttm',document.getElementById('tote-ttm').value);
      saveInput('tote','tote-ttv',document.getElementById('tote-ttv').value);

      if(!tm||!tv||!ttm||!ttv){ resultDiv.innerHTML=''; return; }

      const validations=[
        validateInput(tm*100,'Truck mix',0,100),
        validateInput(ttm*100,'Tote mix',0,100),
        validateInput(tv,'Truck volume',0.1),
        validateInput(ttv,'Tote volume',0.1)
      ];
      for(let v of validations){
        if(!v.valid){ resultDiv.innerHTML=`<div class="error-message">${v.message}</div>`; return; }
      }

      const nm=((tv*tm)+(ttv*ttm))/(tv+ttv), t=tv+ttv;
      resultDiv.innerHTML=`
        <div class="result-item"><span>New Mix</span><span class="result-value">${(nm*100).toFixed(2)}%</span></div>
        <div class="result-item"><span>Total</span><span class="result-value">${t.toFixed(2)} gal</span></div>`;
      saveToHistory('Tote',{tm:(tm*100).toFixed(1),ttm:(ttm*100).toFixed(1),nm:(nm*100).toFixed(2)});
    }

    // ========== TRUCKBOARD ==========
    function refreshTruckBoard(){
      const iframe=document.getElementById('truckboard-iframe');
      const currentSrc=iframe.src.split('?')[0];
      iframe.src=currentSrc+'?page=display&t='+(new Date().getTime());
    }
    function updateTruckBoardTime(){
      const now=new Date();
      document.getElementById('truckboard-time').textContent =
        now.toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
    }

    // ========== FREEZE MAP ==========
    function freezePointToPercentage(freezeC){
      const freezeMap=[
        {freeze:-43,pct:70},{freeze:-41.5,pct:65},{freeze:-40,pct:60},
        {freeze:-39,pct:59},{freeze:-39,pct:58},{freeze:-38,pct:57},{freeze:-37,pct:56},
        {freeze:-36,pct:55},{freeze:-34,pct:54},{freeze:-32,pct:53},{freeze:-31,pct:52},
        {freeze:-29,pct:51},{freeze:-27,pct:50},{freeze:-26,pct:49},{freeze:-25,pct:48},
        {freeze:-24,pct:47},{freeze:-23,pct:46},{freeze:-22,pct:45},{freeze:-21,pct:44},
        {freeze:-21,pct:43},{freeze:-19,pct:42},{freeze:-19,pct:41},{freeze:-18,pct:40},
        {freeze:-17,pct:39},{freeze:-16,pct:38},{freeze:-15,pct:37},{freeze:-14,pct:36},
        {freeze:-13,pct:35},{freeze:-13,pct:34},{freeze:-13,pct:33},{freeze:-12,pct:32},
        {freeze:-12,pct:31},{freeze:-11,pct:30},{freeze:-11,pct:29},{freeze:-11,pct:28},
        {freeze:-11,pct:27},{freeze:-10,pct:26},{freeze:-10,pct:25},{freeze:-9,pct:24},
        {freeze:-8,pct:23},{freeze:-8,pct:22},{freeze:-7,pct:21},{freeze:-7,pct:20}
      ];
      let closest=freezeMap[0];
      let minDiff=Math.abs(freezeC-closest.freeze);
      for(let entry of freezeMap){
        const diff=Math.abs(freezeC-entry.freeze);
        if(diff<minDiff){ minDiff=diff; closest=entry; }
      }
      return closest.pct;
    }

    // ========== TRUCK LIST + DATA ==========
    async function loadTruckList(){
      const select=document.getElementById('truck-select');
      select.innerHTML='<option value="">-- Select a Truck --</option>';
      try{
        const url=`https://docs.google.com/spreadsheets/d/${SHEETS_ID}/gviz/tq?tqx=out:csv`;
        const response=await fetch(url);
        const csvText=await response.text();
        const lines=csvText.trim().split('\n');
        const dataLines=lines.slice(1);
        dataLines.forEach(line=>{
          const values=line.replace(/"/g,'').split(',');
          if(values[0] && values[0].trim()){
            const truckId=values[0].trim();
            const option=document.createElement('option');
            option.value=truckId;
            option.textContent=truckId;
            select.appendChild(option);
          }
        });
      }catch(e){
        console.error('Error loading truck list:',e);
      }
    }

    async function loadTruckData(){
      const select=document.getElementById('truck-select');
      const selectedTruck=select.value;
      const dataDiv=document.getElementById('current-truck-data');
      if(!selectedTruck){ dataDiv.style.display='none'; return; }

      try{
        const url=`https://docs.google.com/spreadsheets/d/${SHEETS_ID}/gviz/tq?tqx=out:csv`;
        const response=await fetch(url);
        const csvText=await response.text();
        const lines=csvText.trim().split('\n');
        const dataLines=lines.slice(1);

        for(let line of dataLines){
          const values=line.replace(/"/g,'').split(',');
          const truckId=values[0]?.trim();
          if(truckId===selectedTruck){
            const percent=values[1] ? values[1].trim()+'%' : 'N/A';
            const freeze=values[2] ? values[2].trim()+'¬∞C' : 'N/A';

            let typeI=values[5] ? values[5].trim() : '0';
            let typeIV=values[6] ? values[6].trim() : '0';

            if(typeI.length<=2 && values[6] && values[6].match(/^\d{3}/)){
              typeI = typeI + values[6].substring(0,3);
              typeIV = values[7] ? values[7].trim() : '0';
              if(typeIV.length<=2 && values[8] && values[8].match(/^\d{3}/)){
                typeIV = typeIV + values[8].substring(0,3);
              }
            }

            document.getElementById('current-truck-id').textContent=truckId;
            document.getElementById('current-percent').textContent=percent;
            document.getElementById('current-freeze').textContent=freeze;
            document.getElementById('current-typei').textContent=typeI+' gal';
            document.getElementById('current-typeiv').textContent=typeIV+' gal';

            dataDiv.style.display='block';
            return;
          }
        }

        dataDiv.style.display='none';
        alert('Truck data not found');
      }catch(e){
        console.error('Error loading truck data:',e);
        alert('Error loading truck data. Please try again.');
      }
    }

    // ========== ATIS / METAR ==========
    async function loadATIS(){
      try{
        document.getElementById('temperature').textContent='Loading...';
        document.getElementById('dewpoint').textContent='Loading...';
        document.getElementById('wind').textContent='Loading...';
        document.getElementById('metar-full').textContent='Loading...';
        document.getElementById('metar-time').textContent='--';
        document.getElementById('metar-observed').textContent='--';
        document.getElementById('precip-box').style.display='none';

        const atisInfo = await getAtisInfo('KPIT');
        const atisBox = document.getElementById('atis-info-box');
        const atisLetter = document.getElementById('atis-letter');
        if(atisInfo.ok && atisInfo.code){
          atisLetter.textContent = atisInfo.code;
          atisBox.style.display = 'block';
        }else{
          atisBox.style.display = 'none';
        }

        const station='KPIT';
        const metarURL=`https://aviationweather.gov/api/data/metar?ids=${station}&format=raw&taf=false&hours=0&_=${Date.now()}`;

        const proxies=[
          `https://api.allorigins.win/raw?url=${encodeURIComponent(metarURL)}`,
          `https://corsproxy.io/?${encodeURIComponent(metarURL)}`,
          `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(metarURL)}`
        ];

        for(const proxyURL of proxies){
          try{
            const r = await fetch(proxyURL,{cache:'no-store'});
            if(r.ok){
              const metarText = await r.text();
              if(metarText && metarText.trim() && !metarText.includes('error') && metarText.includes('KPIT')){
                displayMETARData(metarText);
                return;
              }
            }
          }catch(e){
            console.log('Proxy failed:',e);
          }
        }

        throw new Error('All METAR fetch attempts failed');
      }catch(error){
        console.error('Error loading METAR:',error);
        document.getElementById('temperature').textContent='Unavailable';
        document.getElementById('dewpoint').textContent='Unavailable';
        document.getElementById('wind').textContent='Unavailable';
        document.getElementById('metar-full').innerHTML=`
          <div style="color:#dc2626;">
            Unable to load METAR data due to network restrictions.<br><br>
            Please use the external weather links below for current conditions.
          </div>`;
        document.getElementById('metar-time').textContent='--';
        document.getElementById('metar-observed').textContent='--';
      }
    }

    function displayMETARData(metarText){
      document.getElementById('metar-full').textContent = metarText;

      const observedTime = extractMETARTime(metarText);
      document.getElementById('metar-observed').textContent = observedTime;

      const now = new Date();
      document.getElementById('metar-time').textContent =
        now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});

      const weatherData = parseMETAR(metarText);

      document.getElementById('temperature').textContent = weatherData.temp || 'N/A';
      document.getElementById('dewpoint').textContent = weatherData.dewpoint || 'N/A';

      if(weatherData.wind){
        document.getElementById('wind').textContent = weatherData.wind;
        if(weatherData.windDirection !== null && weatherData.windDirection !== 'VRB' && weatherData.windDirection !== 'CALM'){
          document.getElementById('wind-compass').style.display = 'block';
          document.getElementById('wind-arrow').setAttribute('transform', `rotate(${weatherData.windDirection} 100 100)`);
          document.getElementById('wind-direction-text').textContent = weatherData.windDirection;
        }else{
          document.getElementById('wind-compass').style.display = 'none';
        }
      }else{
        document.getElementById('wind').textContent = 'N/A';
        document.getElementById('wind-compass').style.display = 'none';
      }

      const precipBox = document.getElementById('precip-box');
      if(weatherData.precipitation){
        document.getElementById('precipitation').textContent = weatherData.precipitation;
        precipBox.style.display = 'block';
      }else{
        precipBox.style.display = 'none';
      }
    }

    function parseMetarTGroup(metarRaw){
      if(!metarRaw) return null;
      const m = metarRaw.match(/\bT([01])(\d{3})([01])(\d{3})\b/);
      if(!m) return null;
      const tSign = (m[1]==='1') ? -1 : 1;
      const dSign = (m[3]==='1') ? -1 : 1;
      return { tempC: tSign*(parseInt(m[2],10)/10), dewC: dSign*(parseInt(m[4],10)/10) };
    }

    function formatC1(val){ if(val===null||val===undefined||isNaN(Number(val))) return 'N/A'; return Number(val).toFixed(1)+'¬∞C'; }
    function formatF1(c){ if(c===null||c===undefined||isNaN(Number(c))) return 'N/A'; return ((Number(c)*9/5)+32).toFixed(1)+'¬∞F'; }

    async function getAtisInfo(station){
      station=(station||"KPIT").toUpperCase().trim();
      const url="https://atis.info/api/"+encodeURIComponent(station);
      try{
        const response = await fetch(url,{method:'get',cache:'no-store'});
        if(response.status!==200) return { ok:false, station, error:"HTTP "+response.status };
        const arr = await response.json();
        let pick=null;
        if(Array.isArray(arr) && arr.length){
          pick = arr.reduce((best,cur)=>{
            const curT = cur?.updatedAt ? Date.parse(cur.updatedAt) : 0;
            const bestT = best?.updatedAt ? Date.parse(best.updatedAt) : 0;
            return (curT>bestT) ? cur : best;
          }, null);
        }
        if(!pick) return { ok:false, station, error:"No ATIS data returned" };
        return { ok:true, station, type:pick.type||"", code:pick.code||"", updatedAt:pick.updatedAt||"", datis:pick.datis||"" };
      }catch(e){
        console.error('ATIS fetch error:',e);
        return { ok:false, station, error:e.message };
      }
    }

    function extractMETARTime(metar){
      const timeMatch = metar.match(/\s(\d{2})(\d{2})(\d{2})Z/);
      if(timeMatch){
        const day=timeMatch[1], hour=timeMatch[2], minute=timeMatch[3];
        const now=new Date();
        const metarDate=new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), parseInt(day), parseInt(hour), parseInt(minute)));
        return metarDate.toLocaleString('en-US',{
          month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',hour12:false,
          timeZone:'America/New_York',timeZoneName:'short'
        });
      }
      return 'Unknown';
    }

    function parseMETAR(metar){
      const result={ temp:null, dewpoint:null, wind:null, windDirection:null, precipitation:null };

      const tgrp = parseMetarTGroup(metar);
      if(tgrp){
        result.temp = `${formatC1(tgrp.tempC)} / ${formatF1(tgrp.tempC)}`;
        result.dewpoint = `${formatC1(tgrp.dewC)} / ${formatF1(tgrp.dewC)}`;
      }else{
        const tempMatch = metar.match(/\s(M?\d{2})\/(M?\d{2})\s/);
        if(tempMatch){
          let t=tempMatch[1], d=tempMatch[2];
          if(t.startsWith('M')) t='-'+t.substring(1);
          if(d.startsWith('M')) d='-'+d.substring(1);
          const tempC=parseInt(t,10), dewC=parseInt(d,10);
          const tempF=Math.round((tempC*9/5)+32), dewF=Math.round((dewC*9/5)+32);
          result.temp = `${tempC}¬∞C / ${tempF}¬∞F`;
          result.dewpoint = `${dewC}¬∞C / ${dewF}¬∞F`;
        }
      }

      const windMatch = metar.match(/\s(VRB|\d{3})(\d{2,3})(G(\d{2,3}))?KT/);
      if(windMatch){
        const direction=windMatch[1];
        const speed=parseInt(windMatch[2],10);
        const gust=windMatch[4] ? parseInt(windMatch[4],10) : null;

        if(direction!=='VRB' && speed>0) result.windDirection=parseInt(direction,10);
        else if(direction==='VRB') result.windDirection='VRB';
        else result.windDirection='CALM';

        if(speed===0) result.wind='Calm';
        else{
          let wtxt = (direction==='VRB') ? `Variable at ${speed} kts` : `${direction}¬∞ at ${speed} kts`;
          if(gust) wtxt += ` gusting ${gust} kts`;
          result.wind = wtxt;
        }
      }

      const weatherCodes={
        'RA':'Rain','SN':'Snow','DZ':'Drizzle','FG':'Fog','BR':'Mist','HZ':'Haze','FU':'Smoke','VA':'Volcanic Ash',
        'DU':'Dust','SA':'Sand','TS':'Thunderstorm','SH':'Shower','FZ':'Freezing','GR':'Hail','GS':'Small Hail',
        'PL':'Ice Pellets','SG':'Snow Grains','IC':'Ice Crystals','UP':'Unknown Precipitation','SQ':'Squalls',
        'FC':'Funnel Cloud','SS':'Sandstorm','DS':'Duststorm'
      };

      const weatherMatch = metar.match(/\s([-+])?(VC|MI|PR|BC|DR|BL|SH|TS|FZ)?(DZ|RA|SN|SG|IC|PL|GR|GS|UP|BR|FG|FU|VA|DU|SA|HZ|PY|PO|SQ|FC|SS|DS)/g);
      if(weatherMatch){
        const phenomena=[];
        weatherMatch.forEach(wx=>{
          wx=wx.trim();
          let desc='';
          if(wx.startsWith('-')){ desc='Light '; wx=wx.substring(1); }
          else if(wx.startsWith('+')){ desc='Heavy '; wx=wx.substring(1); }

          let matched=false;
          for(const code in weatherCodes){
            if(wx.includes(code)){ desc += weatherCodes[code]+' '; matched=true; }
          }
          if(matched) phenomena.push(desc.trim());
        });
        if(phenomena.length) result.precipitation = phenomena.join(', ');
      }

      return result;
    }

    // ========== HISTORY / NOTES ==========
    function saveToHistory(t,d){
      const h=JSON.parse(localStorage.getItem('mixHist')||'[]');
      h.unshift({type:t,data:d,time:new Date().toISOString()});
      if(h.length>50) h.pop();
      localStorage.setItem('mixHist',JSON.stringify(h));
    }

    function displayHistory(){
      const h=JSON.parse(localStorage.getItem('mixHist')||'[]');
      const l=document.getElementById('history-list');
      if(!h.length){
        l.innerHTML='<p style="color:#9ca3af;padding:40px 20px;text-align:center;">No calculations yet</p>';
        return;
      }
      l.innerHTML=h.map(x=>{
        const date=new Date(x.time).toLocaleString();
        let det='';
        if(x.type==='Inc') det=`${x.data.c}% ‚Üí ${x.data.d}% | Add ${x.data.g} gal glycol`;
        else if(x.type==='Dec') det=`${x.data.c}% ‚Üí ${x.data.d}% | Add ${x.data.w} gal water`;
        else if(x.type==='Vol') det=`${x.data.curVol} ‚Üí ${x.data.wantVol} gal | Add ${x.data.vol} gal at ${x.data.pct}% (${x.data.water} gal water + ${x.data.typeI} gal Type I)`;
        else if(x.type==='Tote') det=`${x.data.tm}% + ${x.data.ttm}% = ${x.data.nm}%`;
        else if(x.type==='Batch') det=`${x.data.truckId}: ${x.data.curVol} ‚Üí ${x.data.wantVol} gal | Add ${x.data.vol} gal at ${x.data.pct}% (${x.data.water} gal water + ${x.data.typeI} gal Type I)${Number(x.data.pumpOut)>0 ? ' | Pump out ' + x.data.pumpOut + ' gal first' : ''}`;

        return `<div style="padding:12px;background:#f0f9ff;border-radius:8px;margin-bottom:8px;">
          <div style="font-weight:800;color:#0369a1;">${x.type}</div>
          <div style="font-size:13px;color:#6b7280;">${det}</div>
          <div style="font-size:11px;color:#9ca3af;">${date}</div>
        </div>`;
      }).join('');
    }

    function clearHistory(){
      if(confirm('Clear all calculation history?')){
        localStorage.removeItem('mixHist');
        displayHistory();
      }
    }

    function loadNotes(){ document.getElementById('notes-area').value = localStorage.getItem('fieldNotes') || ''; }
    function saveNotes(){
      localStorage.setItem('fieldNotes',document.getElementById('notes-area').value);
      const s=document.getElementById('notes-status');
      s.textContent='Saving...'; s.style.color='#0ea5e9';
      setTimeout(()=>{
        s.textContent='Saved ‚úì'; s.style.color='#10b981';
        setTimeout(()=>s.style.color='#9ca3af',2000);
      },500);
    }

    // ========== PDFS ==========
    const pdfLinks = [
      // Example:
      // { filename: "example.pdf", title: "Example Document", description: "Short description" }
    ];

    function loadPdfs(){
      const list=document.getElementById('pdf-list');
      if(!list) return;

      if(!pdfLinks.length){
        list.innerHTML = '<div class="pdf-missing">No PDF documents available.<br>Edit the <strong>pdfLinks</strong> array in the HTML to add documents.</div>';
        return;
      }

      list.innerHTML = pdfLinks.map(pdf => `
        <a href="./pdfs/${pdf.filename}" target="_blank" class="pdf-link" aria-label="Open ${pdf.title}">
          <div class="pdf-icon">üìÑ</div>
          <div class="pdf-info">
            <div class="pdf-title">${pdf.title}</div>
            ${pdf.description ? `<div class="pdf-desc">${pdf.description}</div>` : ''}
          </div>
        </a>
      `).join('');
    }

    // ========== TABLE DATA ==========
    const dilutionData=[['100%','1.4230-1.4260','DO NOT USE','DO NOT USE'],['90%/10%','1.4156-1.4186','-39¬∞C/-38¬∞F','DO NOT USE'],['80%/20%','1.4079-1.4106','-39¬∞C/-38¬∞F','DO NOT USE'],['70%/30%','1.3996-1.4026','-43¬∞C/-45¬∞F','DO NOT USE'],['65%/35%','1.3953-1.3983','-41.5¬∞C/-43¬∞F','-31¬∞C/-24¬∞F'],['60%/40%','1.3911-1.3941','-40¬∞C/-40¬∞F','-30¬∞C/-22¬∞F'],['59%/41%','1.3905-1.3910','-39¬∞C/-39¬∞F','-29¬∞C/-21¬∞F'],['58%/42%','1.3899-1.3904','-39¬∞C/-38¬∞F','-29¬∞C/-20¬∞F'],['57%/43%','1.3893-1.3898','-38¬∞C/-36¬∞F','-28¬∞C/-18¬∞F'],['56%/44%','1.3886-1.3892','-37¬∞C/-34¬∞F','-27¬∞C/-16¬∞F'],['55%/45%','1.3879-1.3885','-36¬∞C/-32¬∞F','-26¬∞C/-14¬∞F'],['54%/46%','1.3872-1.3878','-34¬∞C/-29¬∞F','-24¬∞C/-11¬∞F'],['53%/47%','1.3865-1.3871','-32¬∞C/-26¬∞F','-22¬∞C/-8¬∞F'],['52%/48%','1.3858-1.3864','-31¬∞C/-23¬∞F','-21¬∞C/-5¬∞F'],['51%/49%','1.3851-1.3857','-29¬∞C/-20¬∞F','-19¬∞C/-2¬∞F'],['50%/50%','1.3820-1.3850','-27¬∞C/-17¬∞F','-17¬∞C/+1¬∞F'],['49%/51%','1.3811-1.3819','-26¬∞C/-15¬∞F','-16¬∞C/+3¬∞F'],['48%/52%','1.3803-1.3810','-25¬∞C/-13¬∞F','-15¬∞C/+5¬∞F'],['47%/53%','1.3795-1.3802','-24¬∞C/-11¬∞F','-14¬∞C/+7¬∞F'],['46%/54%','1.3787-1.3794','-23¬∞C/-9¬∞F','-13¬∞C/+9¬∞F'],['45%/55%','1.3779-1.3786','-22¬∞C/-8¬∞F','-12¬∞C/+10¬∞F'],['44%/56%','1.3771-1.3778','-21¬∞C/-6¬∞F','-11¬∞C/+12¬∞F'],['43%/57%','1.3763-1.3770','-21¬∞C/-5¬∞F','-11¬∞C/+13¬∞F'],['42%/58%','1.3755-1.3762','-19¬∞C/-3¬∞F','-9¬∞C/+15¬∞F'],['41%/59%','1.3747-1.3754','-19¬∞C/-2¬∞F','-9¬∞C/+16¬∞F'],['40%/60%','1.3716-1.3746','-18¬∞C/0¬∞F','-8¬∞C/+18¬∞F'],['39%/61%','1.3707-1.3715','-17¬∞C/+2¬∞F','-7¬∞C/+20¬∞F'],['38%/62%','1.3699-1.3706','-16¬∞C/+3¬∞F','-6¬∞C/+21¬∞F'],['37%/63%','1.3691-1.3698','-15¬∞C/+5¬∞F','-5¬∞C/+23¬∞F'],['36%/64%','1.3682-1.3690','-14¬∞C/+6¬∞F','-4¬∞C/+24¬∞F'],['35%/65%','1.3673-1.3681','-13¬∞C/+7¬∞F','-3¬∞C/+25¬∞F'],['34%/66%','1.3664-1.3672','-13¬∞C/+8¬∞F','-3¬∞C/+26¬∞F'],['33%/67%','1.3655-1.3663','-13¬∞C/+9¬∞F','-3¬∞C/+27¬∞F'],['32%/68%','1.3646-1.3654','-12¬∞C/+10¬∞F','-2¬∞C/+28¬∞F'],['31%/69%','1.3637-1.3645','-12¬∞C/+11¬∞F','-2¬∞C/+29¬∞F'],['30%/70%','1.3606-1.3636','-11¬∞C/+12¬∞F','-1¬∞C/+30¬∞F'],['29%/71%','1.3600-1.3605','-11¬∞C/+12¬∞F','-1¬∞C/+30¬∞F'],['28%/72%','1.3593-1.3599','-11¬∞C/+13¬∞F','-1¬∞C/+31¬∞F'],['27%/73%','1.3587-1.3592','-11¬∞C/+13¬∞F','-1¬∞C/+31¬∞F'],['26%/74%','1.3580-1.3586','-10¬∞C/+14¬∞F','0¬∞C/+32¬∞F'],['25%/75%','1.3573-1.3579','-10¬∞C/+14¬∞F','0¬∞C/+32¬∞F'],['24%/76%','1.3565-1.3573','-9¬∞C/+15¬∞F','+1¬∞C/+33¬∞F'],['23%/77%','1.3557-1.3565','-8¬∞C/+18¬∞F','+2¬∞C/+36¬∞F'],['22%/78%','1.3549-1.3557','-8¬∞C/+18¬∞F','+2¬∞C/+36¬∞F'],['21%/79%','1.3541-1.3549','-7¬∞C/+19¬∞F','+3¬∞C/+37¬∞F'],['20%/80%','1.3511-1.3541','-7¬∞C/+19¬∞F','+3¬∞C/+37¬∞F']];

    const aircraftData=[
      ['Alaska','OK','OK','(W&T) No Type IV on the Vertical Tail','N/A'],
      ['Allegiant','OK','OK','(W&T)','N/A'],
      ['American (AA) "Mainline"','OK','OK','(W&T) if (F) requested Mainline from the engines back','N/A'],
      ['American (AA) "Regionals"','OK','OK','(WTF) ERJ 140/145, E175 (F) if requested from the main cabin door, all others (W&T)','Hand Tactile E140/145 & CRJ200 - (No Forced Air on E140/E145)'],
      ['Air Canada (Jazz)','OK','OK','Advise Start Time of Final Application. No Type IV on the Fuselage','(No use of fluid/air mixture when defrosting or deicing)'],
      ['Delta (DL) "Mainline"','OK','OK','(W&T) only No Type IV on Vertical Tail - Ask Capt if WiFi Antenna is OFF or MUTED.','DL - Ladder Tactile (Plus 10\' Hand) on B717 if requested. Engine Inlets @ Gates on Rear Mounted Engines'],
      ['Delta (DL) Connex','OK','OK','E 145 (WTF), All others see DL/DC Reference Chart - Advise ALL to "Configure flaps prior to Type IV"','DC - Hand Tactile E140/145 & CRJ200 (No Forced Air on E140/145) - Engine Inlets @ Gates on Rear Mounted Engines'],
      ['Delta Endeavor Air (9E) CRJ 700/900','OK','OK','W&T','Forced Air and Fluid Injection Allowed'],
      ['SkyWest (OO) CRJ 200/700/900','OK','OK','ALL CRJ/ERJ = W&T (Overnight Type IV not allowed on any Skywest Aircraft)','Forced Air and Fluid Injection Allowed'],
      ['Republic (YX) ERJ 170/175','OK','OK','ERJ 170/175 = W&T','ERJ 170/175 No Forced Air or Fluid Injection during ERD'],
      ['FedEx (FX)','N/A','OK','(W&T) Unless MD11 (F) from trailing edge of Wings back','Engine Inlet Prep at Cargo Ramp'],
      ['JetBlue (B6)','NO','OK','(W&T) Only','8\' Nozzle Distance'],
      ['Southwest (WN)','NO','OK','(W&T) No Type IV on the winglets or Vertical, if (F) requsrted from behind the main cabin door','N/A'],
      ['Spirit (NK)','NO (MX Only)','OK','(W&T) if (F) requested from the main cabin door back - Ask crew if WiFi is OFF','N/A'],
      ['SunCountry','OK','OK','(W&T) No Type IV if not necessary on the Vertical Tail','Flight Crew can request Type IV on the Vertical Tail'],
      ['United (UAL)','OK','OK','(W&T) No Type IV on Winglets or Vertical','Crew can request Type IV on Fuselage'],
      ['United (UAL) Connex','OK','OK','(W&T) Type IV on Fuselage of E-145','Full Body Type I required on ALL Aircraft. Tactile check required on E-145'],
      ['UPS (5X)','N/A','OK','(W&T) if (F) requested form behind the main cabin door back. (Type IV is required on the fuselage of the MD-11) No Type IV on the Vertical Tail.','UPS Requires Brix and Dew Point (Farenheit) on Deice Logs. Engine Inlet Prep at Cargo Ramp. (No use of Fluid/Air Mixtures when Defrosting or Deicing)'],
      ['MAC','N/A','OK','(WTF)','Deice Engines Off - Gather Gallons Total for Post Readback']
    ];

    const airlinesData=[['Alaska','Alaska Airlines','Alaska','AS'],['Allegiant','Allegiant','Allegiant','G4'],['American','American','American','AA'],['Air Wisconsin','American','Wisconsin','ZW-AA'],['PSA Airlines','American','Blue Streak','OH-AA'],['Republic','American','Brickyard','YX-AA'],['Skywest','American','Skywest','OO-AA'],['Envoy','American','Envoy','MQ-AA'],['Piedmont','American','Piedmont','PT-AA'],['Delta','Delta','Delta','DL'],['Endeavor Air','Delta','Endeavor','9E-DL'],['Skywest','Delta','Skywest','OO-DL'],['Republic','Delta','Brickyard','YX-DL'],['United','United','United','UA'],['Republic','United','Brickyard','YX-UA'],['Mesa','United','Air Shuttle','YV-UA'],['Go-Jet','United','Lindbergh','G7-UA'],['Skywest','United','Skywest','OO-UA'],['CommuteAir','United','CommuteAir','C5-UA'],['Southern Airways','Southern Airways','Friendly','9X'],['JetBlue','JetBlue','JetBlue','B6'],['Southwest','Southwest','Southwest','WN'],['Spirit Airlines','Spirit Airlines','Spirit Wings','NK'],['Breeze Airways','Breeze Airways','Moxy','MX'],['British Airways','British Airways','Speedbird','BA'],['Air Canada','Air Canada','Air Canada','AC'],['Air Canada Express','Air Canada','Jazz','QK'],['Icelandair','Icelandair','Iceair','FI'],['FedEx','FedEx','FedEx','FX'],['Mountain Air Cargo','Mountain Air Cargo','Mountain','C2'],['UPS','UPS','UPS','5X'],['Atlas Air','Atlas Air','Giant','5Y'],['Kalitta Air','Kalitta Air','Connie','K4'],['ATI','ATI Transport Intl','Air Transport','8C'],['Amazon Air','Sun Country','Sun Country','SY'],['US Air Force','US Air Force','Various','USAF'],['PAN-G','PAN-G','Various','PaNG']];

    function loadDilution(){
      const t=document.getElementById('dilution-body');
      if(t.innerHTML) return;
      t.innerHTML=dilutionData.map(r=>`<tr>${r.map((c,i)=>`<td style="background:${i===0?'#f9fafb':'white'};${String(c).includes('DO NOT USE')?'color:#dc2626;font-weight:800;':''}">${c}</td>`).join('')}</tr>`).join('');
    }
    function loadAircraft(){
      const t=document.getElementById('aircraft-body');
      if(t.innerHTML) return;
      t.innerHTML=aircraftData.map(r=>`<tr>${r.map((c,i)=>`<td style="background:${i===0?'#f9fafb':'white'};font-size:10px;line-height:1.3;">${c}</td>`).join('')}</tr>`).join('');
    }
    function loadAirlines(){
      const t=document.getElementById('airlines-body');
      if(t.innerHTML) return;
      t.innerHTML=airlinesData.map(r=>`<tr>${r.map((c,i)=>`<td style="background:${i===0?'#f9fafb':'white'};">${c}</td>`).join('')}</tr>`).join('');
    }

    // ========== MENU DRAG/DROP ==========
    let draggedElement = null;
    let menuOrder = [];
    let isDragging = false;

    function reorderMenuCards(){
      const menuGrid = document.getElementById('menu-grid');
      const cards = Array.from(menuGrid.querySelectorAll('.menu-card'));
      const map = new Map(cards.map(c => [c.dataset.menuId, c]));
      const ordered = [];
      menuOrder.forEach(id => { if(map.has(id)) ordered.push(map.get(id)); map.delete(id); });
      // append any new cards not in saved list
      for(const c of map.values()) ordered.push(c);
      ordered.forEach(c => menuGrid.appendChild(c));
    }

    function initDragAndDrop(){
      initMenuLock();

      const menuGrid = document.getElementById('menu-grid');
      const cards = menuGrid.querySelectorAll('.menu-card');

      const savedOrder = localStorage.getItem('menuOrder');
      if(savedOrder){
        try{
          menuOrder = JSON.parse(savedOrder) || [];
        }catch(e){
          menuOrder = [];
        }
        if(menuOrder.length) reorderMenuCards();
      }else{
        menuOrder = Array.from(cards).map(c => c.dataset.menuId);
      }

      cards.forEach(card => {
        card.removeAttribute('onclick');

        // click -> open page (unless dragging)
        card.addEventListener('click', function(){
          if(!isDragging) showPage(this.dataset.menuId);
          isDragging = false;
        });

        // keyboard accessibility
        card.addEventListener('keydown', function(e){
          if(e.key === 'Enter' || e.key === ' '){
            e.preventDefault();
            if(!isDragging) showPage(this.dataset.menuId);
          }
        });

        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
        card.addEventListener('dragover', handleDragOver);
        card.addEventListener('drop', handleDrop);
        card.addEventListener('dragenter', handleDragEnter);
        card.addEventListener('dragleave', handleDragLeave);

        // touch support
        card.addEventListener('touchstart', handleTouchStart, {passive:false});
        card.addEventListener('touchmove', handleTouchMove, {passive:false});
        card.addEventListener('touchend', handleTouchEnd, {passive:false});
      });
    }

    // Touch drag
    let touchStartX=0, touchStartY=0, touchMoved=false;

    function handleTouchStart(e){
      if(menuLocked) return;
      const touch=e.touches[0];
      touchStartX=touch.clientX;
      touchStartY=touch.clientY;
      touchMoved=false;
      draggedElement=this;
    }

    function handleTouchMove(e){
      if(menuLocked || !draggedElement) return;
      const touch=e.touches[0];
      const dx=Math.abs(touch.clientX-touchStartX);
      const dy=Math.abs(touch.clientY-touchStartY);

      if(dx>10 || dy>10){
        touchMoved=true;
        isDragging=true;
        e.preventDefault();
        draggedElement.classList.add('dragging');

        const below=document.elementFromPoint(touch.clientX, touch.clientY);
        const cardBelow=below ? below.closest('.menu-card') : null;

        document.querySelectorAll('.menu-card').forEach(c=>c.classList.remove('drag-over'));
        if(cardBelow && cardBelow !== draggedElement) cardBelow.classList.add('drag-over');
      }
    }

    function handleTouchEnd(e){
      if(!draggedElement) return;

      const touch=e.changedTouches[0];
      const below=document.elementFromPoint(touch.clientX, touch.clientY);
      const cardBelow=below ? below.closest('.menu-card') : null;

      draggedElement.classList.remove('dragging');
      document.querySelectorAll('.menu-card').forEach(c=>c.classList.remove('drag-over'));

      if(touchMoved && cardBelow && cardBelow !== draggedElement){
        const menuGrid=document.getElementById('menu-grid');
        const allCards=Array.from(menuGrid.querySelectorAll('.menu-card'));
        const draggedIndex=allCards.indexOf(draggedElement);
        const droppedIndex=allCards.indexOf(cardBelow);

        if(draggedIndex < droppedIndex) cardBelow.parentNode.insertBefore(draggedElement, cardBelow.nextSibling);
        else cardBelow.parentNode.insertBefore(draggedElement, cardBelow);

        const draggedId=draggedElement.dataset.menuId;
        menuOrder = Array.from(menuGrid.querySelectorAll('.menu-card')).map(c => c.dataset.menuId);
        localStorage.setItem('menuOrder', JSON.stringify(menuOrder));
      }

      setTimeout(()=>{ isDragging=false; touchMoved=false; }, 50);
      draggedElement=null;
    }

    // Mouse drag
    function handleDragStart(e){
      if(menuLocked) { e.preventDefault(); return; }
      draggedElement=this;
      isDragging=true;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed='move';
    }

    function handleDragEnd(){
      this.classList.remove('dragging');
      setTimeout(()=>{ isDragging=false; }, 50);
      document.querySelectorAll('.menu-card').forEach(c=>c.classList.remove('drag-over'));
    }

    function handleDragOver(e){
      e.preventDefault();
      e.dataTransfer.dropEffect='move';
      return false;
    }

    function handleDragEnter(){
      if(this !== draggedElement) this.classList.add('drag-over');
    }

    function handleDragLeave(){
      this.classList.remove('drag-over');
    }

    function handleDrop(e){
      e.preventDefault();
      e.stopPropagation();
      if(!draggedElement || draggedElement === this) return false;

      const menuGrid=document.getElementById('menu-grid');
      const allCards=Array.from(menuGrid.querySelectorAll('.menu-card'));
      const draggedIndex=allCards.indexOf(draggedElement);
      const droppedIndex=allCards.indexOf(this);

      if(draggedIndex < droppedIndex) this.parentNode.insertBefore(draggedElement, this.nextSibling);
      else this.parentNode.insertBefore(draggedElement, this);

      menuOrder = Array.from(menuGrid.querySelectorAll('.menu-card')).map(c => c.dataset.menuId);
      localStorage.setItem('menuOrder', JSON.stringify(menuOrder));

      document.querySelectorAll('.menu-card').forEach(c=>c.classList.remove('drag-over'));
      return false;
    }

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', () => {
      initDragAndDrop();
      restoreLastPage();
      // If you always want to land on menu, comment restoreLastPage() and call showPage('menu')
    });
  </script>
</body>
</html>


