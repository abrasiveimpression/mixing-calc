<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0ea5e9">
    <title>KPIT ICEMAN</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 50%, #7dd3fc 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; color: #0c4a6e; margin-bottom: 30px; position: relative; padding-top: 40px; }
        .update-btn {
            position: absolute;
            top: 0;
            left: 0;
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }
        .lock-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: #10b981;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }
        .lock-btn:hover {
            background: #059669;
        }
        .lock-btn.locked {
            background: #0ea5e9;
        }
        .lock-btn.locked:hover {
            background: #0ea5e9;
        }
        .update-btn:hover {
            background: #0284c7;
        }
        .page { display: none; }
        .page.active { display: block; }
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .menu-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            border: 2px solid rgba(186, 230, 253, 0.5);
            text-align: center;
            transition: all 0.2s;
        }
        .menu-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .menu-card {
            cursor: grab;
        }
        .menu-card:active {
            cursor: grabbing;
        }
        .menu-grid.drag-over {
            background: rgba(14, 165, 233, 0.1);
        }
        .menu-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
        }
        .menu-card h3 { color: #0369a1; margin-bottom: 0; font-size: 16px; }
        .back-button {
            background: rgba(255, 255, 255, 0.7);
            color: #0369a1;
            border: 2px solid rgba(186, 230, 253, 0.5);
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        .back-button:hover {
            background: rgba(255, 255, 255, 0.9);
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 24px;
        }
        input, textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 16px;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #0ea5e9;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            background: #f0f9ff;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .result-value { font-weight: 700; color: #0369a1; }
        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th, td { padding: 6px; border: 1px solid #e5e7eb; text-align: left; }
        th { background: #0ea5e9; color: white; border-color: #7dd3fc; }
        .version-badge {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            color: #6b7280;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
        }
        .pdf-link {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            background: #f0f9ff;
            border-radius: 10px;
            margin-bottom: 10px;
            text-decoration: none;
            color: #0369a1;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .pdf-link:hover {
            background: #e0f2fe;
            border-color: #0ea5e9;
        }
        .pdf-icon {
            font-size: 24px;
            margin-right: 12px;
        }
        .pdf-info {
            flex: 1;
        }
        .pdf-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
        }
        .pdf-desc {
            font-size: 12px;
            color: #6b7280;
        }
        .pdf-missing {
            padding: 20px;
            text-align: center;
            color: #9ca3af;
            font-size: 14px;
        }
        .iframe-container {
            width: 100%;
            height: 80vh;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            background: white;
            position: relative;
        }
        .iframe-container iframe {
            position: absolute;
            top: 0;
            left: 50%;
            width: 250%;
            height: 250%;
            border: none;
            transform: scale(0.4) translateX(-50%);
            transform-origin: top left;
        }
        .info-box {
            background: #f0f9ff;
            border-left: 4px solid #0ea5e9;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .info-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .info-value {
            font-size: 24px;
            font-weight: 700;
            color: #0369a1;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }
        .refresh-btn {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
        }
        .refresh-btn:hover {
            background: #0284c7;
        }

.btn-mode {
    background: white;
    color: #0369a1;
    border: 2px solid #e5e7eb;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    width: 100%;
    margin-bottom: 12px;
    transition: all 0.2s;
}
.btn-mode:hover {
    border-color: #0ea5e9;
    background: #f0f9ff;
}
.btn-mode.active {
    background: #0ea5e9;
    color: white;
    border-color: #0ea5e9;
}
        
        .metar-box {
            background: white;
            padding: 16px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            margin-top: 16px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            word-wrap: break-word;
        }
        .external-link-btn {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.2s;
        }
        .external-link-btn:hover {
            background: #059669;
        }
        .btn-primary {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            margin-bottom: 12px;
        }
        .btn-primary:hover {
            background: #0284c7;
        }
        .btn-secondary {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            margin-bottom: 12px;
        }
        .btn-secondary:hover {
            background: #059669;
        }
        .truck-result {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .truck-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }
        .truck-id {
            font-size: 18px;
            font-weight: 700;
            color: #0369a1;
        }
        .truck-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 600;
        }
        .status-success {
            background: #d1fae5;
            color: #065f46;
        }
        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }
        .truck-details {
            font-size: 13px;
            line-height: 1.8;
        }
        .truck-details-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }
        .truck-details-label {
            color: #6b7280;
        }
        .truck-details-value {
            font-weight: 600;
            color: #0369a1;
        }
        .fluid-add-box {
            background: #f0f9ff;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }
        .fluid-add-title {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
            font-weight: 600;

/* Gauge Match (Fill Station) */
.gauge-match-box{
    background:#fff7ed;
    border:2px solid #fed7aa;
    border-radius:10px;
    padding:12px;
    margin-top:12px;
}
.gm-toggle{
    display:flex;
    align-items:center;
    gap:10px;
    font-size:13px;
    font-weight:700;
    color:#92400e;
    cursor:pointer;
    user-select:none;
}
.gm-toggle input{ width:auto; margin:0; display:inline-block; flex:0 0 auto; }
.gm-toggle span{ display:inline; line-height:1.2; }
.gm-body{ margin-top:10px; }
.gm-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:8px;
}
.gm-label{ font-size:12px; color:#6b7280; }
.gm-input{
    width:160px;
    padding:10px 12px;
    border:2px solid #e5e7eb;
    border-radius:10px;
    font-size:14px;
    margin:0;
    text-align:right;
    background:white;
}
.gm-input:focus{ outline:none; border-color:#f97316; }
.gm-value{ font-weight:800; color:#92400e; }
.gm-hint{
    margin-top:8px;
    font-size:11px;
    color:#6b7280;
    line-height:1.4;
}
        }
        .summary-box {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
        }
        .summary-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
        }
        .summary-stat {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 14px;
        }
        .summary-stat-value {
            font-weight: 700;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="version-badge">v1.5.1</div>
    <div class="container">
  <div class="header">
            <button class="update-btn" onclick="updateApp()" aria-label="Update application">üîÑ Update</button>
            <h1>KPIT ICEMAN</h1>
            <button class="lock-btn" id="lock-btn" onclick="toggleMenuLock()" aria-label="Toggle menu lock">üîí</button>
        </div>
        
        <div class="page active" id="menu">
            <div class="menu-grid" id="menu-grid">
                <div class="menu-card" draggable="true" data-menu-id="increase" role="button" tabindex="0" aria-label="Increase Mix"><h3>Increase Mix</h3></div>
                <div class="menu-card" draggable="true" data-menu-id="decrease" role="button" tabindex="0" aria-label="Decrease Mix"><h3>Decrease Mix</h3></div>
                <div class="menu-card" draggable="true" data-menu-id="volume" role="button" tabindex="0" aria-label="Increase Volume"><h3>Increase Volume</h3></div>
                <div class="menu-card" draggable="true" data-menu-id="batch" role="button" tabindex="0" aria-label="Batch Trucks"><h3>üöö Batch Trucks</h3></div>
                <div class="menu-card" draggable="true" data-menu-id="tote" role="button" tabindex="0" aria-label="Tote to Truck"><h3>Tote to Truck</h3></div>
                <div class="menu-card" draggable="true" data-menu-id="truckboard" role="button" tabindex="0" aria-label="Truck Board"><h3>üöõ Truck Board</h3></div>
                <div class="menu-card" draggable="true" data-menu-id="truckboard-edit" role="button" tabindex="0" aria-label="Edit Truck Board"><h3>‚úèÔ∏è Edit Truck Board</h3></div>
                <div class="menu-card" draggable="true" data-menu-id="atis" role="button" tabindex="0" aria-label="ATIS & Weather"><h3>üì° ATIS & Weather</h3></div>
                <div class="menu-card" draggable="true" data-menu-id="history" role="button" tabindex="0" aria-label="History"><h3>üìã History</h3></div>
                <div class="menu-card" draggable="true" data-menu-id="dilution" role="button" tabindex="0" aria-label="Dilution Chart"><h3>üìä Dilution Chart</h3></div>
                <div class="menu-card" draggable="true" data-menu-id="aircraft" role="button" tabindex="0" aria-label="Aircraft Reference"><h3>‚úàÔ∏è Aircraft Reference</h3></div>
                <div class="menu-card" draggable="true" data-menu-id="airlines" role="button" tabindex="0" aria-label="Airline Codes"><h3>üõ´ Airline Codes</h3></div>
                <div class="menu-card" draggable="true" data-menu-id="pdfs" role="button" tabindex="0" aria-label="Documents & Links"><h3>üìÑ Documents & Links</h3></div>
                <div class="menu-card" draggable="true" data-menu-id="notes" role="button" tabindex="0" aria-label="Notes"><h3>üìù Notes</h3></div>
            </div>
        </div>

        <div class="page" id="increase">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="margin: 0;">Increase Mix</h2>
                    <button onclick="clearCalculator('increase')" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Clear</button>
                </div>
                <input type="number" inputmode="decimal" id="inc-cur" placeholder="Current Mix %" oninput="calcInc()" aria-label="Current mix percentage" min="0" max="100">
                <input type="number" inputmode="decimal" id="inc-des" placeholder="Desired Mix %" oninput="calcInc()" aria-label="Desired mix percentage" min="0" max="100">
                <input type="number" inputmode="decimal" id="inc-vol" placeholder="Current Volume" oninput="calcInc()" aria-label="Current volume in gallons" min="0">
                <div id="inc-result"></div>
            </div>
        </div>

        <div class="page" id="decrease">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="margin: 0;">Decrease Mix</h2>
                    <button onclick="clearCalculator('decrease')" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Clear</button>
                </div>
                <input type="number" inputmode="decimal" id="dec-cur" placeholder="Current Mix %" oninput="calcDec()" aria-label="Current mix percentage" min="0" max="100">
                <input type="number" inputmode="decimal" id="dec-des" placeholder="Desired Mix %" oninput="calcDec()" aria-label="Desired mix percentage" min="0" max="100">
                <input type="number" inputmode="decimal" id="dec-vol" placeholder="Current Volume" oninput="calcDec()" aria-label="Current volume in gallons" min="0">
                <div id="dec-result"></div>
            </div>
        </div>

        <div class="page" id="volume">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="margin: 0;">Increase Volume</h2>
                    <button onclick="clearCalculator('volume')" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Clear</button>
                </div>
                
                <div style="background: #f0f9ff; border-left: 4px solid #0ea5e9; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 13px;">
                    <strong>Current Mix:</strong> Enter either percentage OR freeze point
                </div>
                
                <input type="number" inputmode="decimal" id="vol-cur" placeholder="Current Mix %" oninput="handleVolCurInput()" aria-label="Current mix percentage" min="0" max="100">
                <input type="number" id="vol-cur-freeze" placeholder="OR Current Freeze Point (¬∞C)" oninput="handleVolCurFreezeInput()" aria-label="Current freeze point in Celsius" max="0">
                
                <input type="number" inputmode="decimal" id="vol-curv" placeholder="Current Volume" oninput="calcVol()" aria-label="Current volume in gallons" min="0">
                              

<div style="background: #f0f9ff; border-left: 4px solid #0ea5e9; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 13px;">
                    <strong>Wanted Mix:</strong> Enter either percentage OR freeze point
                </div>
                
                <input type="number" inputmode="decimal" id="vol-want" placeholder="Wanted Mix %" oninput="handleVolWantInput()" aria-label="Wanted mix percentage" min="0" max="100">
                <input type="number" id="vol-want-freeze" placeholder="OR Wanted Freeze Point (¬∞C)" oninput="handleVolWantFreezeInput()" aria-label="Wanted freeze point in Celsius" max="0">
                
                <input type="number" inputmode="decimal" id="vol-wantv" placeholder="Wanted Volume" oninput="calcVol()" aria-label="Wanted volume in gallons" min="0">
                                
                <div id="vol-result"></div>
            </div>
        </div>

        <!-- NEW: Batch Trucks Page -->
        <div class="page" id="batch">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2 style="margin: 0;">Batch Trucks</h2>
        <button onclick="clearBatchData()" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Clear</button>
    </div>
                
                <!-- Mode Selection -->
<div style="background: #f0f9ff; border-left: 4px solid #0ea5e9; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
    <div style="font-weight: 600; margin-bottom: 8px; color: #0369a1;">Select Processing Mode:</div>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
        <button class="btn-mode active" onclick="setBatchMode('increase-volume')">Increase Volume</button>
        <button class="btn-mode" onclick="setBatchMode('increase-mix')">Increase Mix</button>
        <button class="btn-mode" onclick="setBatchMode('decrease-mix')">Decrease Mix</button>
    </div>
</div>

<!--
 <div style="background: #f0f9ff; border-left: 4px solid #0ea5e9; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 13px;">
    <strong>Import from Google Sheets or enter manually below</strong><br>
    Imports: Truck ID (Col A) | Type I Gallons (Col F) | Freeze Point ¬∞C (Col C)
 </div>  
-->
    
<button class="btn-primary" onclick="importFromSheets()">üìä Import from Google Sheets</button>

<div style="text-align: center; margin: 16px 0; color: #9ca3af; font-size: 14px;">
    OR
</div>

<textarea id="batch-input" rows="8" placeholder="Enter truck data (one per line):
Truck 1, 500, -30
Truck 2, 450, 45%
Truck 3, 600, -25

Format: Truck ID, Type I Gallons, Freeze Point (¬∞C) OR Percentage" style="font-family: 'Courier New', monospace; font-size: 13px;"></textarea>

<div style="background: #f0f9ff; border-left: 4px solid #0ea5e9; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 13px;">
    <strong>Wanted Mix:</strong> Enter either percentage OR freeze point
</div>               

<input type="number" inputmode="decimal" id="batch-want-pct" placeholder="Wanted Mix %" aria-label="Wanted mix percentage" min="0" max="100">
<input type="number" id="batch-want-freeze" placeholder="OR Wanted Freeze Point (¬∞C)" aria-label="Wanted freeze point in Celsius" max="0">

<!-- This field is hidden for increase-mix and decrease-mix modes -->
<div id="batch-volume-field">
    <input type="number" inputmode="decimal" id="batch-want-vol" placeholder="Wanted Volume (gallons)" aria-label="Wanted volume in gallons" min="0">

    <!-- NEW: Auto target volume from max capacity minus gallons-from-top -->
    <div style="margin-top: 10px; background: rgba(14,165,233,0.08); border: 2px solid rgba(186,230,253,0.8); padding: 12px; border-radius: 10px;">
        <label style="display:flex; gap:10px; align-items:flex-start; cursor:pointer;">
            <input type="checkbox" id="batch-use-topoff" style="width:auto; margin: 2px 0 0 0;" onchange="handleBatchTopOffToggle()">
            <span style="font-size: 13px; color:#0369a1; line-height:1.4;">
                <strong>Use gallons-from-top</strong> (auto target volume)<br>
                Uses max capacity by truck ID:
                <span style="color:#6b7280;">900‚Äì3026 = 1900 gal</span>,
                <span style="color:#6b7280;">7000‚Äì7017 = 1850 gal</span>
            </span>
        </label>

        <div id="batch-topoff-field" style="display:none; margin-top:10px;">
            <input type="number" inputmode="decimal" id="batch-gallons-from-top"
                   placeholder="Gallons from top (e.g., 200)"
                   aria-label="Gallons from top"
                   min="0" step="1"
                   oninput="saveBatchInputs()">
            <div style="font-size: 12px; color:#6b7280; margin-top:6px;">
                Example: If gallons-from-top = 200, targets are 1700 (1900-cap) or 1650 (1850-cap)
            </div>
        </div>
    </div>
</div>


<button class="btn-secondary" onclick="processBatch()">üöÄ Process All Trucks</button>

<div id="batch-sort-controls" style="display: none; margin-top: 20px; background: rgba(255, 255, 255, 0.9); border-radius: 12px; padding: 16px; border: 2px solid #e5e7eb;">
    <div style="font-weight: 600; color: #0369a1; margin-bottom: 12px; font-size: 14px;">üìä Sort & Filter Results:</div>
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
        <button class="sort-btn active" onclick="sortBatchResults('default')" style="padding: 8px; border: 2px solid #0ea5e9; background: #0ea5e9; color: white; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">Default Order</button>
        <button class="sort-btn" onclick="sortBatchResults('pump-out')" style="padding: 8px; border: 2px solid #e5e7eb; background: white; color: #0369a1; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">Pump-Out First</button>
        <button class="sort-btn" onclick="sortBatchResults('water-only')" style="padding: 8px; border: 2px solid #e5e7eb; background: white; color: #0369a1; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">Water Only</button>
        <button class="sort-btn" onclick="sortBatchResults('glycol-only')" style="padding: 8px; border: 2px solid #e5e7eb; background: white; color: #0369a1; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">Glycol Only</button>
        <button class="sort-btn" onclick="sortBatchResults('mixed')" style="padding: 8px; border: 2px solid #e5e7eb; background: white; color: #0369a1; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">Mixed Fluid</button>
        <button class="sort-btn" onclick="sortBatchResults('largest-diff')" style="padding: 8px; border: 2px solid #e5e7eb; background: white; color: #0369a1; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">Largest % Diff</button>
    </div>
</div>

<div id="batch-results" style="margin-top: 20px;"></div>
            </div>
        </div>
        <div class="page" id="tote">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="margin: 0;">Tote to Truck</h2>
                    <button onclick="clearCalculator('tote')" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Clear</button>
                </div>
                <input type="number" inputmode="decimal" id="tote-tm" placeholder="Truck Mix %" oninput="calcTote()" aria-label="Truck mix percentage" min="0" max="100">
                <input type="number" inputmode="decimal" id="tote-tv" placeholder="Truck Volume" oninput="calcTote()" aria-label="Truck volume in gallons" min="0">
                <input type="number" inputmode="decimal" id="tote-ttm" placeholder="Tote Mix %" oninput="calcTote()" aria-label="Tote mix percentage" min="0" max="100">
                <input type="number" inputmode="decimal" id="tote-ttv" placeholder="Tote Volume" oninput="calcTote()" aria-label="Tote volume in gallons" min="0">
                <div id="tote-result"></div>
            </div>
        </div>

<div class="page" id="truckboard" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; padding: 0; margin: 0; background: white; z-index: 1000;">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 50%, #7dd3fc 100%);">
        <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu" style="margin: 0;">‚Üê Back</button>
        <div style="font-size: 11px; color: #6b7280;">
            Last refreshed: <span id="truckboard-time">--</span>
        </div>
        <button class="refresh-btn" onclick="refreshTruckBoard()" style="margin: 0;">üîÑ Refresh</button>
    </div>
    <div class="iframe-container" style="height: calc(100vh - 50px); border-radius: 0; border: none; margin: 0;">
        <iframe id="truckboard-iframe" src="https://script.google.com/macros/s/AKfycbwLAeS6nUomVV8IwKqNZ76DwpRq1JFGHsG010-Z51blqkWmebGVAs8bm7B-MzlbPKkhbA/exec?page=display" title="Truck Board Display" onload="updateTruckBoardTime()"></iframe>
    </div>
</div>


<div class="page" id="truckboard-edit">
    <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
    <div class="card">
        <h2 style="margin-bottom: 16px;">Edit Truck Board</h2>
        
        <div style="background: #f0f9ff; border-left: 4px solid #0ea5e9; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 13px;">
            üí° <strong>Tip:</strong> Select a truck to view its current data before editing
        </div>
        
        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #0369a1;">Select Truck:</label>
        <select id="truck-select" onchange="loadTruckData()" style="width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px; margin-bottom: 16px; cursor: pointer;">
            <option value="">-- Select a Truck --</option>
        </select>
        
<div id="current-truck-data" style="display: none; background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
    <div style="font-weight: 700; font-size: 16px; margin-bottom: 12px; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 8px;">Current Data for <span id="current-truck-id"></span></div>
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 14px;">
        <div>
            <div style="opacity: 0.9; font-size: 12px; margin-bottom: 4px;">Percent:</div>
            <div style="font-weight: 700; font-size: 18px;" id="current-percent">--</div>
        </div>
        <div>
            <div style="opacity: 0.9; font-size: 12px; margin-bottom: 4px;">Freeze Point:</div>
            <div style="font-weight: 700; font-size: 18px;" id="current-freeze">--</div>
        </div>
        <div>
            <div style="opacity: 0.9; font-size: 12px; margin-bottom: 4px;">Type I (gal):</div>
            <div style="font-weight: 700; font-size: 18px;" id="current-typei">--</div>
        </div>
        <div>
            <div style="opacity: 0.9; font-size: 12px; margin-bottom: 4px;">Type IV (gal):</div>
            <div style="font-weight: 700; font-size: 18px;" id="current-typeiv">--</div>
        </div>
    </div>
</div>
        
        <div style="width: 100%; height: 75vh; border: 2px solid #e5e7eb; border-radius: 10px; overflow: hidden; background: white;">
            <iframe src="https://tb.kpiticeman.com/" title="Truck Board Editor" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
        <a href="https://tb.kpiticeman.com/" target="_blank" class="external-link-btn">Open Editor in New Tab</a>
    </div>
</div>


        <div class="page" id="atis">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
<div class="card">
                <h2>ATIS & Weather</h2>
                <button class="refresh-btn" onclick="loadATIS()">üîÑ Refresh Data</button>
                
                    <!-- ATIS Letter Display -->
                    <div class="info-box" id="atis-info-box" style="display: none;">
                        <div class="info-label">ATIS Information</div>
                        <div class="info-value" id="atis-letter" style="font-size: 20px;">--</div>
                    </div>
                
<div class="info-box">
                        <div class="info-label">Temperature (KPIT)</div>
                        <div class="info-value" id="temperature">Loading...</div>
                    </div>
                    
                    <div class="info-box">
                        <div class="info-label">Dew Point (KPIT)</div>
                        <div class="info-value" id="dewpoint">Loading...</div>
                    </div>
                    
                    <div class="info-box">
                        <div class="info-label">Wind</div>
                        <div class="info-value" id="wind">Loading...</div>
                        <div id="wind-compass" style="margin-top: 16px; display: none;">
                            <svg width="200" height="200" viewBox="0 0 200 200" style="margin: 0 auto; display: block;">
                                <!-- Compass circle -->
                                <circle cx="100" cy="100" r="90" fill="#f0f9ff" stroke="#0ea5e9" stroke-width="2"/>
                                
                                <!-- Cardinal directions -->
                                <text x="100" y="25" text-anchor="middle" font-size="20" font-weight="bold" fill="#0369a1">N</text>
                                <text x="175" y="105" text-anchor="middle" font-size="20" font-weight="bold" fill="#0369a1">E</text>
                                <text x="100" y="185" text-anchor="middle" font-size="20" font-weight="bold" fill="#0369a1">S</text>
                                <text x="25" y="105" text-anchor="middle" font-size="20" font-weight="bold" fill="#0369a1">W</text>
                                
                                <!-- Degree markers -->
                                <line x1="100" y1="15" x2="100" y2="25" stroke="#6b7280" stroke-width="2"/>
                                <line x1="159.9" y1="25.9" x2="153.2" y2="32.6" stroke="#6b7280" stroke-width="1"/>
                                <line x1="184.1" y1="59.9" x2="177.4" y2="66.6" stroke="#6b7280" stroke-width="1"/>
                                <line x1="190" y1="100" x2="180" y2="100" stroke="#6b7280" stroke-width="2"/>
                                <line x1="184.1" y1="140.1" x2="177.4" y2="133.4" stroke="#6b7280" stroke-width="1"/>
                                <line x1="159.9" y1="174.1" x2="153.2" y2="167.4" stroke="#6b7280" stroke-width="1"/>
                                <line x1="100" y1="185" x2="100" y2="175" stroke="#6b7280" stroke-width="2"/>
                                <line x1="40.1" y1="174.1" x2="46.8" y2="167.4" stroke="#6b7280" stroke-width="1"/>
                                <line x1="15.9" y1="140.1" x2="22.6" y2="133.4" stroke="#6b7280" stroke-width="1"/>
                                <line x1="10" y1="100" x2="20" y2="100" stroke="#6b7280" stroke-width="2"/>
                                <line x1="15.9" y1="59.9" x2="22.6" y2="66.6" stroke="#6b7280" stroke-width="1"/>
                                <line x1="40.1" y1="25.9" x2="46.8" y2="32.6" stroke="#6b7280" stroke-width="1"/>
                                
                                <g id="wind-arrow" transform="rotate(0 100 100)">
    <!-- Shaft (longer & thicker) -->
    <line x1="100" y1="100" x2="100" y2="20"
          stroke="#ef4444" stroke-width="6" stroke-linecap="round"/>

    <!-- Arrow head (bigger) -->
    <polygon points="100,10 88,38 100,30 112,38"
             fill="#ef4444"/>

    <!-- Center hub -->
    <circle cx="100" cy="100" r="10" fill="#ef4444"/>
</g>

                            </svg>
                            <div style="text-align: center; margin-top: 8px; font-size: 14px; color: #0369a1; font-weight: 600;">
                                Wind from <span id="wind-direction-text">---</span>¬∞
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-box" id="precip-box" style="display: none;">
                        <div class="info-label">Precipitation</div>
                        <div class="info-value" id="precipitation">None</div>
                    </div>
                    
                    <h3 style="margin-top: 20px; margin-bottom: 10px; color: #0369a1;">Full METAR</h3>
                    <div class="metar-box" id="metar-full">Loading...</div>
                    
                    <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">
                        <div style="font-style: italic; margin-bottom: 4px;">
                            METAR observed: <span id="metar-observed">--</span>
                        </div>
                        <div style="font-style: italic;">
                            Last checked: <span id="metar-time">--</span>
                        </div>
                    </div>
                </div>
                
                <a href="https://ids6.pitairport.com/IDS5Status/?recover=dXNlcj1BT1VTRVImcHc9QU9QVw" target="_blank" class="external-link-btn">üì° View Full ATIS Display</a>
                
                <div style="margin-top: 12px;">
                    <p style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">Additional Weather Sources:</p>
                    <a href="https://forecast.weather.gov/MapClick.php?lat=40.49608000000006&lon=-80.25546999999995" target="_blank" class="external-link-btn" style="background: #0ea5e9; margin-bottom: 8px; display: block; text-align: center;">üå§Ô∏è National Weather Service - KPIT</a>
                    <a href="https://www.accuweather.com/en/us/pittsburgh-international-airport/15231/weather-forecast/2630488" target="_blank" class="external-link-btn" style="background: #0ea5e9; margin-bottom: 8px; display: block; text-align: center;">üå°Ô∏è AccuWeather - KPIT</a>      
                </div>
            </div>
        </div>

        <div class="page" id="history">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <h2>History</h2>
                <div id="history-list"></div>
                <button onclick="clearHistory()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; margin-top: 12px; cursor: pointer;" aria-label="Clear all history">Clear All</button>
            </div>
        </div>

        <div class="page" id="dilution">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <h2>Dilution Chart</h2>
                <div style="overflow-x: auto;"><table><thead><tr><th>Dilution</th><th>Refractive Index</th><th>Freeze Point</th><th>LOUT</th></tr></thead><tbody id="dilution-body"></tbody></table></div>
            </div>
        </div>

        <div class="page" id="aircraft">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <h2>Aircraft Reference</h2>
                <div style="overflow-x: auto;"><table><thead><tr><th>Carrier</th><th>Broom</th><th>Hoar</th><th>Type IV</th><th>Specifics</th></tr></thead><tbody id="aircraft-body"></tbody></table></div>
            </div>
        </div>

        <div class="page" id="airlines">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <h2>Airline Codes</h2>
                <div style="overflow-x: auto;"><table><thead><tr><th>Airline</th><th>Parent</th><th>Call Sign</th><th>Code</th></tr></thead><tbody id="airlines-body"></tbody></table></div>
            </div>
        </div>

        <div class="page" id="pdfs">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <h2>Documents & Links</h2>
                <h3 style="color: red;">Under Construction</h3>
            </div>
        </div>

        <div class="page" id="notes">
            <button class="back-button" onclick="showPage('menu')" aria-label="Back to menu">‚Üê Back</button>
            <div class="card">
                <h2>Notes</h2>
                <textarea id="notes-area" rows="15" placeholder="Type notes..." oninput="saveNotes()" aria-label="Field notes text area"></textarea>
                <div id="notes-status" style="color: #9ca3af; font-size: 13px;">Auto-saved</div>
            </div>
        </div>
    </div>

    <script>
        // Google Sheets Configuration
        const SHEETS_ID = '141e9AEoD3aluTHDRsyoTrIJHekM9Q5JGGANWfoCr_pY';

// Batch mode tracking
let currentBatchMode = 'increase-volume'; // default mode

function setBatchMode(mode) {
    currentBatchMode = mode;
    
    // Update button styling
    document.querySelectorAll('.btn-mode').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Show/hide wanted volume field
    const volumeField = document.getElementById('batch-volume-field');
    if (mode === 'increase-volume') {
        volumeField.style.display = 'block';
    } else {
        volumeField.style.display = 'none';
    }
    
    // *** NEW: Save the mode ***
    localStorage.setItem('batchMode', mode);
    
    // Clear results when switching modes
    document.getElementById('batch-results').innerHTML = '';
    document.getElementById('batch-sort-controls').style.display = 'none';
}

// ========== NEW BATCH PERSISTENCE FUNCTIONS ==========

/**
 * Save all batch input fields to localStorage
 */
function saveBatchInputs() {
    const batchData = {
        mode: currentBatchMode,
        input: document.getElementById('batch-input').value,
        wantPct: document.getElementById('batch-want-pct').value,
        wantFreeze: document.getElementById('batch-want-freeze').value,
        wantVol: document.getElementById('batch-want-vol').value,

        // NEW
        useTopOff: document.getElementById('batch-use-topoff')?.checked || false,
        gallonsFromTop: document.getElementById('batch-gallons-from-top')?.value || ''
    };
    localStorage.setItem('batchInputs', JSON.stringify(batchData));
}

/**
 * Save batch processing results to localStorage
 */
function saveBatchResults() {
    if (batchResultsData && batchResultsData.length > 0) {
        const resultsData = {
            results: batchResultsData,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem('batchResults', JSON.stringify(resultsData));
    }
}

/**
 * Restore batch page state from localStorage
 */
function restoreBatchPage() {
    // Restore mode selection
    const savedMode = localStorage.getItem('batchMode');
    if (savedMode) {
        currentBatchMode = savedMode;
        
        // Update mode buttons to match saved mode
        document.querySelectorAll('.btn-mode').forEach(btn => {
            btn.classList.remove('active');
            const btnText = btn.textContent.toLowerCase();
            const modeText = savedMode.replace('-', ' ');
            if (btnText.includes(modeText)) {
                btn.classList.add('active');
            }
        });
        
        // Show/hide volume field based on mode
        const volumeField = document.getElementById('batch-volume-field');
        volumeField.style.display = savedMode === 'increase-volume' ? 'block' : 'none';
    }
    
    // Restore input field values
    const savedInputs = localStorage.getItem('batchInputs');
    if (savedInputs) {
        try {
            const batchData = JSON.parse(savedInputs);
            document.getElementById('batch-input').value = batchData.input || '';
            document.getElementById('batch-want-pct').value = batchData.wantPct || '';
            document.getElementById('batch-want-freeze').value = batchData.wantFreeze || '';
            document.getElementById('batch-want-vol').value = batchData.wantVol || '';
            // NEW: Restore top-off fields
const cb = document.getElementById('batch-use-topoff');
const gft = document.getElementById('batch-gallons-from-top');

if (cb) cb.checked = !!batchData.useTopOff;
if (gft) gft.value = batchData.gallonsFromTop || '';

// Apply UI state (show/hide + disable manual wanted volume)
handleBatchTopOffToggle();

        } catch (e) {
            console.error('Error restoring batch inputs:', e);
        }
    }

    
    // Restore previous results if they exist
    const savedResults = localStorage.getItem('batchResults');
    if (savedResults) {
        try {
            const resultsData = JSON.parse(savedResults);
            batchResultsData = resultsData.results;
            
            if (batchResultsData && batchResultsData.length > 0) {
                const wantedMix = batchResultsData[0]?.wantedMix || 0;
                const wantedVol = batchResultsData[0]?.wantedVolume || null;
                
                // Display the restored results
                displayBatchResults(batchResultsData, wantedMix, wantedVol);
                
                // Add timestamp footer to show when results were calculated
                const timestamp = new Date(resultsData.timestamp);
                const timeStr = timestamp.toLocaleString();
                const resultsDiv = document.getElementById('batch-results');
                const timestampDiv = document.createElement('div');
                timestampDiv.style.cssText = 'text-align: center; color: #6b7280; font-size: 12px; margin-top: 16px; padding: 12px; background: rgba(156, 163, 175, 0.1); border-radius: 8px; font-style: italic;';
                timestampDiv.innerHTML = `üìÖ Previous results from: ${timeStr}<br><span style="font-size: 11px; color: #9ca3af;">Process trucks again to update</span>`;
                resultsDiv.appendChild(timestampDiv);
            }
        } catch (e) {
            console.error('Error restoring batch results:', e);
        }
    }
}

/**
 * Clear all saved batch data
 */
function clearBatchData() {
    if (confirm('Clear all batch truck data and results?\n\nThis will erase:\n‚Ä¢ Input data\n‚Ä¢ Mode selection\n‚Ä¢ Calculated results')) {
        // Remove from localStorage
        localStorage.removeItem('batchMode');
        localStorage.removeItem('batchInputs');
        localStorage.removeItem('batchResults');
        
        // Reset to defaults
        currentBatchMode = 'increase-volume';
        document.getElementById('batch-input').value = '';
        document.getElementById('batch-want-pct').value = '';
        document.getElementById('batch-want-freeze').value = '';
        document.getElementById('batch-want-vol').value = '';
   
        // Reset top-off UI
const cb = document.getElementById('batch-use-topoff');
const gft = document.getElementById('batch-gallons-from-top');
if (cb) cb.checked = false;
if (gft) gft.value = '';
handleBatchTopOffToggle();

        document.getElementById('batch-results').innerHTML = '';
        document.getElementById('batch-sort-controls').style.display = 'none';
        batchResultsData = [];
        
        // Reset mode buttons
        document.querySelectorAll('.btn-mode').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector('.btn-mode').classList.add('active');
        document.getElementById('batch-volume-field').style.display = 'block';
        
        // Show confirmation
        document.getElementById('batch-results').innerHTML = '<div style="background: #d1fae5; color: #065f46; padding: 16px; border-radius: 8px; text-align: center; font-weight: 600;">‚úì All batch data cleared</div>';
    }
}

// ========== END NEW BATCH PERSISTENCE FUNCTIONS ==========

// NEW: Calculate Increase Mix (keeps volume constant, adds only glycol)

function calculateIncreaseMix(truckId, curMix, curVol, wantMix) {
    try {
        const validations = [
            validateInput(curMix, 'Current mix', 0, 100),
            validateInput(wantMix, 'Wanted mix', 0, 100),
            validateInput(curVol, 'Current volume', 0.1)
        ];
        
        for (let validation of validations) {
            if (!validation.valid) {
                return {
                    truckId: truckId,
                    success: false,
                    error: validation.message
                };
            }
        }
        
        if (wantMix <= curMix) {
            return {
                truckId: truckId,
                success: false,
                error: 'Wanted mix must be greater than current mix for Increase Mix mode'
            };
        }
        
        // Calculate glycol to add (standard increase mix formula)
        const glycolToAdd = curVol * ((wantMix - curMix) / (100 - wantMix));
        const newTotalVolume = curVol + glycolToAdd;
        
        return {
            truckId: truckId,
            success: true,
            currentMix: curMix,
            currentVolume: curVol,
            wantedMix: wantMix,
            wantedVolume: newTotalVolume,
            percentToAdd: 100, // Pure glycol
            volumeToAdd: glycolToAdd,
            typeIToAdd: glycolToAdd,
            waterToAdd: 0,
            pumpOutAmount: 0,
            pumpOutMode: null
        };
    } catch (error) {
        return {
            truckId: truckId,
            success: false,
            error: error.message
        };
    }
}

// NEW: Calculate Decrease Mix (keeps volume constant, adds only water)
function calculateDecreaseMix(truckId, curMix, curVol, wantMix) {
    try {
        const validations = [
            validateInput(curMix, 'Current mix', 0, 100),
            validateInput(wantMix, 'Wanted mix', 0, 100),
            validateInput(curVol, 'Current volume', 0.1)
        ];
        
        for (let validation of validations) {
            if (!validation.valid) {
                return {
                    truckId: truckId,
                    success: false,
                    error: validation.message
                };
            }
        }
        
        if (wantMix >= curMix) {
            return {
                truckId: truckId,
                success: false,
                error: 'Wanted mix must be less than current mix for Decrease Mix mode'
            };
        }
        
        if (wantMix === 0) {
            return {
                truckId: truckId,
                success: false,
                error: 'Wanted mix cannot be zero'
            };
        }
        
        // Calculate water to add (standard decrease mix formula)
        const waterToAdd = curVol * ((curMix - wantMix) / wantMix);
        const newTotalVolume = curVol + waterToAdd;
        
        return {
            truckId: truckId,
            success: true,
            currentMix: curMix,
            currentVolume: curVol,
            wantedMix: wantMix,
            wantedVolume: newTotalVolume,
            percentToAdd: 0, // Pure water
            volumeToAdd: waterToAdd,
            typeIToAdd: 0,
            waterToAdd: waterToAdd,
            pumpOutAmount: 0,
            pumpOutMode: null
        };
    } catch (error) {
        return {
            truckId: truckId,
            success: false,
            error: error.message
        };
    }
}
        
function showPage(p) {
    document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
    document.getElementById(p).classList.add('active');
    
    // Save the current page
    saveCurrentPage(p);
    
    if(p==='notes')loadNotes();if(p==='history')displayHistory();
    if(p==='dilution')loadDilution();if(p==='aircraft')loadAircraft();if(p==='airlines')loadAirlines();
    if(p==='pdfs')loadPdfs();if(p==='atis')loadATIS();if(p==='truckboard-edit')loadTruckList();
    if(p==='batch')restoreBatchPage(); // *** NEW: Restore batch page data ***
    restorePageInputs(p);
}

// Save current page when navigating
function saveCurrentPage(pageId) {
    localStorage.setItem('currentPage', pageId);
}
        function saveInput(pageId, inputId, value) {
            const key = `input_${pageId}_${inputId}`;
            localStorage.setItem(key, value);
        }

        function restorePageInputs(pageId) {
            const page = document.getElementById(pageId);
            if (!page) return;
            
            page.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
                const key = `input_${pageId}_${input.id}`;
                const savedValue = localStorage.getItem(key);
                if (savedValue !== null) {
                    input.value = savedValue;
                }
            });
            
            page.querySelectorAll('input[type="checkbox"]').forEach(input => {
                const key = `input_${pageId}_${input.id}`;
                const savedValue = localStorage.getItem(key);
                if (savedValue !== null) {
                    input.checked = savedValue === 'true';
                }
            });
            
            if (pageId === 'increase' && document.getElementById('inc-cur').value) {
                calcInc();
            } else if (pageId === 'decrease' && document.getElementById('dec-cur').value) {
                calcDec();
            } else if (pageId === 'volume' && document.getElementById('vol-cur').value) {
                calcVol();
            } else if (pageId === 'tote' && document.getElementById('tote-tm').value) {
                calcTote();
            }
        }

        function clearCalculator(pageId) {
            const page = document.getElementById(pageId);
            if (!page) return;
            
            page.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
                input.value = '';
                const key = `input_${pageId}_${input.id}`;
                localStorage.removeItem(key);
            });
            
            page.querySelectorAll('input[type="checkbox"]').forEach(input => {
                input.checked = false;
                const key = `input_${pageId}_${input.id}`;
                localStorage.removeItem(key);
            });
            
            if (pageId === 'increase') {
                document.getElementById('inc-result').innerHTML = '';
            } else if (pageId === 'decrease') {
                document.getElementById('dec-result').innerHTML = '';
            } else if (pageId === 'volume') {
                document.getElementById('vol-result').innerHTML = '';
            } else if (pageId === 'tote') {
                document.getElementById('tote-result').innerHTML = '';
            }
        }

        function validateInput(value, name, min = 0, max = null) {
            if (isNaN(value) || value < min) {
                return { valid: false, message: `${name} must be at least ${min}` };
            }
            if (max !== null && value > max) {
                return { valid: false, message: `${name} cannot exceed ${max}` };
            }
            return { valid: true };
        }

        // NEW: Batch Processing Functions
        async function importFromSheets() {
            const resultsDiv = document.getElementById('batch-results');
            resultsDiv.innerHTML = '<div class="loading">üì• Loading data from Google Sheets...</div>';
            
            try {
                const url = `https://docs.google.com/spreadsheets/d/${SHEETS_ID}/gviz/tq?tqx=out:csv`;
                
                const response = await fetch(url);
                const csvText = await response.text();
                
                const lines = csvText.trim().split('\n');
                const dataLines = lines.slice(1);
                
let importedData = '';
dataLines.forEach(line => {
    const values = line.replace(/"/g, '').split(',');
    
    if (values.length >= 7 && values[0].trim()) {
        const truckId = values[0].trim();           // Column A: ID
        
        // Column F (index 5) = Total Volume in truck
        let totalVolume = values[5].trim();
        
        // If value at index 5 is short (like just "1"), check if next value completes it (comma-formatted number)
        if (totalVolume.length <= 2 && values[6] && values[6].match(/^\d{3}/)) {
            totalVolume = totalVolume + values[6].substring(0, 3);
        }
        
        // Column B (index 1) = Current Percent (use this directly, not freeze point)
        const currentPercent = values[1].trim();    // Column B: Percent
        
importedData += `${truckId}, ${totalVolume}, ${currentPercent}%\n`;
    }
});                
                document.getElementById('batch-input').value = importedData.trim();
                
                // *** NEW: Save the imported data ***
                saveBatchInputs();
                
                resultsDiv.innerHTML = '<div style="background: #d1fae5; color: #065f46; padding: 12px; border-radius: 8px; text-align: center; font-weight: 600;">‚úì Data imported successfully! Now enter wanted mix and volume, then click "Process All Trucks"</div>';
                
            } catch (error) {
                console.error('Import error:', error);
                resultsDiv.innerHTML = `<div class="error-message">
                    <strong>Import Failed</strong><br>
                    Unable to import from Google Sheets. Please make sure the spreadsheet is publicly accessible or enter data manually.<br><br>
                    <small>Error: ${error.message}</small>
                </div>`;
            }
        }

// ===================== NEW: TOP-OFF / MAX-CAPACITY LOGIC =====================

function getTruckMaxCapacity(truckId) {
    // Extract first number sequence from the truck ID (e.g., "Truck 900" -> 900)
    const match = String(truckId).match(/\d+/);
    const n = match ? parseInt(match[0], 10) : NaN;

    if (!isNaN(n)) {
        if (n >= 900 && n <= 3026) return 1900;
        if (n >= 7000 && n <= 7017) return 1850;
    }

    // Fallback default (safe default). Adjust if you want different behavior.
    return 1900;
}

function handleBatchTopOffToggle() {
    const cb = document.getElementById('batch-use-topoff');
    const field = document.getElementById('batch-topoff-field');
    const wantVolInput = document.getElementById('batch-want-vol');

    if (!cb || !field) return;

    const enabled = cb.checked;
    field.style.display = enabled ? 'block' : 'none';

    // If enabled, disable manual wanted volume to avoid conflicting inputs
    if (wantVolInput) {
        wantVolInput.disabled = enabled;
        wantVolInput.style.opacity = enabled ? '0.6' : '1';
    }

    saveBatchInputs();
}

        
        
function processBatch() {
    const input = document.getElementById('batch-input').value.trim();
    const wantPct = document.getElementById('batch-want-pct').value;
    const wantFreeze = document.getElementById('batch-want-freeze').value;
    const wantVol = parseFloat(document.getElementById('batch-want-vol').value);
    const pumpOutChecked = true; //Always user pump-out optimization when beneficial
    const resultsDiv = document.getElementById('batch-results');
            
            if (!input) {
                resultsDiv.innerHTML = '<div class="error-message">Please enter truck data or import from Google Sheets</div>';
                return;
            }
            
if (!wantPct && !wantFreeze) {
    resultsDiv.innerHTML = '<div class="error-message">Please enter wanted mix (percentage or freeze point)</div>';
    return;
}

// For increase-volume mode, check for wanted volume
// For increase-volume mode, require either wanted volume OR top-off mode
if (currentBatchMode === 'increase-volume') {
    const useTopOff = document.getElementById('batch-use-topoff')?.checked || false;

    if (useTopOff) {
        const gftRaw = document.getElementById('batch-gallons-from-top')?.value;
        const gallonsFromTop = parseFloat(gftRaw);

        if (gftRaw === '' || isNaN(gallonsFromTop) || gallonsFromTop < 0) {
            resultsDiv.innerHTML = '<div class="error-message">Please enter a valid "Gallons from top" (0 or greater)</div>';
            return;
        }
    } else {
        const wantVol = parseFloat(document.getElementById('batch-want-vol').value);
        if (!wantVol) {
            resultsDiv.innerHTML = '<div class="error-message">Please enter wanted volume for Increase Volume mode (or enable gallons-from-top)</div>';
            return;
        }
    }
}
            
            let wantedMixPct;
            if (wantPct) {
                wantedMixPct = parseFloat(wantPct);
            } else {
                wantedMixPct = freezePointToPercentage(parseFloat(wantFreeze));
            }
            
            const lines = input.split('\n');
const trucks = [];

lines.forEach((line, index) => {
    const parts = line.split(',').map(s => s.trim());
    if (parts.length >= 3) {
        const truckId = parts[0];
        const currentVolume = parseFloat(parts[1]);  // Column F: TOTAL VOLUME in truck
        const freezeOrPct = parts[2];
        
        let currentMixPct;
        if (freezeOrPct.includes('%')) {
            currentMixPct = parseFloat(freezeOrPct.replace('%', ''));
        } else if (freezeOrPct.includes('-')) {
            currentMixPct = freezePointToPercentage(parseFloat(freezeOrPct));
        } else {
            currentMixPct = parseFloat(freezeOrPct);
        }
        
        if (!isNaN(currentVolume) && !isNaN(currentMixPct)) {
            trucks.push({
                id: truckId,
                typeIGallons: currentVolume * (currentMixPct / 100),  // Calculate Type I from total
                currentMixPct: currentMixPct,
                currentVolume: currentVolume  // THIS IS THE KEY - use imported volume directly!
            });
        }
    }
});            
            if (trucks.length === 0) {
                resultsDiv.innerHTML = '<div class="error-message">No valid truck data found. Please check your input format.</div>';
                return;
            }
            
let results;

if (currentBatchMode === 'increase-mix') {
    // Increase Mix mode - only add glycol
    results = trucks.map(truck => {
        return calculateIncreaseMix(truck.id, truck.currentMixPct, truck.currentVolume, wantedMixPct);
    });
} else if (currentBatchMode === 'decrease-mix') {
    // Decrease Mix mode - only add water
    results = trucks.map(truck => {
        return calculateDecreaseMix(truck.id, truck.currentMixPct, truck.currentVolume, wantedMixPct);
    });
} else {
    // Increase Volume mode - target volume can be manual OR max-cap minus gallons-from-top
    const useTopOff = document.getElementById('batch-use-topoff')?.checked || false;
    const gallonsFromTop = useTopOff
        ? parseFloat(document.getElementById('batch-gallons-from-top')?.value)
        : null;

    const manualWantVol = parseFloat(document.getElementById('batch-want-vol').value);

    results = trucks.map(truck => {
        let targetVol = manualWantVol;

        if (useTopOff) {
            const maxCap = getTruckMaxCapacity(truck.id);
            targetVol = maxCap - gallonsFromTop;
        }

        // Defensive: ensure target volume is valid and > current volume
        if (!targetVol || isNaN(targetVol) || targetVol <= 0) {
            return {
                truckId: truck.id,
                success: false,
                error: `Invalid target volume calculated for ${truck.id}. Check gallons-from-top value.`
            };
        }

        return calculateTruckMix(
            truck.id,
            truck.currentMixPct,
            truck.currentVolume,
            wantedMixPct,
            targetVol,
            true // pumpOutChecked
        );
    });
}
            
const useTopOff = document.getElementById('batch-use-topoff')?.checked || false;
displayBatchResults(
    results,
    wantedMixPct,
    (currentBatchMode === 'increase-volume' && !useTopOff)
        ? parseFloat(document.getElementById('batch-want-vol').value)
        : null
);

// *** NEW: Save inputs and results ***
saveBatchInputs();
saveBatchResults();

// Save each successful truck to history individually
results.forEach(result => {
    if (result.success) {
        saveToHistory('Batch', {
    truckId: result.truckId,
    mode: currentBatchMode,
    curMix: result.currentMix.toFixed(1),
    curVol: result.currentVolume.toFixed(0),
    wantMix: result.wantedMix.toFixed(1),
    wantVol: result.wantedVolume || result.currentVolume,
    vol: Math.round(result.volumeToAdd),
    pct: result.percentToAdd ? result.percentToAdd.toFixed(0) : 'N/A',
    water: Math.round(result.waterToAdd || 0),
    typeI: Math.round(result.typeIToAdd || 0),
    pumpOut: result.pumpOutAmount ? result.pumpOutAmount.toFixed(0) : 0
});
    }
});
        }

        function calculateTruckMix(truckId, curMix, curVol, wantMix, wantVol, pumpOutChecked = false) {
    try {
        const validations = [
            validateInput(curMix, 'Current mix', 0, 100),
            validateInput(wantMix, 'Wanted mix', 0, 100),
            validateInput(curVol, 'Current volume', 0.1),
            validateInput(wantVol, 'Wanted volume', 0.1)
        ];
        
        for (let validation of validations) {
            if (!validation.valid) {
                return {
                    truckId: truckId,
                    success: false,
                    error: validation.message
                };
            }
        }
        
// Handle pump-out if checked
let pumpOutAmount = 0;
let pumpOutMode = null;
let effectiveCurVol = curVol;

if (pumpOutChecked) {
    if (wantMix < curMix) {
        pumpOutMode = 'water-only';
    } else if (wantMix > curMix) {
        pumpOutMode = 'glycol-only';
    }
    
    if (pumpOutMode) {
        pumpOutAmount = calculateAutoPumpOut(curMix, curVol, wantMix, wantVol, pumpOutMode);
        
        // If pump-out not feasible or exceeds volume, fall back to normal mixed-fluid mode
        if (pumpOutAmount === null || pumpOutAmount <= 0 || pumpOutAmount >= curVol) {
            pumpOutAmount = 0;
            pumpOutMode = null;
        } else {
            effectiveCurVol = curVol - pumpOutAmount;
        }
    }
}        
// NEW: Handle same percentage case (volume increase only)
if (curMix === wantMix) {
    if (wantVol <= curVol) {
        return {
            truckId: truckId,
            success: false,
            error: 'Wanted volume must be greater than current volume'
        };
    }
    
    const volumeToAdd = wantVol - curVol;
    const typeIToAdd = volumeToAdd * (curMix / 100);
    const waterToAdd = volumeToAdd * ((100 - curMix) / 100);
    
    return {
        truckId: truckId,
        success: true,
        currentMix: curMix,
        currentVolume: curVol,
        wantedMix: wantMix,
        wantedVolume: wantVol,
        percentToAdd: curMix,
        volumeToAdd: volumeToAdd,
        typeIToAdd: typeIToAdd,
        waterToAdd: waterToAdd,
        pumpOutAmount: 0,
        pumpOutMode: null
    };
}
        
        const cm = curMix / 100;
        const wm = wantMix / 100;
        
        const d4 = cm * effectiveCurVol;
        const d5 = wm * wantVol;
        const d6 = d5 - d4;
        
        const e4 = effectiveCurVol - d4;
        const e5 = wantVol - d5;
        const e6 = e5 - e4;
        
        const percentToAdd = (d6 / (d6 + e6)) * 100;
        const volumeToAdd = d6 + e6;
        const typeIToAdd = d6;
        const waterToAdd = e6;
        
        return {
            truckId: truckId,
            success: true,
            currentMix: curMix,
            currentVolume: curVol,
            wantedMix: wantMix,
            wantedVolume: wantVol,
            percentToAdd: percentToAdd,
            volumeToAdd: volumeToAdd,
            typeIToAdd: typeIToAdd,
            waterToAdd: waterToAdd,
            pumpOutAmount: pumpOutAmount,
            pumpOutMode: pumpOutMode
        };
    } catch (error) {
        return {
            truckId: truckId,
            success: false,
            error: error.message
        };
    }
}

let batchResultsData = []; // Store results globally for sorting

function displayBatchResults(results, wantedMix, wantedVol) {
    batchResultsData = results; // Store for sorting
    const sortControls = document.getElementById('batch-sort-controls');
    sortControls.style.display = 'block'; // Show sort controls
    
    renderBatchResults(results, wantedMix, wantedVol);
}

function sortBatchResults(sortType) {
    // Update active button styling
    document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.style.background = 'white';
        btn.style.color = '#0369a1';
        btn.style.borderColor = '#e5e7eb';
        btn.classList.remove('active');
    });
    event.target.style.background = '#0ea5e9';
    event.target.style.color = 'white';
    event.target.style.borderColor = '#0ea5e9';
    event.target.classList.add('active');
    
    let sortedResults = [...batchResultsData];
    
    switch(sortType) {
        case 'default':
            // Keep original order (already in sortedResults)
            break;
            
        case 'pump-out':
            // Pump-out trucks first, then others
            sortedResults.sort((a, b) => {
                const aPumpOut = a.pumpOutAmount && a.pumpOutAmount > 0 ? 1 : 0;
                const bPumpOut = b.pumpOutAmount && b.pumpOutAmount > 0 ? 1 : 0;
                return bPumpOut - aPumpOut;
            });
            break;
            
        case 'water-only':
            // Water only first (pump-out with 0 glycol), then others
            sortedResults.sort((a, b) => {
                const aWaterOnly = (a.pumpOutMode === 'water-only' && Math.round(a.typeIToAdd) === 0) ? 1 : 0;
                const bWaterOnly = (b.pumpOutMode === 'water-only' && Math.round(b.typeIToAdd) === 0) ? 1 : 0;
                return bWaterOnly - aWaterOnly;
            });
            break;
            
        case 'glycol-only':
            // Glycol only first (pump-out with 0 water), then others
            sortedResults.sort((a, b) => {
                const aGlycolOnly = (a.pumpOutMode === 'glycol-only' && Math.round(a.waterToAdd) === 0) ? 1 : 0;
                const bGlycolOnly = (b.pumpOutMode === 'glycol-only' && Math.round(b.waterToAdd) === 0) ? 1 : 0;
                return bGlycolOnly - aGlycolOnly;
            });
            break;
            
        case 'mixed':
            // Mixed fluid (no pump-out) first, then others
            sortedResults.sort((a, b) => {
                const aMixed = (!a.pumpOutMode || a.pumpOutAmount === 0) ? 1 : 0;
                const bMixed = (!b.pumpOutMode || b.pumpOutAmount === 0) ? 1 : 0;
                return bMixed - aMixed;
            });
            break;
            
        case 'largest-diff':
            // Largest percentage difference first
            sortedResults.sort((a, b) => {
                const aDiff = Math.abs(a.wantedMix - a.currentMix);
                const bDiff = Math.abs(b.wantedMix - b.currentMix);
                return bDiff - aDiff;
            });
            break;
    }
    
    // Re-render with sorted results
    const wantedMix = sortedResults[0]?.wantedMix || 0;
    const wantedVol = sortedResults[0]?.wantedVolume || 0;
    renderBatchResults(sortedResults, wantedMix, wantedVol);
}

function makeSafeId(s) {
    return String(s || '').replace(/[^a-zA-Z0-9_-]/g, '_');
}

const GM_STORAGE_PREFIX = 'kpit_gaugeMatch_v1';

function gmKey(truckId) {
    // Reserved for future: station-specific keys
    return `${GM_STORAGE_PREFIX}:${truckId}:default`;
}

function loadGaugeMatch(truckId) {
    try {
        const raw = localStorage.getItem(gmKey(truckId));
        if (!raw) return { enabled: false, offset: 0 };
        const parsed = JSON.parse(raw);
        return {
            enabled: !!parsed.enabled,
            offset: Number(parsed.offset) || 0
        };
    } catch (e) {
        return { enabled: false, offset: 0 };
    }
}

function saveGaugeMatch(truckId, state) {
    try {
        localStorage.setItem(gmKey(truckId), JSON.stringify({
            enabled: !!state.enabled,
            offset: Number(state.offset) || 0
        }));
    } catch (e) {}
}

function roundGallons(x) {
    const n = Number(x);
    return Number.isFinite(n) ? Math.round(n) : NaN;
}

function formatSigned(n) {
    if (!Number.isFinite(n)) return '--';
    const r = Math.round(n);
    return (r >= 0 ? '+' : '') + r;
}

function setupGaugeMatchDelegation() {
    if (setupGaugeMatchDelegation._wired) return;
    setupGaugeMatchDelegation._wired = true;

    const resultsDiv = document.getElementById('batch-results');
    if (!resultsDiv) return;

    // Toggle on/off
    resultsDiv.addEventListener('change', (e) => {
        const el = e.target;
        if (!el || !el.classList || !el.classList.contains('gm-enable')) return;

        const card = el.closest('.truck-result');
        if (!card) return;

        const truckId = card.dataset.truckid;
        const body = card.querySelector('.gm-body');
        const nowInput = card.querySelector('.gm-now');

        const state = loadGaugeMatch(truckId);
        state.enabled = !!el.checked;
        saveGaugeMatch(truckId, state);

        if (body) body.style.display = state.enabled ? '' : 'none';

        
        // If disabling, revert the displayed step totals back to true totals
        if (!state.enabled) {
            const aw = card.querySelector('.gm-after-water');
            const at = card.querySelector('.gm-after-type');
            const awTrue = roundGallons(card.dataset.afterwatertrue);
            const atTrue = roundGallons(card.dataset.aftertypetrue);
            if (aw && Number.isFinite(awTrue)) aw.textContent = `${awTrue} total`;
            if (at && Number.isFinite(atTrue)) at.textContent = `${atTrue} total`;
        }
if (state.enabled && nowInput) {
            // Prefill gauge-now based on stored offset (if any)
            const trueCurrent = roundGallons(card.dataset.truecurrent);
            const offset = Number(state.offset) || 0;
            const prefill = roundGallons(trueCurrent + offset);
            nowInput.value = Number.isFinite(prefill) ? String(prefill) : '';
            nowInput.dispatchEvent(new Event('input', { bubbles: true }));
        }
    });

    // Live updates from "Gauge now"
    resultsDiv.addEventListener('input', (e) => {
        const el = e.target;
        if (!el || !el.classList || !el.classList.contains('gm-now')) return;

        const card = el.closest('.truck-result');
        if (!card) return;

        const truckId = card.dataset.truckid;
        const enabled = !!card.querySelector('.gm-enable')?.checked;
        if (!enabled) return;

        const trueCurrent = roundGallons(card.dataset.truecurrent);
        const trueTarget = roundGallons(card.dataset.truetarget);
        const gaugeNow = roundGallons(el.value);

        const aw = card.querySelector('.gm-after-water');
        const at = card.querySelector('.gm-after-type');
        const awTrue = roundGallons(card.dataset.afterwatertrue);
        const atTrue = roundGallons(card.dataset.aftertypetrue);

        if (!Number.isFinite(trueCurrent) || !Number.isFinite(gaugeNow) || !Number.isFinite(awTrue) || !Number.isFinite(atTrue)) {
            // If input is invalid, fall back to true totals
            if (aw) aw.textContent = Number.isFinite(awTrue) ? `${awTrue} total` : '-- total';
            if (at) at.textContent = Number.isFinite(atTrue) ? `${atTrue} total` : '-- total';
            return;
        }

        const offset = gaugeNow - trueCurrent;

        // Persist
        saveGaugeMatch(truckId, { enabled: true, offset });

        // Update step totals shown in Fluid Breakdown
        if (aw) aw.textContent = `${roundGallons(awTrue + offset)} total`;
        if (at) at.textContent = `${roundGallons(atTrue + offset)} total`;
});
}

function renderBatchResults(results, wantedMix, wantedVol) {
    const resultsDiv = document.getElementById('batch-results');
    
    const successCount = results.filter(r => r.success).length;
    const totalTypeI = results.filter(r => r.success).reduce((sum, r) => sum + r.typeIToAdd, 0);
    const totalWater = results.filter(r => r.success).reduce((sum, r) => sum + r.waterToAdd, 0);
    const totalFluid = totalTypeI + totalWater;
    
    let html = `
        <div class="summary-box">
            <div class="summary-title">üìä Batch Summary</div>
            <div class="summary-stat">
                <span>Trucks Processed:</span>
                <span class="summary-stat-value">${successCount} / ${results.length}</span>
            </div>
            <div class="summary-stat">
                <span>Total Type I Needed:</span>
                <span class="summary-stat-value">${Math.round(totalTypeI)} gal</span>
            </div>
            <div class="summary-stat">
                <span>Total Water Needed:</span>
                <span class="summary-stat-value">${Math.round(totalWater)} gal</span>
            </div>
            <div class="summary-stat">
                <span>Total Fluid:</span>
                <span class="summary-stat-value">${Math.round(totalFluid)} gal</span>
            </div>
        </div>
    `;
    
    results.forEach(result => {
        if (result.success) {
            // Build pump-out section if applicable
            let pumpOutSection = '';
            if (result.pumpOutAmount && result.pumpOutAmount > 0) {
                const addType = result.pumpOutMode === 'water-only' ? 'water' : 'Type I glycol';
                const afterPumpOutVol = result.currentVolume - result.pumpOutAmount;
                pumpOutSection = `
                    <div style="background: #fef2f2; border-left: 4px solid #ef4444; padding: 10px; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-weight: 600; color: #dc2626; margin-bottom: 6px;">‚ö†Ô∏è Pump Out Required</div>
                        <div class="truck-details-row">
                            <span class="truck-details-label">Pump Out:</span>
                            <span class="truck-details-value" style="color: #dc2626;">${result.pumpOutAmount.toFixed(0)} gal</span>
                        </div>
                        <div class="truck-details-row">
                            <span class="truck-details-label">After Pump Out:</span>
                            <span class="truck-details-value">${afterPumpOutVol.toFixed(0)} gal</span>
                        </div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 6px;">
                            Then add ${addType} only
                        </div>
                    </div>
                `;
            }
            
            // Verification for water/glycol only
            let verificationNote = '';
            if (result.pumpOutMode) {
                if (result.pumpOutMode === 'water-only' && Math.round(result.typeIToAdd) === 0) {
                    verificationNote = '<div style="background: #d1fae5; color: #065f46; padding: 8px; border-radius: 6px; margin-bottom: 8px; font-size: 12px; text-align: center;">‚úì Water only needed</div>';
                } else if (result.pumpOutMode === 'glycol-only' && Math.round(result.waterToAdd) === 0) {
                    verificationNote = '<div style="background: #fed7aa; color: #92400e; padding: 8px; border-radius: 6px; margin-bottom: 8px; font-size: 12px; text-align: center;">‚úì Type I glycol only needed</div>';
                }
            }
            


// Gauge Match (Fill Station): translate "true gallons" to what the sight gauge shows on uneven pavement
const gmState = loadGaugeMatch(result.truckId);
const gmEnabled = !!gmState.enabled;
const gmOffset = Number(gmState.offset) || 0;

// If there is a pump-out step, additions happen AFTER pump-out.
const pumpOutAmt = (result.pumpOutAmount && Number(result.pumpOutAmount) > 0) ? Number(result.pumpOutAmount) : 0;

const trueCurrentVol = Math.round(result.currentVolume);
const trueBaseVol = Math.round(result.currentVolume - pumpOutAmt);
const trueTargetVol = Math.round(result.wantedVolume);

const waterAddRnd = Math.round(result.waterToAdd);
const typeIAddRnd = Math.round(result.typeIToAdd);

// Step totals (true / flat-ground math)
const afterWaterTrue = Math.round(trueBaseVol + result.waterToAdd);
const afterTypeTrue = trueTargetVol;

// Step totals as the operator should see them on the fill-station gauge (offset mode)
const afterWaterDisplay = gmEnabled ? roundGallons(afterWaterTrue + gmOffset) : afterWaterTrue;
const afterTypeDisplay  = gmEnabled ? roundGallons(afterTypeTrue + gmOffset) : afterTypeTrue;

// Prefill for "Gauge now" input when enabled
const gmPrefillNow = gmEnabled ? String(roundGallons(trueCurrentVol + gmOffset)) : '';
html += `
                <div class="truck-result" data-truckid="${result.truckId}" data-truecurrent="${trueCurrentVol}" data-truetarget="${trueTargetVol}" data-afterwatertrue="${afterWaterTrue}" data-aftertypetrue="${afterTypeTrue}">
                    <div class="truck-header">
                        <div class="truck-id">${result.truckId}</div>
                        <div class="truck-status status-success">‚úì Success</div>
                    </div>
                    ${pumpOutSection}
                    <div class="truck-details">
                        <div class="truck-details-row">
                            <span class="truck-details-label">Current:</span>
                            <span class="truck-details-value">${result.currentMix.toFixed(1)}% @ ${result.currentVolume.toFixed(0)} gal</span>
                        </div>
                        <div class="truck-details-row">
                            <span class="truck-details-label">Target:</span>
                            <span class="truck-details-value">${result.wantedMix.toFixed(1)}% @ ${Math.round(result.wantedVolume)} gal</span>
                        </div>
                        <div class="truck-details-row">
                            <span class="truck-details-label">Mix to Add:</span>
                            <span class="truck-details-value">${result.percentToAdd.toFixed(0)}%</span>
                        </div>
                        <div class="truck-details-row">
                            <span class="truck-details-label">Total to Add:</span>
                            <span class="truck-details-value">${Math.round(result.volumeToAdd)} gal</span>
                        </div>
                    </div>
                    ${verificationNote}

<div class="gauge-match-box">
    <label class="gm-toggle">
        <input type="checkbox" class="gm-enable" ${gmEnabled ? 'checked' : ''}>
        <span>Gauge Offset</span>
    </label>
    <div class="gm-body" style="${gmEnabled ? '' : 'display:none;'}">
        <div class="gm-row">
            <span class="gm-label">Gauge now (station):</span>
            <input class="gm-input gm-now" inputmode="numeric" placeholder="Enter gauge reading (gal)" value="${gmPrefillNow}">
        </div>
    </div>
</div>
                    <div class="fluid-add-box">
                        <div class="fluid-add-title">Fluid Breakdown:</div>
                        <div class="truck-details-row" style="margin-bottom: 6px;">
                            <span style="color: #3b82f6; font-weight: 600;">üíß Water:</span>
                            <span style="font-weight: 700; color: #3b82f6;">${waterAddRnd} gal</span>
                            <span class="gm-total gm-after-water" style="font-weight: 700; color: #111827;">${afterWaterDisplay} total</span>
                        </div>
                        <div class="truck-details-row">
                            <span style="color: #f97316; font-weight: 600;">üß™ Type I:</span>
                            <span style="font-weight: 700; color: #f97316;">${typeIAddRnd} gal</span>
                            <span class="gm-total gm-after-type" style="font-weight: 700; color: #111827;">${afterTypeDisplay} total</span>
                        </div>
                    </div>
                </div>
            `;
        } else {
            html += `
                <div class="truck-result">
                    <div class="truck-header">
                        <div class="truck-id">${result.truckId}</div>
                        <div class="truck-status status-error">‚úó Error</div>
                    </div>
                    <div class="error-message" style="margin: 0;">
                        ${result.error}
                    </div>
                </div>
            `;
        }
    });
    
    resultsDiv.innerHTML = html;
    // (Re)wire Gauge Match UI for the newly-rendered cards
    setupGaugeMatchDelegation();
}
        function calcInc() {
            const c=parseFloat(document.getElementById('inc-cur').value);
            const d=parseFloat(document.getElementById('inc-des').value);
            const v=parseFloat(document.getElementById('inc-vol').value);
            const resultDiv = document.getElementById('inc-result');
            
            saveInput('increase', 'inc-cur', document.getElementById('inc-cur').value);
            saveInput('increase', 'inc-des', document.getElementById('inc-des').value);
            saveInput('increase', 'inc-vol', document.getElementById('inc-vol').value);
            
            if(!c||!d||!v){resultDiv.innerHTML='';return;}
            
            const validations = [
                validateInput(c, 'Current mix', 0, 100),
                validateInput(d, 'Desired mix', 0, 100),
                validateInput(v, 'Current volume', 0.1)
            ];
            
            for (let validation of validations) {
                if (!validation.valid) {
                    resultDiv.innerHTML = `<div class="error-message">${validation.message}</div>`;
                    return;
                }
            }
            
            if (d <= c) {
                resultDiv.innerHTML = '<div class="error-message">Desired mix must be greater than current mix</div>';
                return;
            }
            
            const g=v*((d-c)/(100-d)),t=v+g;
            resultDiv.innerHTML=
                `<div style="background:#f97316;color:white;padding:12px;border-radius:8px;margin-bottom:8px;font-weight:600;text-align:center;">
                    Type I to Add: ${g.toFixed(2)} gal
                </div>
                <div class="result-item"><span>New Total Volume</span><span class="result-value">${t.toFixed(2)} gal</span></div>`;
            saveToHistory('Inc',{c,d,v,g:g.toFixed(2)});
        }

        function calcDec() {
            const c=parseFloat(document.getElementById('dec-cur').value);
            const d=parseFloat(document.getElementById('dec-des').value);
            const v=parseFloat(document.getElementById('dec-vol').value);
            const resultDiv = document.getElementById('dec-result');
            
            saveInput('decrease', 'dec-cur', document.getElementById('dec-cur').value);
            saveInput('decrease', 'dec-des', document.getElementById('dec-des').value);
            saveInput('decrease', 'dec-vol', document.getElementById('dec-vol').value);
            
            if(!c||!d||!v){resultDiv.innerHTML='';return;}
            
            const validations = [
                validateInput(c, 'Current mix', 0, 100),
                validateInput(d, 'Desired mix', 0, 100),
                validateInput(v, 'Current volume', 0.1)
            ];
            
            for (let validation of validations) {
                if (!validation.valid) {
                    resultDiv.innerHTML = `<div class="error-message">${validation.message}</div>`;
                    return;
                }
            }
            
            if (d >= c) {
                resultDiv.innerHTML = '<div class="error-message">Desired mix must be less than current mix</div>';
                return;
            }
            
            if (d === 0) {
                resultDiv.innerHTML = '<div class="error-message">Desired mix cannot be zero</div>';
                return;
            }
            
            const w=v*((c-d)/d),t=v+w;
            resultDiv.innerHTML=
                `<div style="background:#3b82f6;color:white;padding:12px;border-radius:8px;margin-bottom:8px;font-weight:600;text-align:center;">
                    Water to Add: ${w.toFixed(2)} gal
                </div>
                <div class="result-item"><span>New Total Volume</span><span class="result-value">${t.toFixed(2)} gal</span></div>`;
            saveToHistory('Dec',{c,d,v,w:w.toFixed(2)});
        }

function calcVol() {
    const curMix=parseFloat(document.getElementById('vol-cur').value);
    const curVol=parseFloat(document.getElementById('vol-curv').value);
    const wantMix=parseFloat(document.getElementById('vol-want').value);
    const wantVol=parseFloat(document.getElementById('vol-wantv').value);
    const pumpOutChecked = true; // Always use pump-out optimization when beneficial
    const resultDiv = document.getElementById('vol-result');
    
    saveInput('volume', 'vol-curv', document.getElementById('vol-curv').value);
    saveInput('volume', 'vol-wantv', document.getElementById('vol-wantv').value);
    saveInput('volume', 'vol-pumpout', pumpOutChecked);
    
    if(!curMix||!curVol||!wantMix||!wantVol){resultDiv.innerHTML='';return;}
    
    const validations = [
        validateInput(curMix, 'Current mix', 0, 100),
        validateInput(wantMix, 'Wanted mix', 0, 100),
        validateInput(curVol, 'Current volume', 0.1),
        validateInput(wantVol, 'Wanted volume', 0.1)
    ];
    
    for (let validation of validations) {
        if (!validation.valid) {
            resultDiv.innerHTML = `<div class="error-message">${validation.message}</div>`;
            return;
        }
    }
    
// NEW: Handle same percentage case (volume increase only)
if (curMix === wantMix) {
    if (wantVol <= curVol) {
        resultDiv.innerHTML = '<div class="error-message">Wanted volume must be greater than current volume</div>';
        return;
    }
    
    // Calculate volume to add while maintaining same percentage
    const volumeToAdd = wantVol - curVol;
    const typeIToAdd = volumeToAdd * (curMix / 100);
    const waterToAdd = volumeToAdd * ((100 - curMix) / 100);
    
    resultDiv.innerHTML = `
        <div style="background: #10b981; color: white; padding: 12px; border-radius: 8px; margin-bottom: 12px; font-weight: 600; text-align: center;">
            Maintaining ${curMix.toFixed(1)}% Mix
        </div>
        <div class="result-item"><span>% to Add</span><span class="result-value">${curMix.toFixed(0)}%</span></div>
        <div class="result-item"><span>Volume to Add</span><span class="result-value">${Math.round(volumeToAdd)} gal</span></div>
        <div style="margin-top:16px;">
            <div style="background:#3b82f6;color:white;padding:12px;border-radius:8px;margin-bottom:8px;font-weight:600;text-align:center;">
                Water to Add: ${Math.round(waterToAdd)} gal
            </div>
            <div style="background:#f97316;color:white;padding:12px;border-radius:8px;font-weight:600;text-align:center;">
                Type I to Add: ${Math.round(typeIToAdd)} gal
            </div>
        </div>`;
    saveToHistory('Vol',{curMix,curVol,wantMix,wantVol,vol:Math.round(volumeToAdd),pct:curMix.toFixed(0),water:Math.round(waterToAdd),typeI:Math.round(typeIToAdd),pumpOut:0});
    return;
}
    
    let pumpOutAmount = 0;
    let pumpOutMode = null;
    
    if (pumpOutChecked) {
        if (wantMix < curMix) {
            pumpOutMode = 'water-only';
        } else if (wantMix > curMix) {
            pumpOutMode = 'glycol-only';
        }
        
        if (pumpOutMode) {
            pumpOutAmount = calculateAutoPumpOut(curMix, curVol, wantMix, wantVol, pumpOutMode);
            
            // If pump-out not feasible, fall back to mixed fluid (no pump-out)
            if (pumpOutAmount === null || pumpOutAmount <= 0 || pumpOutAmount >= curVol) {
                pumpOutAmount = 0;
                pumpOutMode = null;
            }
        }
    }
            
            let effectiveCurVol = curVol;
            let pumpOutHtml = '';
            
            if (pumpOutChecked && pumpOutAmount > 0) {
                if (pumpOutAmount >= curVol) {
                    resultDiv.innerHTML = '<div class="error-message">Calculated pump-out exceeds current volume. Try without pump-out option.</div>';
                    return;
                }
                
                effectiveCurVol = curVol - pumpOutAmount;
                const addType = pumpOutMode === 'water-only' ? 'water' : 'Type I glycol';
                pumpOutHtml = `
                    <div style="background:#ef4444;color:white;padding:12px;border-radius:8px;margin-bottom:8px;font-weight:600;text-align:center;">
                        Step 1: Pump Out ${pumpOutAmount.toFixed(2)} gal
                    </div>
                    <div class="result-item"><span>Volume After Pump Out</span><span class="result-value">${effectiveCurVol.toFixed(2)} gal</span></div>
                    <div style="background: #e0f2fe; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 13px; color: #0369a1; text-align: center;">
                        ‚ÑπÔ∏è Then add ${addType} only
                    </div>
                    <div style="height: 1px; background: #e5e7eb; margin: 16px 0;"></div>`;
            }
            
            if (wantVol <= effectiveCurVol) {
                resultDiv.innerHTML = '<div class="error-message">Wanted volume must be greater than current volume' + (pumpOutChecked ? ' after pump out' : '') + '</div>';
                return;
            }
            
            const cm=curMix/100;
            const wm=wantMix/100;
            
            const d4=cm*effectiveCurVol;
            const d5=wm*wantVol;
            const d6=d5-d4;
            
            const e4=effectiveCurVol-d4;
            const e5=wantVol-d5;
            const e6=e5-e4;
            
            const percentToAdd=(d6/(d6+e6))*100;
            const volumeToAdd=d6+e6;
            const typeIToAdd=d6;
            const waterToAdd=e6;
            
            const stepLabel = pumpOutChecked ? 'Step 2: Add Fluid' : '';
            
            let verificationNote = '';
            if (pumpOutChecked) {
                if (pumpOutMode === 'water-only' && Math.round(typeIToAdd) === 0) {
                    verificationNote = '<div style="background: #d1fae5; color: #065f46; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; text-align: center;">‚úì Water only needed</div>';
                } else if (pumpOutMode === 'glycol-only' && Math.round(waterToAdd) === 0) {
                    verificationNote = '<div style="background: #fed7aa; color: #92400e; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; text-align: center;">‚úì Type I glycol only needed</div>';
                }
            }
            
            resultDiv.innerHTML=
                pumpOutHtml +
                `<div class="result-item"><span>% to Add</span><span class="result-value">${percentToAdd.toFixed(0)}%</span></div>
                <div class="result-item"><span>Volume to Add</span><span class="result-value">${Math.round(volumeToAdd)} gal</span></div>
                ${verificationNote}
                <div style="margin-top:16px;">
                    ${stepLabel ? `<div style="color: #0369a1; font-weight: 600; margin-bottom: 8px;">${stepLabel}</div>` : ''}
                    <div style="background:#3b82f6;color:white;padding:12px;border-radius:8px;margin-bottom:8px;font-weight:600;text-align:center;">
                        Water to Add: ${Math.round(waterToAdd)} gal
                    </div>
                    <div style="background:#f97316;color:white;padding:12px;border-radius:8px;font-weight:600;text-align:center;">
                        Type I to Add: ${Math.round(typeIToAdd)} gal
                    </div>
                </div>`;
            saveToHistory('Vol',{curMix,curVol,wantMix,wantVol,vol:Math.round(volumeToAdd),pct:percentToAdd.toFixed(0),water:Math.round(waterToAdd),typeI:Math.round(typeIToAdd),pumpOut:pumpOutChecked?pumpOutAmount:0});
        }

        function calculateAutoPumpOut(curMix, curVol, wantMix, wantVol, mode) {
            const cm = curMix / 100;
            const wm = wantMix / 100;
            
            if (mode === 'water-only') {
                if (wantMix >= curMix) {
                    return null;
                }
                
                const pumpOut = curVol - (wm * wantVol / cm);
                
                if (pumpOut < 0 || pumpOut >= curVol) {
                    return null;
                }
                
                return pumpOut;
                
            } else if (mode === 'glycol-only') {
                if (wantMix <= curMix) {
                    return null;
                }
                
                const numerator = (wm * wantVol - cm * curVol - wantVol + curVol) * 100;
                const denominator = 100 - curMix;
                
                if (denominator === 0) {
                    return null;
                }
                
                const pumpOut = numerator / denominator;
                
                if (pumpOut < 0 || pumpOut >= curVol) {
                    return null;
                }
                
                return pumpOut;
            }
            
            return null;
        }

        function handlePumpOutChange() {
            calcVol();
        }

        function refreshTruckBoard() {
            const iframe = document.getElementById('truckboard-iframe');
            const currentSrc = iframe.src.split('?')[0];
            iframe.src = currentSrc + '?page=display&t=' + new Date().getTime();
        }

        function updateTruckBoardTime() {
            const now = new Date();
            const options = {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            document.getElementById('truckboard-time').textContent = now.toLocaleString('en-US', options);
        }

function openTruckBoardDisplay() {
    const displayUrl = 'https://script.google.com/macros/s/AKfycbwLAeS6nUomVV8IwKqNZ76DwpRq1JFGHsG010-Z51blqkWmebGVAs8bm7B-MzlbPKkhbA/exec?page=display';
    window.open(displayUrl, 'TruckBoardDisplay', 'width=800,height=600,resizable=yes,scrollbars=yes');
}

        function freezePointToPercentage(freezeC) {
            const freezeMap = [
                {freeze: -43, pct: 70},
                {freeze: -41.5, pct: 65},
                {freeze: -40, pct: 60},
                {freeze: -39, pct: 59},
                {freeze: -39, pct: 58},
                {freeze: -38, pct: 57},
                {freeze: -37, pct: 56},
                {freeze: -36, pct: 55},
                {freeze: -34, pct: 54},
                {freeze: -32, pct: 53},
                {freeze: -31, pct: 52},
                {freeze: -29, pct: 51},
                {freeze: -27, pct: 50},
                {freeze: -26, pct: 49},
                {freeze: -25, pct: 48},
                {freeze: -24, pct: 47},
                {freeze: -23, pct: 46},
                {freeze: -22, pct: 45},
                {freeze: -21, pct: 44},
                {freeze: -21, pct: 43},
                {freeze: -19, pct: 42},
                {freeze: -19, pct: 41},
                {freeze: -18, pct: 40},
                {freeze: -17, pct: 39},
                {freeze: -16, pct: 38},
                {freeze: -15, pct: 37},
                {freeze: -14, pct: 36},
                {freeze: -13, pct: 35},
                {freeze: -13, pct: 34},
                {freeze: -13, pct: 33},
                {freeze: -12, pct: 32},
                {freeze: -12, pct: 31},
                {freeze: -11, pct: 30},
                {freeze: -11, pct: 29},
                {freeze: -11, pct: 28},
                {freeze: -11, pct: 27},
                {freeze: -10, pct: 26},
                {freeze: -10, pct: 25},
                {freeze: -9, pct: 24},
                {freeze: -8, pct: 23},
                {freeze: -8, pct: 22},
                {freeze: -7, pct: 21},
                {freeze: -7, pct: 20}
            ];
            
            let closest = freezeMap[0];
            let minDiff = Math.abs(freezeC - closest.freeze);
            
            for (let entry of freezeMap) {
                const diff = Math.abs(freezeC - entry.freeze);
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = entry;
                }
            }
            
            return closest.pct;
        }

async function loadTruckList() {
    const select = document.getElementById('truck-select');
    
    // Clear existing options except the first one
    select.innerHTML = '<option value="">-- Select a Truck --</option>';
    
    try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEETS_ID}/gviz/tq?tqx=out:csv`;
        const response = await fetch(url);
        const csvText = await response.text();
        
        const lines = csvText.trim().split('\n');
        const dataLines = lines.slice(1); // Skip header
        
        dataLines.forEach(line => {
            const values = line.replace(/"/g, '').split(',');
            if (values.length >= 1 && values[0].trim()) {
                const truckId = values[0].trim();
                const option = document.createElement('option');
                option.value = truckId;
                option.textContent = truckId;
                select.appendChild(option);
            }
        });
    } catch (error) {
        console.error('Error loading truck list:', error);
    }
}

async function loadTruckData() {
    const select = document.getElementById('truck-select');
    const selectedTruck = select.value;
    const dataDiv = document.getElementById('current-truck-data');
    
    if (!selectedTruck) {
        dataDiv.style.display = 'none';
        return;
    }
    
    try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEETS_ID}/gviz/tq?tqx=out:csv`;
        const response = await fetch(url);
        const csvText = await response.text();
        
        const lines = csvText.trim().split('\n');
        const dataLines = lines.slice(1); // Skip header
        
        // Find the truck
        for (let line of dataLines) {
            const values = line.replace(/"/g, '').split(',');
            const truckId = values[0].trim();
            
            if (truckId === selectedTruck) {
                // Parse the data
                // A=ID, B=Percent, C=Freeze Point, D=Freeze Point F, E=LOUT C, F=Type I, G=Type IV, H=Status
                // Index: 0    1         2              3               4          5         6          7
                const percent = values[1] ? values[1].trim() + '%' : 'N/A';
                const freeze = values[2] ? values[2].trim() + '¬∞C' : 'N/A';
                
                // Type I is in column F (index 5)
                let typeI = values[5] ? values[5].trim() : '0';
                
                // Type IV is in column G (index 6)
                let typeIV = values[6] ? values[6].trim() : '0';
                
                // Handle comma-formatted numbers (e.g., "1,650" becomes "1" "650")
                // If Type I value is short (like just "1"), check if next value completes it
                if (typeI.length <= 2 && values[6] && values[6].match(/^\d{3}/)) {
                    typeI = typeI + values[6].substring(0, 3);
                    // Now Type IV shifts to index 7
                    typeIV = values[7] ? values[7].trim() : '0';
                    // Check if Type IV also has comma formatting
                    if (typeIV.length <= 2 && values[8] && values[8].match(/^\d{3}/)) {
                        typeIV = typeIV + values[8].substring(0, 3);
                    }
                }
                
                // Update the display
                document.getElementById('current-truck-id').textContent = truckId;
                document.getElementById('current-percent').textContent = percent;
                document.getElementById('current-freeze').textContent = freeze;
                document.getElementById('current-typei').textContent = typeI + ' gal';
                document.getElementById('current-typeiv').textContent = typeIV + ' gal';
                
                dataDiv.style.display = 'block';
                return;
            }
        }
        
        // Truck not found
        dataDiv.style.display = 'none';
        alert('Truck data not found');
        
    } catch (error) {
        console.error('Error loading truck data:', error);
        alert('Error loading truck data. Please try again.');
    }
}

// NEW: Get truck status and comment data
async function getTruckStatusData(truckId) {
    try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEETS_ID}/gviz/tq?tqx=out:csv`;
        const response = await fetch(url);
        const csvText = await response.text();
        
        const lines = csvText.trim().split('\n');
        const header = lines[0].replace(/"/g, '').split(',');
        const dataLines = lines.slice(1);
        
        // Find column indices
        const statusColIndex = header.indexOf('Status');
        const commentColIndex = header.indexOf('Comment');
        
        // Find the truck
        for (let line of dataLines) {
            const values = line.replace(/"/g, '').split(',');
            const id = values[0].trim();
            
            if (id === truckId) {
                return {
                    status: statusColIndex !== -1 ? (values[statusColIndex] || '') : '',
                    comment: commentColIndex !== -1 ? (values[commentColIndex] || '') : ''
                };
            }
        }
        
        return null;
    } catch (error) {
        console.error('Error getting truck status data:', error);
        return null;
    }
}

// NEW: Update status with comment (calls Google Apps Script)
async function updateTruckStatusWithComment(truckId, status, comment) {
    try {
        // This calls the Google Apps Script web app
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbwLAeS6nUomVV8IwKqNZ76DwpRq1JFGHsG010-Z51blqkWmebGVAs8bm7B-MzlbPKkhbA/exec';
        
        const formData = new FormData();
        formData.append('id', truckId);
        formData.append('status', status);
        formData.append('comment', comment);
        
        const response = await fetch(scriptUrl, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.text();
        return result;
        
    } catch (error) {
        console.error('Error updating status:', error);
        throw error;
    }
}

        function handleVolCurInput() {
            saveInput('volume', 'vol-cur', document.getElementById('vol-cur').value);
            calcVol();
        }

        function handleVolCurFreezeInput() {
            const freezeInput = document.getElementById('vol-cur-freeze');
            saveInput('volume', 'vol-cur-freeze', freezeInput.value);
            
            if (freezeInput.value) {
                const freezeC = parseFloat(freezeInput.value);
                const percentage = freezePointToPercentage(freezeC);
                document.getElementById('vol-cur').value = percentage;
                saveInput('volume', 'vol-cur', percentage);
            }
            calcVol();
        }

        function handleVolWantInput() {
            saveInput('volume', 'vol-want', document.getElementById('vol-want').value);
            calcVol();
        }

        function handleVolWantFreezeInput() {
            const freezeInput = document.getElementById('vol-want-freeze');
            saveInput('volume', 'vol-want-freeze', freezeInput.value);
            
            if (freezeInput.value) {
                const freezeC = parseFloat(freezeInput.value);
                const percentage = freezePointToPercentage(freezeC);
                document.getElementById('vol-want').value = percentage;
                saveInput('volume', 'vol-want', percentage);
            }
            calcVol();
        }

        function calcTote() {
            const tm=parseFloat(document.getElementById('tote-tm').value)/100;
            const tv=parseFloat(document.getElementById('tote-tv').value);
            const ttm=parseFloat(document.getElementById('tote-ttm').value)/100;
            const ttv=parseFloat(document.getElementById('tote-ttv').value);
            const resultDiv = document.getElementById('tote-result');
            
            saveInput('tote', 'tote-tm', document.getElementById('tote-tm').value);
            saveInput('tote', 'tote-tv', document.getElementById('tote-tv').value);
            saveInput('tote', 'tote-ttm', document.getElementById('tote-ttm').value);
            saveInput('tote', 'tote-ttv', document.getElementById('tote-ttv').value);
            
            if(!tm||!tv||!ttm||!ttv){resultDiv.innerHTML='';return;}
            
            const validations = [
                validateInput(tm*100, 'Truck mix', 0, 100),
                validateInput(ttm*100, 'Tote mix', 0, 100),
                validateInput(tv, 'Truck volume', 0.1),
                validateInput(ttv, 'Tote volume', 0.1)
            ];
            
            for (let validation of validations) {
                if (!validation.valid) {
                    resultDiv.innerHTML = `<div class="error-message">${validation.message}</div>`;
                    return;
                }
            }
            
            const nm=((tv*tm)+(ttv*ttm))/(tv+ttv),t=tv+ttv;
            resultDiv.innerHTML=
                `<div class="result-item"><span>New Mix</span><span class="result-value">${(nm*100).toFixed(2)}%</span></div>
                <div class="result-item"><span>Total</span><span class="result-value">${t.toFixed(2)} gal</span></div>`;
            saveToHistory('Tote',{tm:(tm*100).toFixed(1),ttm:(ttm*100).toFixed(1),nm:(nm*100).toFixed(2)});
        }

async function loadATIS() {
            try {
                document.getElementById('temperature').textContent = 'Loading...';
                document.getElementById('dewpoint').textContent = 'Loading...';
                document.getElementById('wind').textContent = 'Loading...';
                document.getElementById('metar-full').textContent = 'Loading...';
                document.getElementById('metar-time').textContent = '--';
                document.getElementById('metar-observed').textContent = '--';
                document.getElementById('precip-box').style.display = 'none';
                
                // Load ATIS info
                const atisInfo = await getAtisInfo('KPIT');
                
                // Display ATIS letter if available
                const atisDisplay = document.getElementById('atis-letter');
                if (atisDisplay) {
                    if (atisInfo.ok && atisInfo.code) {
                        atisDisplay.textContent = atisInfo.code;
                        atisDisplay.parentElement.style.display = 'block';
                    } else {
                        atisDisplay.parentElement.style.display = 'none';
                    }
                }
                
                const station = 'KPIT';
                const metarURL = `https://aviationweather.gov/api/data/metar?ids=${station}&format=raw&taf=false&hours=0&_=${Date.now()}`;
                
                // Try multiple CORS proxies
                const proxies = [
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(metarURL)}`,
                    `https://corsproxy.io/?${encodeURIComponent(metarURL)}`,
                    `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(metarURL)}`
                ];
                
                let metarText = null;
                
// Skip direct fetch and use proxies (GitHub Pages has CORS restrictions)
                console.log('Using CORS proxy to fetch METAR data...');
                
                // Try each proxy
                for (const proxyURL of proxies) {
                    try {
                        console.log('Trying proxy:', proxyURL);
                        const proxyResponse = await fetch(proxyURL, {
                            cache: 'no-store'
                        });
                        
                        if (proxyResponse.ok) {
                            metarText = await proxyResponse.text();
                            
                            if (metarText && metarText.trim() && !metarText.includes('error') && metarText.includes('KPIT')) {
                                displayMETARData(metarText);
                                return;
                            }
                        }
                    } catch (proxyError) {
                        console.log('Proxy failed:', proxyError);
                        continue;
                    }
                }
                
                throw new Error('All METAR fetch attempts failed');
                
            } catch (error) {
                console.error('Error loading METAR:', error);
                document.getElementById('temperature').textContent = 'Unavailable';
                document.getElementById('dewpoint').textContent = 'Unavailable';
                document.getElementById('wind').textContent = 'Unavailable';
                document.getElementById('metar-full').innerHTML = `
                    <div style="color: #dc2626;">
                        Unable to load METAR data due to network restrictions.<br><br>
                        Please use the external weather links below for current conditions.
                    </div>
                `;
                document.getElementById('metar-time').textContent = '--';
                document.getElementById('metar-observed').textContent = '--';
            }
        }

        function displayMETARData(metarText) {
            document.getElementById('metar-full').textContent = metarText;
            
            const observedTime = extractMETARTime(metarText);
            document.getElementById('metar-observed').textContent = observedTime;
            
            const now = new Date();
            const options = {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            document.getElementById('metar-time').textContent = now.toLocaleTimeString('en-US', options);
            
            const weatherData = parseMETAR(metarText);
            
            if (weatherData.temp) {
                document.getElementById('temperature').textContent = weatherData.temp;
            } else {
                document.getElementById('temperature').textContent = 'N/A';
            }
            
            if (weatherData.dewpoint) {
                document.getElementById('dewpoint').textContent = weatherData.dewpoint;
            } else {
                document.getElementById('dewpoint').textContent = 'N/A';
            }
            
            if (weatherData.wind) {
    document.getElementById('wind').textContent = weatherData.wind;
    
    // Update wind compass if we have direction
    if (weatherData.windDirection !== null && weatherData.windDirection !== 'VRB' && weatherData.windDirection !== 'CALM') {
        const compass = document.getElementById('wind-compass');
        const arrow = document.getElementById('wind-arrow');
        const directionText = document.getElementById('wind-direction-text');
        
compass.style.display = 'block';

// METAR direction is where the wind is coming FROM.
// Our SVG arrow already points North by default, so rotate directly.
const arrowDirection = weatherData.windDirection;
arrow.setAttribute('transform', `rotate(${arrowDirection} 100 100)`);

directionText.textContent = weatherData.windDirection;

    } else {
        document.getElementById('wind-compass').style.display = 'none';
    }
} else {
    document.getElementById('wind').textContent = 'N/A';
    document.getElementById('wind-compass').style.display = 'none';
}
            
            const precipBox = document.getElementById('precip-box');
            if (weatherData.precipitation) {
                document.getElementById('precipitation').textContent = weatherData.precipitation;
                precipBox.style.display = 'block';
            } else {
                precipBox.style.display = 'none';
            }
        }

        /**
         * Parse METAR "T-group" temp/dew in tenths of ¬∞C.
         * Example: T00261009 => +2.6C / +0.9C
         *          T10261020 => -2.6C / -2.0C
         */
        function parseMetarTGroup(metarRaw) {
            if (!metarRaw) return null;
            
            const m = metarRaw.match(/\bT([01])(\d{3})([01])(\d{3})\b/);
            if (!m) return null;
            
            const tSign = (m[1] === '1') ? -1 : 1;
            const dSign = (m[3] === '1') ? -1 : 1;
            
            return {
                tempC: tSign * (parseInt(m[2], 10) / 10),
                dewC:  dSign * (parseInt(m[4], 10) / 10)
            };
        }

        function formatC1(val) {
            if (val === null || val === undefined || isNaN(Number(val))) return 'N/A';
            return Number(val).toFixed(1) + '¬∞C';
        }

        function formatF1(celsiusVal) {
            if (celsiusVal === null || celsiusVal === undefined || isNaN(Number(celsiusVal))) return 'N/A';
            const fahrenheit = (Number(celsiusVal) * 9/5) + 32;
            return fahrenheit.toFixed(1) + '¬∞F';
        }

        // ATIS fetch function
        async function getAtisInfo(station) {
            station = (station || "KPIT").toUpperCase().trim();
            const url = "https://atis.info/api/" + encodeURIComponent(station);
            
            try {
                const response = await fetch(url, {
                    method: "get",
                    cache: 'no-store'
                });
                
                const httpCode = response.status;
                if (httpCode !== 200) {
                    return { ok: false, station: station, error: "HTTP " + httpCode };
                }
                
                const arr = await response.json();
                
                // Pick whichever changed most recently by updatedAt
                let pick = null;
                if (Array.isArray(arr) && arr.length) {
                    pick = arr.reduce(function(best, cur) {
                        if (!cur) return best;
                        const curT = cur.updatedAt ? Date.parse(cur.updatedAt) : 0;
                        const bestT = (best && best.updatedAt) ? Date.parse(best.updatedAt) : 0;
                        return (curT > bestT) ? cur : best;
                    }, null);
                }
                
                if (!pick) {
                    return { ok: false, station: station, error: "No ATIS data returned" };
                }
                
                return {
                    ok: true,
                    station: station,
                    type: pick.type || "",       // arr/dep
                    code: pick.code || "",       // ATIS letter
                    updatedAt: pick.updatedAt || "",
                    datis: pick.datis || ""      // full text (optional)
                };
            } catch (error) {
                console.error('ATIS fetch error:', error);
                return { ok: false, station: station, error: error.message };
            }
        }

        function extractMETARTime(metar) {
            const timeMatch = metar.match(/\s(\d{2})(\d{2})(\d{2})Z/);
            
            if (timeMatch) {
                const day = timeMatch[1];
                const hour = timeMatch[2];
                const minute = timeMatch[3];
                
                const now = new Date();
                const currentMonth = now.getUTCMonth();
                const currentYear = now.getUTCFullYear();
                
                const metarDate = new Date(Date.UTC(currentYear, currentMonth, parseInt(day), parseInt(hour), parseInt(minute)));
                
                const options = {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false,
                    timeZone: 'America/New_York',
                    timeZoneName: 'short'
                };
                
                return metarDate.toLocaleString('en-US', options);
            }
            
            return 'Unknown';
        }

function parseMETAR(metar) {
            const result = { temp: null, dewpoint: null, wind: null, windDirection: null, precipitation: null };

            // First try to parse decimal T-group
            const tgrp = parseMetarTGroup(metar);
            
            if (tgrp) {
                // Use decimal values
                result.temp = `${formatC1(tgrp.tempC)} / ${formatF1(tgrp.tempC)}`;
                result.dewpoint = `${formatC1(tgrp.dewC)} / ${formatF1(tgrp.dewC)}`;
            } else {
                // Fall back to integer temp/dew
                const tempMatch = metar.match(/\s(M?\d{2})\/(M?\d{2})\s/);
                
                if (tempMatch) {
                    let temp = tempMatch[1];
                    let dewpoint = tempMatch[2];
        
        if (temp.startsWith('M')) {
            temp = '-' + temp.substring(1);
        }
        if (dewpoint.startsWith('M')) {
            dewpoint = '-' + dewpoint.substring(1);
        }
        
       const tempC = parseInt(temp);
                    const dewC = parseInt(dewpoint);
                    const tempF = Math.round((tempC * 9/5) + 32);
                    const dewF = Math.round((dewC * 9/5) + 32);
                    
                    result.temp = `${tempC}¬∞C / ${tempF}¬∞F`;
                    result.dewpoint = `${dewC}¬∞C / ${dewF}¬∞F`;
                }
            }
    
    // Parse wind
    const windMatch = metar.match(/\s(VRB|\d{3})(\d{2,3})(G(\d{2,3}))?KT/);

    if (windMatch) {
    const direction = windMatch[1];
    const speed = parseInt(windMatch[2]);
    const gust = windMatch[4] ? parseInt(windMatch[4]) : null;
    
    // Store numeric direction for compass
    if (direction !== 'VRB' && speed > 0) {
        result.windDirection = parseInt(direction);
    } else if (direction === 'VRB') {
        result.windDirection = 'VRB';
    } else {
        result.windDirection = 'CALM';
    }
    
    if (speed === 0) {
        result.wind = 'Calm';
    } else {
                    let windText = '';
                    
                    if (direction === 'VRB') {
                        windText = `Variable at ${speed} kts`;
                    } else {
                        windText = `${direction}¬∞ at ${speed} kts`;
                    }
                    
                    if (gust) {
                        windText += ` gusting ${gust} kts`;
                    }
                    
                    result.wind = windText;
                }
            }
            
            const weatherCodes = {
                'RA': 'Rain',
                'SN': 'Snow',
                'DZ': 'Drizzle',
                'FG': 'Fog',
                'BR': 'Mist',
                'HZ': 'Haze',
                'FU': 'Smoke',
                'VA': 'Volcanic Ash',
                'DU': 'Dust',
                'SA': 'Sand',
                'TS': 'Thunderstorm',
                'SH': 'Shower',
                'FZ': 'Freezing',
                'GR': 'Hail',
                'GS': 'Small Hail',
                'PL': 'Ice Pellets',
                'SG': 'Snow Grains',
                'IC': 'Ice Crystals',
                'UP': 'Unknown Precipitation',
                'SQ': 'Squalls',
                'FC': 'Funnel Cloud',
                'SS': 'Sandstorm',
                'DS': 'Duststorm'
            };
            
            const weatherMatch = metar.match(/\s([-+])?(VC|MI|PR|BC|DR|BL|SH|TS|FZ)?(DZ|RA|SN|SG|IC|PL|GR|GS|UP|BR|FG|FU|VA|DU|SA|HZ|PY|PO|SQ|FC|SS|DS)/g);
            
            if (weatherMatch) {
                const weatherPhenomena = [];
                
                weatherMatch.forEach(wx => {
                    wx = wx.trim();
                    let description = '';
                    
                    if (wx.startsWith('-')) {
                        description = 'Light ';
                        wx = wx.substring(1);
                    } else if (wx.startsWith('+')) {
                        description = 'Heavy ';
                        wx = wx.substring(1);
                    }
                    
                    let matched = false;
                    for (let code in weatherCodes) {
                        if (wx.includes(code)) {
                            description += weatherCodes[code] + ' ';
                            matched = true;
                        }
                    }
                    
                    if (matched) {
                        weatherPhenomena.push(description.trim());
                    }
                });
                
                if (weatherPhenomena.length > 0) {
                    result.precipitation = weatherPhenomena.join(', ');
                }
            }
            
            return result;
        }

        function saveToHistory(t,d) {
            const h=JSON.parse(localStorage.getItem('mixHist')||'[]');
            h.unshift({type:t,data:d,time:new Date().toISOString()});
            if(h.length>50)h.pop();
            localStorage.setItem('mixHist',JSON.stringify(h));
        }

        function displayHistory() {
            const h=JSON.parse(localStorage.getItem('mixHist')||'[]');
            const l=document.getElementById('history-list');
            if(!h.length){l.innerHTML='<p style="color:#9ca3af;padding:40px 20px;text-align:center;">No calculations yet</p>';return;}
            l.innerHTML=h.map(x=>{
                const date=new Date(x.time).toLocaleString();
                let det='';
                if(x.type==='Inc')det=`${x.data.c}% ‚Üí ${x.data.d}% | Add ${x.data.g} gal glycol`;
                else if(x.type==='Dec')det=`${x.data.c}% ‚Üí ${x.data.d}% | Add ${x.data.w} gal water`;
                else if(x.type==='Vol')det=`${x.data.curVol} ‚Üí ${x.data.wantVol} gal | Add ${x.data.vol} gal at ${x.data.pct}% (${x.data.water} gal water + ${x.data.typeI} gal Type I)`;
                else if(x.type==='Tote')det=`${x.data.tm}% + ${x.data.ttm}% = ${x.data.nm}%`;
else if(x.type==='Batch')det=`${x.data.truckId}: ${x.data.curVol} ‚Üí ${x.data.wantVol} gal | Add ${x.data.vol} gal at ${x.data.pct}% (${x.data.water} gal water + ${x.data.typeI} gal Type I)${x.data.pumpOut > 0 ? ' | Pump out ' + x.data.pumpOut + ' gal first' : ''}`;                return `<div style="padding:12px;background:#f0f9ff;border-radius:8px;margin-bottom:8px;">
                    <div style="font-weight:600;color:#0369a1;">${x.type}</div>
                    <div style="font-size:13px;color:#6b7280;">${det}</div>
                    <div style="font-size:11px;color:#9ca3af;">${date}</div></div>`;
            }).join('');
        }

        function clearHistory() {
            if(confirm('Clear all calculation history?')){localStorage.removeItem('mixHist');displayHistory();}
        }

        function loadNotes() {
            document.getElementById('notes-area').value=localStorage.getItem('fieldNotes')||'';
        }

        function saveNotes() {
            localStorage.setItem('fieldNotes',document.getElementById('notes-area').value);
            const s=document.getElementById('notes-status');
            s.textContent='Saving...';s.style.color='#0ea5e9';
            setTimeout(()=>{s.textContent='Saved ‚úì';s.style.color='#10b981';
                setTimeout(()=>s.style.color='#9ca3af',2000);},500);
        }

        const pdfLinks = [];

        function loadPdfs() {
            const list = document.getElementById('pdf-list');
            
            if(!pdfLinks.length) {
                list.innerHTML = '<div class="pdf-missing">No PDF documents available.<br>Edit the pdfLinks array in the HTML to add documents.</div>';
                return;
            }
            
            list.innerHTML = pdfLinks.map(pdf => `
                <a href="./pdfs/${pdf.filename}" target="_blank" class="pdf-link" aria-label="Open ${pdf.title}">
                    <div class="pdf-icon">üìÑ</div>
                    <div class="pdf-info">
                        <div class="pdf-title">${pdf.title}</div>
                        ${pdf.description ? `<div class="pdf-desc">${pdf.description}</div>` : ''}
                    </div>
                </a>
            `).join('');
        }


        const dilutionData=[['100%','1.4230-1.4260','DO NOT USE','DO NOT USE'],['90%/10%','1.4156-1.4186','-39¬∞C/-38¬∞F','DO NOT USE'],['80%/20%','1.4079-1.4106','-39¬∞C/-38¬∞F','DO NOT USE'],['70%/30%','1.3996-1.4026','-43¬∞C/-45¬∞F','DO NOT USE'],['65%/35%','1.3953-1.3983','-41.5¬∞C/-43¬∞F','-31¬∞C/-24¬∞F'],['60%/40%','1.3911-1.3941','-40¬∞C/-40¬∞F','-30¬∞C/-22¬∞F'],['59%/41%','1.3905-1.3910','-39¬∞C/-39¬∞F','-29¬∞C/-21¬∞F'],['58%/42%','1.3899-1.3904','-39¬∞C/-38¬∞F','-29¬∞C/-20¬∞F'],['57%/43%','1.3893-1.3898','-38¬∞C/-36¬∞F','-28¬∞C/-18¬∞F'],['56%/44%','1.3886-1.3892','-37¬∞C/-34¬∞F','-27¬∞C/-16¬∞F'],['55%/45%','1.3879-1.3885','-36¬∞C/-32¬∞F','-26¬∞C/-14¬∞F'],['54%/46%','1.3872-1.3878','-34¬∞C/-29¬∞F','-24¬∞C/-11¬∞F'],['53%/47%','1.3865-1.3871','-32¬∞C/-26¬∞F','-22¬∞C/-8¬∞F'],['52%/48%','1.3858-1.3864','-31¬∞C/-23¬∞F','-21¬∞C/-5¬∞F'],['51%/49%','1.3851-1.3857','-29¬∞C/-20¬∞F','-19¬∞C/-2¬∞F'],['50%/50%','1.3820-1.3850','-27¬∞C/-17¬∞F','-17¬∞C/+1¬∞F'],['49%/51%','1.3811-1.3819','-26¬∞C/-15¬∞F','-16¬∞C/+3¬∞F'],['48%/52%','1.3803-1.3810','-25¬∞C/-13¬∞F','-15¬∞C/+5¬∞F'],['47%/53%','1.3795-1.3802','-24¬∞C/-11¬∞F','-14¬∞C/+7¬∞F'],['46%/54%','1.3787-1.3794','-23¬∞C/-9¬∞F','-13¬∞C/+9¬∞F'],['45%/55%','1.3779-1.3786','-22¬∞C/-8¬∞F','-12¬∞C/+10¬∞F'],['44%/56%','1.3771-1.3778','-21¬∞C/-6¬∞F','-11¬∞C/+12¬∞F'],['43%/57%','1.3763-1.3770','-21¬∞C/-5¬∞F','-11¬∞C/+13¬∞F'],['42%/58%','1.3755-1.3762','-19¬∞C/-3¬∞F','-9¬∞C/+15¬∞F'],['41%/59%','1.3747-1.3754','-19¬∞C/-2¬∞F','-9¬∞C/+16¬∞F'],['40%/60%','1.3716-1.3746','-18¬∞C/0¬∞F','-8¬∞C/+18¬∞F'],['39%/61%','1.3707-1.3715','-17¬∞C/+2¬∞F','-7¬∞C/+20¬∞F'],['38%/62%','1.3699-1.3706','-16¬∞C/+3¬∞F','-6¬∞C/+21¬∞F'],['37%/63%','1.3691-1.3698','-15¬∞C/+5¬∞F','-5¬∞C/+23¬∞F'],['36%/64%','1.3682-1.3690','-14¬∞C/+6¬∞F','-4¬∞C/+24¬∞F'],['35%/65%','1.3673-1.3681','-13¬∞C/+7¬∞F','-3¬∞C/+25¬∞F'],['34%/66%','1.3664-1.3672','-13¬∞C/+8¬∞F','-3¬∞C/+26¬∞F'],['33%/67%','1.3655-1.3663','-13¬∞C/+9¬∞F','-3¬∞C/+27¬∞F'],['32%/68%','1.3646-1.3654','-12¬∞C/+10¬∞F','-2¬∞C/+28¬∞F'],['31%/69%','1.3637-1.3645','-12¬∞C/+11¬∞F','-2¬∞C/+29¬∞F'],['30%/70%','1.3606-1.3636','-11¬∞C/+12¬∞F','-1¬∞C/+30¬∞F'],['29%/71%','1.3600-1.3605','-11¬∞C/+12¬∞F','-1¬∞C/+30¬∞F'],['28%/72%','1.3593-1.3599','-11¬∞C/+13¬∞F','-1¬∞C/+31¬∞F'],['27%/73%','1.3587-1.3592','-11¬∞C/+13¬∞F','-1¬∞C/+31¬∞F'],['26%/74%','1.3580-1.3586','-10¬∞C/+14¬∞F','0¬∞C/+32¬∞F'],['25%/75%','1.3573-1.3579','-10¬∞C/+14¬∞F','0¬∞C/+32¬∞F'],['24%/76%','1.3565-1.3573','-9¬∞C/+15¬∞F','+1¬∞C/+33¬∞F'],['23%/77%','1.3557-1.3565','-8¬∞C/+18¬∞F','+2¬∞C/+36¬∞F'],['22%/78%','1.3549-1.3557','-8¬∞C/+18¬∞F','+2¬∞C/+36¬∞F'],['21%/79%','1.3541-1.3549','-7¬∞C/+19¬∞F','+3¬∞C/+37¬∞F'],['20%/80%','1.3511-1.3541','-7¬∞C/+19¬∞F','+3¬∞C/+37¬∞F']];

        const aircraftData=[
            ['Alaska','OK','OK','(W&T) No Type IV on the Vertical Tail','N/A'],
            ['Allegiant','OK','OK','(W&T)','N/A'],
            ['American (AA) "Mainline"','OK','OK','(W&T) if (F) requested Mainline from the engines back','N/A'],
            ['American (AA) "Regionals"','OK','OK','(WTF) ERJ 140/145, E175 (F) if requested from the main cabin door, all others (W&T)','Hand Tactile E140/145 & CRJ200 - (No Forced Air on E140/E145)'],
            ['Air Canada (Jazz)','OK','OK','Advise Start Time of Final Application. No Type IV on the Fuselage','(No use of fluid/air mixture when defrosting or deicing)'],
            ['Delta (DL) "Mainline"','OK','OK','(W&T) only No Type IV on Vertical Tail - Ask Capt if WiFi Antenna is OFF or MUTED.','DL - Ladder Tactile (Plus 10\' Hand) on B717 if requested. Engine Inlets @ Gates on Rear Mounted Engines'],
            ['Delta (DL) Connex','OK','OK','E 145 (WTF), All others see DL/DC Reference Chart - Advise ALL to "Configure flaps prior to Type IV"','DC - Hand Tactile E140/145 & CRJ200 (No Forced Air on E140/145) - Engine Inlets @ Gates on Rear Mounted Engines'],
            ['Delta Endeavor Air (9E) CRJ 700/900','OK','OK','W&T','Forced Air and Fluid Injection Allowed'],
            ['SkyWest (OO) CRJ 200/700/900','OK','OK','ALL CRJ/ERJ = W&T (Overnight Type IV not allowed on any Skywest Aircraft)','Forced Air and Fluid Injection Allowed'],
            ['Republic (YX) ERJ 170/175','OK','OK','ERJ 170/175 = W&T','ERJ 170/175 No Forced Air or Fluid Injection during ERD'],
            ['FedEx (FX)','N/A','OK','(W&T) Unless MD11 (F) from trailing edge of Wings back','Engine Inlet Prep at Cargo Ramp'],
            ['JetBlue (B6)','NO','OK','(W&T) Only','8\' Nozzle Distance'],
            ['Southwest (WN)','NO','OK','(W&T) No Type IV on the winglets or Vertical, if (F) requsrted from behind the main cabin door','N/A'],
            ['Spirit (NK)','NO (MX Only)','OK','(W&T) if (F) requested from the main cabin door back - Ask crew if WiFi is OFF','N/A'],
            ['SunCountry','OK','OK','(W&T) No Type IV if not necessary on the Vertical Tail','Flight Crew can request Type IV on the Vertical Tail'],
            ['United (UAL)','OK','OK','(W&T) No Type IV on Winglets or Vertical','Crew can request Type IV on Fuselage'],
            ['United (UAL) Connex','OK','OK','(W&T) Type IV on Fuselage of E-145','Full Body Type I required on ALL Aircraft. Tactile check required on E-145'],
            ['UPS (5X)','N/A','OK','(W&T) if (F) requested form behind the main cabin door back. (Type IV is required on the fuselage of the MD-11) No Type IV on the Vertical Tail.','UPS Requires Brix and Dew Point (Farenheit) on Deice Logs. Engine Inlet Prep at Cargo Ramp. (No use of Fluid/Air Mixtures when Defrosting or Deicing)'],
            ['MAC','N/A','OK','(WTF)','Deice Engines Off - Gather Gallons Total for Post Readback']
        ];

        const airlinesData=[['Alaska','Alaska Airlines','Alaska','AS'],['Allegiant','Allegiant','Allegiant','G4'],['American','American','American','AA'],['Air Wisconsin','American','Wisconsin','ZW-AA'],['PSA Airlines','American','Blue Streak','OH-AA'],['Republic','American','Brickyard','YX-AA'],['Skywest','American','Skywest','OO-AA'],['Envoy','American','Envoy','MQ-AA'],['Piedmont','American','Piedmont','PT-AA'],['Delta','Delta','Delta','DL'],['Endeavor Air','Delta','Endeavor','9E-DL'],['Skywest','Delta','Skywest','OO-DL'],['Republic','Delta','Brickyard','YX-DL'],['United','United','United','UA'],['Republic','United','Brickyard','YX-UA'],['Mesa','United','Air Shuttle','YV-UA'],['Go-Jet','United','Lindbergh','G7-UA'],['Skywest','United','Skywest','OO-UA'],['CommuteAir','United','CommuteAir','C5-UA'],['Southern Airways','Southern Airways','Friendly','9X'],['JetBlue','JetBlue','JetBlue','B6'],['Southwest','Southwest','Southwest','WN'],['Spirit Airlines','Spirit Airlines','Spirit Wings','NK'],['Breeze Airways','Breeze Airways','Moxy','MX'],['British Airways','British Airways','Speedbird','BA'],['Air Canada','Air Canada','Air Canada','AC'],['Air Canada Express','Air Canada','Jazz','QK'],['Icelandair','Icelandair','Iceair','FI'],['FedEx','FedEx','FedEx','FX'],['Mountain Air Cargo','Mountain Air Cargo','Mountain','C2'],['UPS','UPS','UPS','5X'],['Atlas Air','Atlas Air','Giant','5Y'],['Kalitta Air','Kalitta Air','Connie','K4'],['ATI','ATI Transport Intl','Air Transport','8C'],['Amazon Air','Sun Country','Sun Country','SY'],['US Air Force','US Air Force','Various','USAF'],['PAN-G','PAN-G','Various','PaNG']];

        function loadDilution(){const t=document.getElementById('dilution-body');if(t.innerHTML)return;t.innerHTML=dilutionData.map(r=>`<tr>${r.map((c,i)=>`<td style="background:${i===0?'#f9fafb':'white'};${c.includes('DO NOT USE')?'color:#dc2626;font-weight:600;':''}">${c}</td>`).join('')}</tr>`).join('');}

        function loadAircraft(){const t=document.getElementById('aircraft-body');if(t.innerHTML)return;t.innerHTML=aircraftData.map(r=>`<tr>${r.map((c,i)=>`<td style="background:${i===0?'#f9fafb':'white'};font-size:10px;line-height:1.3;">${c}</td>`).join('')}</tr>`).join('');}

        function loadAirlines(){const t=document.getElementById('airlines-body');if(t.innerHTML)return;t.innerHTML=airlinesData.map(r=>`<tr>${r.map((c,i)=>`<td style="background:${i===0?'#f9fafb':'white'};">${c}</td>`).join('')}</tr>`).join('');}

        if('serviceWorker' in navigator){
            window.addEventListener('load',()=>{
                navigator.serviceWorker.register('./service-worker.js')
                .then(reg=>{
                    console.log('Service Worker registered successfully');
                    reg.update();
                })
                .catch(e=>console.log('SW registration failed:',e));
            });
        }

        function updateApp(){
            if('serviceWorker' in navigator){
                navigator.serviceWorker.getRegistration().then(reg=>{
                    if(reg&&reg.waiting){
                        reg.waiting.postMessage({type:'SKIP_WAITING'});
                    }
                    caches.keys().then(names=>{
                        names.forEach(name=>caches.delete(name));
                    }).then(()=>window.location.reload(true));
                });
            }else{
                window.location.reload(true);
            }
        }


        let draggedElement = null;
        let menuOrder = [];
        let isDragging = false;

        function initDragAndDrop() {
            initMenuLock();
            const menuGrid = document.getElementById('menu-grid');
            const cards = menuGrid.querySelectorAll('.menu-card');
            
            const savedOrder = localStorage.getItem('menuOrder');
            if (savedOrder) {
                menuOrder = JSON.parse(savedOrder);
                reorderMenuCards();
            } else {
                cards.forEach(card => {
                    menuOrder.push(card.dataset.menuId);
                });
            }
            
            cards.forEach(card => {
                card.removeAttribute('onclick');
                
                card.addEventListener('click', function(e) {
                    if (!isDragging) {
                        const pageId = this.dataset.menuId;
                        showPage(pageId);
                    }
                    isDragging = false;
                });
                
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragenter', handleDragEnter);
                card.addEventListener('dragleave', handleDragLeave);
                
                card.addEventListener('touchstart', handleTouchStart, {passive: false});
                card.addEventListener('touchmove', handleTouchMove, {passive: false});
                card.addEventListener('touchend', handleTouchEnd, {passive: false});
            });
        }

        let touchStartX = 0;
        let touchStartY = 0;
        let touchMoved = false;
        let touchStartTime = 0;

function handleTouchStart(e) {
    if (menuLocked) return; // Don't start drag if locked
    const touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            touchMoved = false;
            touchStartTime = Date.now();
            draggedElement = this;
        }

function handleTouchMove(e) {
    if (menuLocked || !draggedElement) return; // Don't allow drag if locked
            
            const touch = e.touches[0];
            const deltaX = Math.abs(touch.clientX - touchStartX);
            const deltaY = Math.abs(touch.clientY - touchStartY);
            
            if (deltaX > 10 || deltaY > 10) {
                touchMoved = true;
                isDragging = true;
                e.preventDefault();
                
                draggedElement.classList.add('dragging');
                
                const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                const cardBelow = elementBelow ? elementBelow.closest('.menu-card') : null;
                
                document.querySelectorAll('.menu-card').forEach(card => {
                    card.classList.remove('drag-over');
                });
                
                if (cardBelow && cardBelow !== draggedElement) {
                    cardBelow.classList.add('drag-over');
                }
            }
        }

        function handleTouchEnd(e) {
            if (!draggedElement) return;
            
            const touch = e.changedTouches[0];
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            const cardBelow = elementBelow ? elementBelow.closest('.menu-card') : null;
            
            draggedElement.classList.remove('dragging');
            
            document.querySelectorAll('.menu-card').forEach(card => {
                card.classList.remove('drag-over');
            });
            
            if (touchMoved && cardBelow && cardBelow !== draggedElement) {
                const menuGrid = document.getElementById('menu-grid');
                const allCards = Array.from(menuGrid.querySelectorAll('.menu-card'));
                const draggedIndex = allCards.indexOf(draggedElement);
                const droppedIndex = allCards.indexOf(cardBelow);
                
                if (draggedIndex < droppedIndex) {
                    cardBelow.parentNode.insertBefore(draggedElement, cardBelow.nextSibling);
                } else {
                    cardBelow.parentNode.insertBefore(draggedElement, cardBelow);
                }
                
                const draggedId = draggedElement.dataset.menuId;
                menuOrder = menuOrder.filter(id => id !== draggedId);
                const newIndex = Array.from(menuGrid.querySelectorAll('.menu-card'))
                    .findIndex(card => card === draggedElement);
                menuOrder.splice(newIndex, 0, draggedId);
                
                localStorage.setItem('menuOrder', JSON.stringify(menuOrder));
                
                setTimeout(() => {
                    isDragging = false;
                    touchMoved = false;
                }, 300);
            } else {
                setTimeout(() => {
                    isDragging = false;
                    touchMoved = false;
                }, 50);
            }
            
            draggedElement = null;
        }

function handleDragStart(e) {
    if (menuLocked) return; // Don't start drag if locked
    draggedElement = this;
    isDragging = true;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            
            setTimeout(() => {
                isDragging = false;
            }, 50);
            
            document.querySelectorAll('.menu-card').forEach(card => {
                card.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedElement !== this) {
                const menuGrid = document.getElementById('menu-grid');
                const allCards = Array.from(menuGrid.querySelectorAll('.menu-card'));
                const draggedIndex = allCards.indexOf(draggedElement);
                const droppedIndex = allCards.indexOf(this);
                
                if (draggedIndex < droppedIndex) {
                    this.parentNode.insertBefore(draggedElement, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedElement, this);
                }
                
                const draggedId = draggedElement.dataset.menuId;
                menuOrder = menuOrder.filter(id => id !== draggedId);
                const newIndex = Array.from(menuGrid.querySelectorAll('.menu-card'))
                    .findIndex(card => card === draggedElement);
                menuOrder.splice(newIndex, 0, draggedId);
                
                localStorage.setItem('menuOrder', JSON.stringify(menuOrder));
            }
            
            return false;
        }

        function reorderMenuCards() {
            const menuGrid = document.getElementById('menu-grid');
            const cards = Array.from(menuGrid.querySelectorAll('.menu-card'));
            
            const cardMap = {};
            cards.forEach(card => {
                cardMap[card.dataset.menuId] = card;
            });
            
            cards.forEach(card => card.remove());
            
            menuOrder.forEach(menuId => {
                if (cardMap[menuId]) {
                    menuGrid.appendChild(cardMap[menuId]);
                }
            });
        }
        // Menu lock functionality
        let menuLocked = true; // Start locked by default
        
        function toggleMenuLock() {
            menuLocked = !menuLocked;
            const lockBtn = document.getElementById('lock-btn');
            const cards = document.querySelectorAll('.menu-card');
            
            if (menuLocked) {
                // Lock menu
                lockBtn.textContent = 'üîí';
                lockBtn.classList.add('locked');
                lockBtn.setAttribute('aria-label', 'Menu locked - Click to unlock');
                
                // Disable dragging
                cards.forEach(card => {
                    card.setAttribute('draggable', 'false');
                    card.style.cursor = 'pointer';
                });
            } else {
                // Unlock menu
                lockBtn.textContent = 'üîì';
                lockBtn.classList.remove('locked');
                lockBtn.setAttribute('aria-label', 'Menu unlocked - Click to lock');
                
                // Enable dragging
                cards.forEach(card => {
                    card.setAttribute('draggable', 'true');
                    card.style.cursor = 'grab';
                });
            }
            
            // Save lock state
            localStorage.setItem('menuLocked', menuLocked);
        }
        
        // Initialize lock state on page load
        function initMenuLock() {
            const savedLockState = localStorage.getItem('menuLocked');
            if (savedLockState !== null) {
                menuLocked = savedLockState === 'true';
            }
            
            // Apply the lock state
            if (!menuLocked) {
                toggleMenuLock(); // This will set it to unlocked
            } else {
                // Just update the button appearance for locked state
                const lockBtn = document.getElementById('lock-btn');
                lockBtn.textContent = 'üîí';
                lockBtn.classList.add('locked');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
    initDragAndDrop();  // ‚Üê ADD THIS LINE!
    
    document.querySelectorAll('.menu-card').forEach(card => {
        card.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });
    });
    
    // *** NEW: Add auto-save batch input listeners ***
    if (document.getElementById('batch-input')) {
        document.getElementById('batch-input').addEventListener('input', saveBatchInputs);
        document.getElementById('batch-want-pct').addEventListener('input', saveBatchInputs);
        document.getElementById('batch-want-freeze').addEventListener('input', saveBatchInputs);
        document.getElementById('batch-want-vol').addEventListener('input', saveBatchInputs);
    // New from the top
        document.getElementById('batch-use-topoff').addEventListener('change', saveBatchInputs);
        document.getElementById('batch-gallons-from-top').addEventListener('input', saveBatchInputs);
        
    }
});
// Restore last visited page IMMEDIATELY (before page fully loads)

// Restore last visited page IMMEDIATELY (before page fully loads)
(function() {
    const lastPage = localStorage.getItem('currentPage');
    if (lastPage && document.getElementById(lastPage)) {
        // Remove active from menu
        document.getElementById('menu').classList.remove('active');
        // Add active to last page
        document.getElementById(lastPage).classList.add('active');
    }
})();  // ‚Üê ADD THIS LINE!

// Then do full restoration after load (for any page-specific loading functions)
window.addEventListener('DOMContentLoaded', function() {    const lastPage = localStorage.getItem('currentPage');
    if (lastPage) {
        // Call page-specific load functions
        if(lastPage==='notes')loadNotes();
        if(lastPage==='history')displayHistory();
        if(lastPage==='dilution')loadDilution();
        if(lastPage==='aircraft')loadAircraft();
        if(lastPage==='airlines')loadAirlines();
        if(lastPage==='pdfs')loadPdfs();
        if(lastPage==='atis')loadATIS();
        if(lastPage==='truckboard-edit')loadTruckList();
        restorePageInputs(lastPage);
    }
});
   
    </script>
</body>
</html>
